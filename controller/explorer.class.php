<?php class explorer extends Controller{public $path;public $user;public function __construct(){parent::__construct();$this->tpl=TEMPLATE.'explorer/';$this->user=$_SESSION['kod_user'];±£ì¨˜ÜÆĞğ¨ôªôĞÜ§Æ¨â¾ä¦Ÿ‘Ô;if(isset($this->in['path'])){$this->path=_DIR($this->in['path']);$this->check_system_path();}}public function index(){$Æ='';if(isset($this->in['path'])&& $this->in['path']!=''){$Æ=_DIR_CLEAR($_GET['path']);$Æ=rtrim($Æ,'/').'/';}$this->assign('dir',$Æ);if($this->config['forceWap']){$this->display('index_wap.php');}else{$this->display('index.php');}}private function check_system_path(){if(!in_array(ACT,array('mkfile','mkdir','search','pathCuteDrag','pathCopyDrag','pathPast','fileDownload'))){return;}if($GLOBALS['path_type']==KOD_USER_SHARE&& !strstr(trim($this->in['path'],'/'),'/')){show_json($this->L['error'],!1);}if(in_array($GLOBALS['path_type'],array(KOD_USER_FAV,KOD_GROUP_ROOT_ALL,KOD_GROUP_ROOT_SELF))){show_json($this->L['system_path_not_change'],!1);}}public function pathInfo(){$êï=json_decode($this->in['list'],!0);Áõ¾éëèŞ¼ö¼ä½äÇ¿£¬æÃ¾»Ø;if(!$êï){show_json($this->L['error'],!1);}foreach($êï as &$Û){$Û['path']=_DIR($Û['path']);}$ğè=path_info_muti($êï,$this->L['time_type_info']);if(!$ğè){show_json($this->L['not_exists'],!1);}if(count($êï)==0x001&& $êï[0]['type']!='folder'){if($GLOBALS['is_root']|| $GLOBALS['auth']['explorer:fileDownload']==0x001){$ğè['download_path']=_make_file_proxy($êï[0]['path']);}$ë=$êï[0]['path'];$ğè['file_md5']=@md5_file($ë);$­…œ—=get_path_ext($ë);®ı³“¼™Ûû¼‰âÈŸ;if(in_array($­…œ—,array('jpg','gif','png','jpeg','bmp'))){load_class('imageThumb');$ÎúùÀ=imageThumb::imageSize($ë);if($ÎúùÀ){$ğè['image_size']=$ÎúùÀ;}}}$ğè['path']=_DIR_OUT($ğè['path']);óèÙù†ñ;show_json($ğè);šŠ®Ç·ŠÃô“§õÛÆÏ«;}public function pathChmod(){$Êë§=json_decode($this->in['list'],!0);¿ò–Åä‚Ñ;if(!$Êë§){show_json($this->L['error'],!1);}$ÜíË=octdec('0'.$this->in['mod']);$¥Õ=0;‘Æ×áñš­ŞÁƒ÷İÂêô‰ÏöÛŸ”¸à;$³·ÇÏ=0;foreach($Êë§ as $àè°Ã){$Êğº=_DIR($àè°Ã['path']);¸àÁíØíÖœÎµĞ†ı¡¨Öƒ‘ˆÆìÒ¸¨ß®ÚÌæø­©ç†Çõ;if(chmod_path($Êğº,$ÜíË)){$¥Õ++;}else{$³·ÇÏ++;}}$Ÿ“ÃÔä=$³·ÇÏ==0?!0:!1;ñ«‰„;$Ğğ‡=$¥Õ.' success,'.$³·ÇÏ.' error';if(count($Êë§)==0x001&& $³·ÇÏ==0){$Ğğ‡=$this->L['success'];}show_json($Ğğ‡,$Ÿ“ÃÔä);}public function mkfile(){$ç·=BASIC_PATH.'static/others/newfile-tpl/';íáÈÕè‘Ìİ°ß¡†;space_size_use_check();Ìİ…Õá¹§ÓÀ°ì¨èáÜ‰Ğ¿Ò¦¨ãó†”Ó¨šš”ôæñú½Ô´ä¨ô––€øû‰É»Ûğä¿äëÔ¹”ïÓ¨;$»›àø='skip';™‹ô°©ô©¦şóáÚäÇ›É³ï„;if(isset($this->in['repeat_type'])){$»›àø=$this->in['repeat_type'];}$ß×ñ=rtrim($this->path,'/');$ß×ñ=get_filename_auto($ß×ñ,'',$»›àø);¦ş;if(@touch($ß×ñ)){chmod_path($ß×ñ,0777);if(isset($this->in['content'])){file_put_contents($ß×ñ,$this->in['content']);}else{$ì˜Ç=get_path_ext($ß×ñ);$Éñ×ò=$ç·.'newfile.'.$ì˜Ç;if(file_exists($Éñ×ò)){$Ö=file_get_contents($Éñ×ò);file_put_contents($ß×ñ,$Ö);}}space_size_use_change($ß×ñ);ÌÂÍ–ö¾›¿ò±äˆ¿Œ•¾È‚×‘ä¡„½••û˜ÇÈÛ–ßÒÔú“;show_json($this->L['create_success'],!0,_DIR_OUT(iconv_app($ß×ñ)));Øö…äÃ®œÀõ¾Ä´ÓáÉÏú’™Ö¨ùªıõ¾ñåƒËİ‰±êÍßûé ò¨å§üÇñÍ;}else{show_json($this->L['create_error'],!1);›®áÅ¬×„Ÿ½ˆê;}}public function mkdir(){space_size_use_check();$œ='skip';if(isset($this->in['repeat_type'])){$œ=$this->in['repeat_type'];}$ü„Ê=rtrim($this->path,'/');$ü„Ê=get_filename_auto($ü„Ê,'',$œ); ğÌ’;if(mk_dir($ü„Ê,0777)){chmod_path($ü„Ê,0777);show_json($this->L['create_success'],!0,_DIR_OUT(iconv_app($ü„Ê)));}else{show_json($this->L['create_error'],!1);}}public function pathRname(){$‘˜¦=_DIR($this->in['rname_to']);if(file_exist_case($‘˜¦)){show_json($this->L['name_isexists'],!1);}if(@rename($this->path,$‘˜¦)){show_json($this->L['rname_success'],!0,_DIR_OUT(iconv_app($‘˜¦)));}else{show_json($this->L['no_permission_write_all'],!1);}}public function search(){if(!isset($this->in['search']))show_json($this->L['please_inpute_search_words'],!1);$ˆòó=intval($this->in['is_content']);Ÿı»“šÃò˜È½¶À±»;$£‰óá=intval($this->in['is_case']);$ˆ=trim($this->in['ext']);¹Æò±Ú’²ØÎÅ;if($GLOBALS['path_type']==KOD_USER_SHARE&& strstr($this->path,KOD_USER_SHARE)){show_json($this->L['path_cannot_search'],!1);}$’¹ŒÛ÷=path_search($this->path,iconv_system(rawurldecode($this->in['search'])),$ˆòó,$ˆ,$£‰óá);show_json(_DIR_OUT($’¹ŒÛ÷));şıÍ‰ò¯£ş¸é;}public function pathList(){$Ê¤š½=$this->in['path'];‰ÎŸÏÂ²ŠÏ‚”¬­”«ú«Àä«ñ¯ÏŒí¦‚¾°ÑŞ•’Œä¡ùÎ»ù·«˜âë·Ç—©÷ç¶å;if($Ê¤š½=="")$Ê¤š½='/';$¹=$this->path($this->path);if($this->path== MYHOME|| $this->path==HOME){$this->_self_root_load($¹['folderlist']);}if($¹['info']['path_type']==KOD_GROUP_PATH&& !strstr(trim(_DIR_CLEAR($this->in['path']),'/'),'/')){$this->_self_group_load($¹['folderlist']);}$¹['user_space']=$this->user['config'];show_json($¹);Á;}public function treeList(){$—Í=$this->in['app'];if(isset($this->in['type'])&& $this->in['type']=='init'){$this->_tree_init($—Í);}switch(trim(rawurldecode($this->in['path']))){case KOD_USER_FAV:show_json($this->_tree_fav(),!0);break;case KOD_GROUP_ROOT_SELF:show_json($this->_group_self(),!0);break;case KOD_GROUP_ROOT_ALL:show_json($this->_group_tree('1'),!0);break;default:break;}if((isset($this->in['tree_icon'])&& $this->in['tree_icon']!='groupPublic')&& !strstr(trim(rawurldecode($this->in['path']),'/'),'/')&&($GLOBALS['path_type']==KOD_GROUP_PATH|| $GLOBALS['path_type']==KOD_GROUP_SHARE)){$Ü€ˆ=$this->_group_tree($GLOBALS['path_id']);show_json($Ü€ˆ,!0);return;}$=_DIR($this->in['path']);if(!is_readable($))show_json($this->L['no_permission_read'],!1);$Ğ=($—Í=='editor'?!0:!1);$Ü€ˆ=$this->path($,$Ğ,!0);function sort_by_key($¦Òû,$ûó§){if($¦Òû['name']==$ûó§['name'])return 0;return($¦Òû['name']>$ûó§['name'])?0x001:-0x001;}usort($Ü€ˆ['folderlist'],"sort_by_key");usort($Ü€ˆ['filelist'],"sort_by_key");€õ÷„¸˜œ†Õâİû­àÍçû‚ÏıÎÌòõ€Í¬ìÍ£äÒÛıîâœÅ;if($==MYHOME|| $==HOME){}if($—Í=='editor'){$»¤Ã=array_merge($Ü€ˆ['folderlist'],$Ü€ˆ['filelist']);show_json($»¤Ã,!0);}else{show_json($Ü€ˆ['folderlist'],!0);}}private function _self_group_load(&$…‘Ñ‚“){foreach($…‘Ñ‚“ as $Ò’°Ÿ=>$¦){if($¦['name']=='share'){$…‘Ñ‚“[$Ò’°Ÿ]=array('name' =>$this->L['group_share'],'menuType' =>"menufolder folderBox",'ext' =>"folder_share",'isParent' =>!0,'is_readable' =>!0,'is_writeable' =>!0,'path' =>KOD_GROUP_PATH.':'.$GLOBALS['path_id'].'/share/','type' =>'folder','open' =>!1,'isParent' =>!1);break;}}$…‘Ñ‚“=array_values($…‘Ñ‚“);}private function _self_root_load(&$ÓŒ¡÷){foreach($ÓŒ¡÷ as $óÓïã·=>$©){if($©['name']=='share'){$ÓŒ¡÷[$óÓïã·]=array('name' =>$this->L['my_share'],'menuType' =>"menuTreeUser",'ext' =>"folder_share",'isParent' =>!0,'is_readable' =>!0,'is_writeable' =>!0,'path' =>KOD_USER_SHARE.':'.$this->user["user_id"].'/','type' =>'folder','open' =>!1,'isParent' =>!1);break;}}$ÓŒ¡÷=array_values($ÓŒ¡÷);Á²ÓÓ…Õçæ¨ù—È€¾çÔ’ôöŠæëŞÖÏ–ãø•­ÇÖà›«åñ“;if($this->config['user']['recycle_open']=="1"){}}private function _tree_fav(){$›äã=($this->in['app']=='editor'?!0:!1);$Ëã=new fileCache(USER.'data/fav.php');$ÚÀ¨=$Ëã->get();–¶ãË‘Ø£ñóÎ×æá¥‚ï‹åş®²âäó¾¥œ…Åœœ;$€­È‘†=array();»Üâ‚äË¼ş;$GLOBALS['path_from_auth_check']=!0;±Ç·«ÔŠ¬‚Ò½‰¿Á…ûç›¡Ì«¯™ºì˜®‹;foreach($ÚÀ¨ as $Ö›˜ä=>$ìîó){$Â²ø‚ô=path_haschildren(_DIR($ìîó['path']),$›äã);åšµ³ÅåÍÒå¯áñ¹;if(!isset($ìîó['type'])){$ìîó['type']='folder';}if(in_array($ìîó['type'],array('group'))){$Â²ø‚ô=!0;}$Ö=array('name' =>$ìîó['name'],'ext' =>$ìîó['ext'],'menuType' =>"menuTreeFav",'path' =>$ìîó['path'],'type' =>$ìîó['type'],'open' =>!1,'isParent' =>$Â²ø‚ô);if(isset($ìîó['type'])&& $ìîó['type']!='folder'){$Ö['ext']=$ìîó['type'];}$€­È‘†[]=$Ö;}$GLOBALS['path_from_auth_check']=!1;return $€­È‘†;}private function _tree_init($…Ğı){if($…Ğı=='editor' && isset($this->in['project'])){$ÓòıÓ‡=$this->path(_DIR($this->in['project']),!0,!0);$î½˜µ=array_merge($ÓòıÓ‡['folderlist'],$ÓòıÓ‡['filelist']);$å¶=array(array('name'=> get_path_this($this->in['project']),'children' =>$î½˜µ,'menuType' =>"menuTreeRoot",'ext' =>"folder",'path' =>$this->in['project'],'type' =>'folder','open' =>!0,'isParent' =>count($î½˜µ)>0?!0:!1));show_json($å¶);return;}$ÌæØ¿ö=($…Ğı=='editor'?!0:!1);$Í=$this->_tree_fav($…Ğı);$¤¶=KOD_GROUP_PATH.':1/';’í»æá¹»èª¦·ßÊ—Áêı›«õ®ø–áÌ£‰µıÅßşÙÉ„ğÕ;if(system_member::user_auth_group(0x001)==!1){$¤¶=KOD_GROUP_SHARE.':1/';}$»óüü=$this->path(_DIR($¤¶),$ÌæØ¿ö,!0);$ú™‹ñ=$this->path(_DIR(MYHOME),$ÌæØ¿ö,!0);ª;if($ÌæØ¿ö){$ÕÍ=array_merge($ú™‹ñ['folderlist'],$ú™‹ñ['filelist']);$ßƒ±=array_merge($»óüü['folderlist'],$»óüü['filelist']);}else{$ÕÍ=$ú™‹ñ['folderlist'];$ßƒ±=$»óüü['folderlist'];}$¡’=count($ÕÍ)>0?!0:!1;$úÛ=count($ßƒ±)>0?!0:!1;šå‰â‡í;$å¶=array('webroot'=>array(),'fav'=>array('name' =>$this->L['fav'],'ext' =>"treeFav",'menuType' =>"menuTreeFavRoot",'children' =>$Í,'path' =>KOD_USER_FAV,'type' =>'folder','open' =>!0,'isParent' =>count($Í)>0?!0:!1),'my_home'=>array('name' =>$this->L['root_path'],'menuType' =>"menuTreeRoot",'ext' =>"treeSelf",'children' =>$ÕÍ,'path' =>MYHOME,'type' =>'folder','open' =>!0,'isParent' =>$¡’),'public'=>array('name' =>$this->L['public_path'],'menuType' =>"menuTreeGroupRoot",'ext' =>"groupPublic",'children' =>$ßƒ±,'path' =>$¤¶,'type' =>'folder','open' =>!0,'isParent' =>$úÛ),'my_group'=>array('name' =>$this->L['my_kod_group'],'menuType' =>"menuTreeGroupRoot",'ext' =>"groupSelfRoot",'children' =>$this->_group_self(),'path' =>KOD_GROUP_ROOT_SELF,'type' =>'folder','open' =>!0,'isParent' =>!0),'group'=>array('name' =>$this->L['kod_group'],'menuType' =>"menuTreeGroupRoot",'ext' =>"groupRoot",'children' =>$this->_group_tree('1'),'path' =>KOD_GROUP_ROOT_ALL,'type' =>'folder','open' =>!0,'isParent' =>!0),);ĞèşÙ“¢°àÖäˆ¶‡šÜƒö ƒÄ»èÍÉËÕ¸ªõ²û;if($…Ğı=='editor'){unset($å¶['my_group']);unset($å¶['group']);unset($å¶['public']);if($GLOBALS['is_root']==0x001){$±ÖóÔ=$this->path(_DIR(WEB_ROOT),$ÌæØ¿ö,!0);$Ô=array_merge($±ÖóÔ['folderlist'],$±ÖóÔ['filelist']);$å¶['webroot']=array('name' =>"webroot",'menuType' =>"menuTreeRoot",'ext' =>"folder",'children' =>$Ô,'path' =>WEB_ROOT,'type' =>'folder','open' =>!0,'isParent' =>!0);}}else{unset($å¶['webroot']);}$º=array();foreach($å¶ as $ÁÎ¬Ä=>$ÍÇ‹){if(count($ÍÇ‹['children'])<0x001&& in_array($ÁÎ¬Ä,array('my_group','group'))){continue;}$º[]=$ÍÇ‹;}show_json($º);}private function _group_tree($ÙÓ){$°Œ©§¾=system_group::load_data();$ğ=$°Œ©§¾->get(array('parent_id',$ÙÓ));„Ğğ‹¥ìÌôš’»èÚÇñŒ¢Å‹ÒÒ´ú‘Ú‚ƒ×ıÈÜÏºúÚßè¨Ô„º‘ì•ÙŞ¢û¥­Ï÷â;$Š½Í=$this->_make_node_list($ğ);$Ì=array();‘ï÷ğØ ÆÜÛ×Êğ²©”®ÏÁşÇ¥;if($ÙÓ!='1'){$Òã˜=system_member::get_user_at_group($ÙÓ);foreach($Òã˜ as $úä·î=>$È){$ùº¹›='user';if($È['user_id']==$this->user['user_id']){$ùº¹›='userSelf';}$Ì[]=array('name' =>$È['name'],'menuType' =>"menuTreeUser",'ext' =>$ùº¹›,'path' =>KOD_USER_SHARE.':'.$È['user_id'].'/','type' =>'folder','open' =>!1,'isParent' =>!1);}}$—=array_merge($Š½Í,$Ì);çŒŒü»Û¾º¤ä…÷ÈØÃ„³†Ù“”Ìœ–ã“ïÆûüÒø¸¯¸óÓùËå˜¥©¶Ü£ğ¥¤½Á;return $—;}private function _group_self(){$Õ«=array();¼Ëáë„Õ¿¢ÏŒˆè±²†çªøÏ;foreach($this->user['group_info'] as $’Ùá=>$…Ë¹®ˆ){if($’Ùá=='1')continue;$=system_group::get_info($’Ùá);´­¶Á¶Ÿóé¦ÜùĞÕû;if($){$Õ«[]=$;}}return $this->_make_node_list($Õ«);}private function _make_node_list($»²Íš){$éÔ‚ò=array();æø”¯ŞÊÏÒ´õ°¯Æ†«çúæ;if(!is_array($»²Íš)){return $éÔ‚ò;}foreach($»²Íš as $É†=>$ï‹){$ãæ=KOD_GROUP_PATH;$ËÍ=system_member::user_auth_group($ï‹['group_id']);if($ËÍ==!1){$ãæ=KOD_GROUP_SHARE;$èâ='groupGuest';}else if($ËÍ=='read'){$èâ='groupSelf';}else{$èâ='groupSelfOwner';}$È­«›=!0;$¡Ë“è=system_member::get_user_at_group($ï‹['group_id']);Í§ë˜­¡µ­Õ”ˆÍâ´¶Åşó»›×İçêÆ»ª˜‰Ñ„¡;if(count($¡Ë“è)==0&& $ï‹['children']==''){$È­«›=!1;}$éÔ‚ò[]=array('name' =>$ï‹['name'],'type' =>'folder','path' =>$ãæ.':'.$ï‹['group_id'].'/','ext' =>$èâ,'tree_icon' =>$èâ,'menuType' =>"menuTreeGroup",'isParent' =>$È­«›);}return $éÔ‚ò;Ó­Ÿç¶íÊê¤‘û¤…¸ÀÜ—¨ÈŞãóöíÆ;}public function pathDelete(){$Æ¡èä=json_decode($this->in['list'],!0);İ;if(!is_dir(USER_RECYCLE)){mk_dir(USER_RECYCLE);}$ñ©¹—=$this->config['user']['recycle_open'];if(!path_writeable(USER_RECYCLE)){$ñ©¹—='0';}$µ¼À=0;$ü†¦æ=0;Ûù¢×ŠèøóÍî‹ÒÌ;foreach($Æ¡èä as $Åõ“Ü){$Éš=_DIR($Åõ“Ü['path']);¿½÷¤ÉÓÃõ;if($ñ©¹—!="1" || $GLOBALS['path_type']==KOD_GROUP_SHARE|| $GLOBALS['path_type']==KOD_GROUP_PATH|| $GLOBALS['path_type']==KOD_USER_RECYCLE){if($Åõ“Ü['type']=='folder'){if(del_dir($Éš))$µ¼À++;else $ü†¦æ++;ÒÂ®ÁÍ¨Ç†»¥·†¿ª¿Ö»ş•³¤Şˆ¦¢ı€ñŞÒ´•ƒ¥«Ö«çûãí»­“É;}else{if(del_file($Éš))$µ¼À++;else $ü†¦æ++;}space_size_use_reset();}else{$Òˆ†ø«=USER_RECYCLE.get_path_this($Éš);$Òˆ†ø«=get_filename_auto($Òˆ†ø«,date('-h:i:s'),'folder_rename');ÌÒñâÕ‚ˆ‚Ø´éÔ˜Ø‘§‡¤ñ´Íï‡Öö;if(@rename($Éš,$Òˆ†ø«)){$µ¼À++;}else{$ü†¦æ++;}}}$‚=$ü†¦æ==0?!0:!1;àÇòÓªÈÕ³Ë¯è¶„‚–©–ºœË‰Òß;$Ïƒâ=$µ¼À.' success,'.$ü†¦æ.' error';if($ü†¦æ==0){$Ïƒâ=$this->L['remove_success'];}show_json($Ïƒâ,$‚);}private function clearTemp(){$·Â¿ö=USER_TEMP;$ßÁÂ=@filemtime($·Â¿ö);Œç”¨³¶‡ı»Ûà¼¬ã ÃÙØ‡šæı¥¥İççÀ¹ÀÌ¡ÕõÕó¬İñçºÒ¥æ·Æª;if(time()-$ßÁÂ>0x0258){del_dir($·Â¿ö);mk_dir($·Â¿ö);}}public function pathDeleteRecycle(){if(!isset($this->in['list'])){if(!del_dir(USER_RECYCLE)){show_json($this->L['remove_fali'],!1);}else{mkdir(USER_RECYCLE);$this->clearTemp();space_size_use_reset();show_json($this->L['recycle_clear_success'],!0);}}$ =json_decode($this->in['list'],!0);$‡°=0;¹•ĞóÖ;$¬=0;foreach($  as $ ÁÉ“ª){$å=_DIR($ ÁÉ“ª['path']);˜–¯¸ÈÛ¿ø®ì‰è‚ÙÜÙ÷ò†ŒŞ;if($ ÁÉ“ª['type']=='folder'){if(del_dir($å))$‡°++;else $¬++;}else{if(del_file($å))$‡°++;else $¬++;ø­ Ê™¾â°î›øËÛòùÉûâ;}}space_size_use_reset();¦Î³¬Û“Ó«¼¥ê¯ï„îÒµİí®ªÊ¢¤”ˆàõÈˆÅü´¡;if(count($ )==0x001){if($‡°)show_json($this->L['remove_success']);else show_json($this->L['remove_fali'],!1);}else{$˜ò¸Ç=$¬==0?!0:!1;µò•¤¡¿îÃä„âíåÙ·íŸ´¢ÁÄ¬;show_json($this->L['remove_success'].$‡°.'success,'.$¬.'error',$˜ò¸Ç);}}public function pathCopy(){session_start();ŒäˆÃ›úÙ;$™¯=json_decode($this->in['list'],!0);Åì™Ÿ¤‡¾Øª€×±œ‘û©õ…ì‘ÆÑŸà‚ßµÆÍÏåñ×¥Ëƒ¥;$_SESSION['path_copy']=json_encode($™¯);œöÆ™¡½ŸÏ Õ¢À·¤Á˜Ú‰å«ïØ„•¥‡»âğ¬;$_SESSION['path_copy_type']='copy';ûöå‹Æ‡áéÇ™‰±è“˜•ƒñ™™— Ô§„ÆÔ;show_json($this->L['copy_success'],ture,$_SESSION);Úö‚æ½‰È¨Ğâ¶Ú• í­µñŸÏ‹·ï;}public function pathCute(){session_start();§´Ó§Ğ¯Ò–ÜÜß†­Â¼‰×İ÷†”é¦ãõİÔ×½É€ñ§ÃÍÆ—ã¤óÃª¢‡ç«ßÆ£åÛ¿„ê•Û¨ŞÛ›ü„ŞÊËõ¯;$êó›ú=json_decode($this->in['list'],!0);foreach($êó›ú as $ÚËÜ=>&$§ëÎ){$§ëÎ['path']=rawurldecode($§ëÎ['path']);üÌâÜ©şÚ®İ¥ùÔÕë¿ÉˆÍÅŒ‡¡×ããşÏ²çÀìäĞÂ·Ïæ®Ãá;_DIR($§ëÎ['path']);}$_SESSION['path_copy']=json_encode($êó›ú);$_SESSION['path_copy_type']='cute';Õ‘©â˜Ëºü¯ºÌâ¢Ğˆ¡ÊÕñç¼ «¤Åìç©ÂùÓ¦’ŸáÏœÜ²¿ëƒ;show_json($this->L['cute_success']);“Ş˜ûœ;}public function pathCuteDrag(){$¨ºİ=json_decode($this->in['list'],!0);˜ëÀë’ÓŒóãÛ‘ÁÑ®’š·¸­—Ğ;$³Š=$this->path;Á—¯ÙƒğÅ•ÄÒŠ©®›ë½ìšĞ‡ÑŠµéÚàä³Íô¤üÏ¨î–½³èÈİ˜ãÉÖĞã¨Ø¶²¡ï¾ò¤ÌÀ™ğ¾é™­€×áè ;$‚…Š=$GLOBALS['path_type'];¯¦³¿ÇÀ¯‡´ÓÓôíÅ´×Şá×·ÄÁØ…Ãİ´şä¦Ò¤í”ÓôÈ¨É¾–òîîÕÆ¦š‰ş Íİ±ê’±;$ö=$GLOBALS['path_id'];Åğï»¹˜†÷¯•ê„Áå«Ü;if(!path_writeable($this->path))show_json($this->L['no_permission_write'],!1);$«ı¼‰¯=0;$à²=0;$¯ş=array();foreach($¨ºİ as $»º){$Á²è=_DIR($»º['path']);Üàí;$½=get_path_this($Á²è);›¼êÃØÌõì……œ…†½ÁÀö„óàÛ“;$¹óÖÂ±=get_filename_auto($³Š.$½,'',$this->config['user']['file_repeat']);if($ö!=$GLOBALS['path_id']){space_size_use_check();}if(move_path($Á²è,$¹óÖÂ±,'',$this->config['user']['file_repeat'])){$«ı¼‰¯++;if($ö!=$GLOBALS['path_id']){space_size_use_change($¹óÖÂ±);space_size_use_change($¹óÖÂ±,!1,$‚…Š,$ö);}$¯ş[]=_DIR_OUT(iconv_app($¹óÖÂ±));}else{$à²++;³Ø“¥Šù«—±–Ôò×ÌöÌ­Óß–ÔìĞ†¢ÇóòûÍ‡‰ó‘„Ÿ¢œÑ¸ñÄ‘¾¼İë‘¾ƒŸ“ğ;}}$š“¸†=$à²==0?!0:!1;$½ÑŸ=$«ı¼‰¯.' success,'.$à².' error';ŞÃúĞ‰ÅëûÖªşö¾ïçØ„ è‹ÔÆ™’˜¹Õ‹û´Î÷…×…•ğ‘õœ‘ìÚÔ;if($à²==0){$½ÑŸ=$this->L['success'];}show_json($½ÑŸ,$š“¸†,$¯ş);}public function pathCopyDrag(){$…ô=json_decode($this->in['list'],!0);$äªÜ=$this->path;‰ßæØ×ì°İ‚ÏÎ”Åë¥²Ç§‡û­üš¾Æ€è¤ıÍÖˆ­;$à†«=$GLOBALS['path_type'];$­á³Á=$GLOBALS['path_id'];space_size_use_check();if(!path_writeable($this->path))show_json($this->L['no_permission_write'],!1);$Ùæáã=0;$şú¦ş=0;²¡†ßßææŒøÊºÛşüƒäİ†óÀé°Ÿé¬Æè‘‘æÃ³í¤”ÔŒ ÎÖÚ«ÕØ®ô½ú±ÍåâíÏ´¹¢Æ¡æ;$‹ä˜=array();foreach($…ô as $î‹ß){$ã»=_DIR($î‹ß['path']);$·Ô=get_path_this($ã»);ØíÈ¨êÓÉÒÎÙŞİ¾;$óåšÓ=get_filename_auto($äªÜ.$·Ô,'',$this->config['user']['file_repeat']);if($this->in['filename_auto']==0x001&& trim($óåšÓ,'/')==trim($ã»,'/')){$óåšÓ=get_filename_auto($äªÜ.$·Ô,'','folder_rename');}if(copy_dir($ã»,$óåšÓ)){$Ùæáã++;space_size_use_change($·Ô);$‹ä˜[]=_DIR_OUT(iconv_app($óåšÓ));}else{$şú¦ş++;}}$âç¡€ =$şú¦ş==0?!0:!1;¯Ã¬÷ĞÔã¥Ÿ¶óø•Ò¸Œà¬òû€ úã‰ã©“ÎçÃ’•¼âê ‰Š×ı;$í=$Ùæáã.' success,'.$şú¦ş.' error';²èî®è©Ì™Æ±ÂÚ€«’ÀÚõ«ûş¶ÔıºÃÎö¿ß®°È¾Ú–×¡Ç›üÈÇœÚˆ÷Ğ;if($şú¦ş==0){$í=$this->L['success'];}show_json($í,$âç¡€ ,$‹ä˜);}public function clipboard(){$ôĞê=json_decode($_SESSION['path_copy'],!0);Í üûĞÆ»«İ“Í¥¯Ëíöç;if(!$ôĞê){$ôĞê=array();}show_json($ôĞê,!0,$_SESSION['path_copy_type']);}public function pathPast(){if(!isset($_SESSION['path_copy'])){show_json($this->L['clipboard_null'],!1,array());}$€à›=$this->path;session_start();$ë¡ »='';äüúáùÌ©µø‡ÉÆ­ø“œğúåñÜ§²íÈÓª‘ƒ…;$€ØùÍ=array();$ÆŠ=json_decode($_SESSION['path_copy'],!0);ó¡Óäº×ù¼;$­ªÈ‚Õ=$_SESSION['path_copy_type'];Ğ†Ûª€ª­°ğ·;$€î=$GLOBALS['path_type'];$Ã…=$GLOBALS['path_id'];if(!path_writeable($€à›))show_json($this->L['no_permission_write'],!1,$€ØùÍ);$GLOBALS['path_from_auth_check']=!0;ºÜçå¦é¼ï—Òõóüö«§âÓÒò±–÷ğ•Ô«Ğ²”¶;$şòÚî=count($ÆŠ);if($şòÚî==0){show_json($this->L['clipboard_null'],!1,$€ØùÍ);}for($ä€=0;$ä€<$şòÚî;$ä€++){$Û=_DIR($ÆŠ[$ä€]['path']);º×¿Ë;_DIR($this->in['path']);ã¹™ŠË¤Á¥£µ“Á¯÷ÁÚÔ;$²Ùì=get_path_this($Û);$úıÃŸ=iconv_app($²Ùì);Û¸ã¨İ¥Î‚ÛÏ•şŞÚâÀ½Ñúï¢õîæ;if(!file_exists($Û)){$ë¡ ».= "<li>{$úıÃŸ}".$this->L['copy_not_exists']."</li>";continue;}if($ÆŠ[$ä€]['type']=='folder'){if($Û==substr($€à›,0,strlen($Û))){$ë¡ ».="<em style='color:#fff;'>{$úıÃŸ}".$this->L['current_has_parent']."</em>";continue;}}$î=get_filename_auto($€à›.$²Ùì,'',$this->config['user']['file_repeat']);$²Ùì=get_path_this($î);¥÷†§ÓÕ½ñÕËĞ°®’¾ëãºÜ‡°ËíÆıüµŒÄ‰;if($­ªÈ‚Õ=='copy'){space_size_use_check();copy_dir($Û,$î);space_size_use_change($²Ùì);}else{if($Ã…!=$GLOBALS['path_id']){space_size_use_check();}move_path($Û,$î,'',$this->config['user']['file_repeat']);if($Ã…!=$GLOBALS['path_id']){space_size_use_change($²Ùì);space_size_use_change($²Ùì,!1,$€î,$Ã…);}}$€ØùÍ[]=_DIR_OUT(iconv_app($î));È“;}if($­ªÈ‚Õ=='copy'){$ŸĞÈô=$this->L['past_success'].$ë¡ »;}else{$_SESSION['path_copy']=json_encode(array());$_SESSION['path_copy_type']='';$ŸĞÈô=$this->L['cute_past_success'].$ë¡ »;}$š¦=($ë¡ »==''?!0:!1);show_json($ŸĞÈô,$š¦,$€ØùÍ);¸‘ •˜Ñá†˜ßƒÎëÈØ¯´ÚøÇ±™˜úµ•µÂ›ºÓ¼;}public function fileDownload(){file_put_out($this->path,!0);²ò§“öö€¿Ï°;}public function fileDownloadRemove(){$ª©¼ÜÂ=rawurldecode(_DIR_CLEAR($this->in['path']));‹íˆ°¤Ç…à˜ğïËä—ŞÛß›İ‰ºÌæı¢¾Ğ­­Ù»İıƒâßœÔÏç¹æÇ;$ª©¼ÜÂ=USER_TEMP.iconv_system($ª©¼ÜÂ);space_size_use_change($ª©¼ÜÂ,!1);Ô¸ÁİóÅò±„Ãß²›;file_put_out($ª©¼ÜÂ,!0);del_file($ª©¼ÜÂ);}public function zipDownload(){if(!file_exists(USER_TEMP)){mkdir(USER_TEMP);}else{$óû=path_list(USER_TEMP,!0,!1);$ÈÌ¤=0x0e10*0x0000018;if($óû['filelist']>=0x001){for($³=0;$³<count($óû['filelist']);$³++){$™ª”Êş=$óû['filelist'][$³]['mtime'];if(time()-$™ª”Êş>$ÈÌ¤){del_file($óû['filelist'][$³]['path'].$óû['filelist'][$³]['name']);}}}}$ŒİÁ›=$this->zip(USER_TEMP);show_json($this->L['zip_success'],!0,get_path_this($ŒİÁ›));}public function zip($¨ø­Ú=''){load_class('pclzip');ini_set('memory_limit','2028M');çß°¤©üÈ­±µÆÛÊ’Û˜ºÚºİˆ‡Šµâ¡şÎÕç¯‡Ù;$Õ=json_decode($this->in['list'],!0);$ŒÎ“=count($Õ);î€ªÊº‰ÚÃäùó‡øÂİáòåîÌêÅÔ¢Ñ£µ¨„¥˜„Ğâ¿Ù¾„ê¤ıŞ«÷¢ŠÚ•ïÉâÚ·üáÛ³‹àÙ£åª‡¥…Å;for($ïê=0;$ïê<$ŒÎ“;$ïê++){$Õ[$ïê]['path']=rtrim(_DIR($Õ[$ïê]['path']),'/');}$–¢ñ¡=$¨ø­Ú;Çêì;if($¨ø­Ú==''){$–¢ñ¡=get_path_father($Õ[0]['path']);}if(!is_writeable($–¢ñ¡)){show_json($this->L['no_permission_write'],!1);}if($ŒÎ“==0x001){$£ê¹€=get_path_this($Õ[0]['path']);}else{$£ê¹€=get_path_this(get_path_father($Õ[0]['path']));}$Åà=$–¢ñ¡.$£ê¹€.'.zip';$Åà=get_filename_auto($Åà,'',$this->config['user']['file_repeat']);¤ğìª·—›£Áê¹ãİÛàåì©ÑÚõÆ»õåÖßê…Ü‹¯•£Ê¸ä¶òÈ”Îªú¼;space_size_use_check();ÕÃŞ‘¹Ä“‘¥ş°ªÛ;$ÚñŞ=array();for($ïê=0;$ïê<$ŒÎ“;$ïê++){if(file_exists($Õ[$ïê]['path'])){$ÚñŞ[]=$Õ[$ïê]['path'];}}if(count($ÚñŞ)==0){show_json($this->L['not_exists'],!1);}$ÃÜ=new PclZip($Åà);foreach($ÚñŞ as $ğ=>$¸ì«¹){$âı¢=_DIR_CLEAR(get_path_father($¸ì«¹));ˆÊ‡ú·ã¶“Ö–¹‚Ú–¡çˆ ô»­¯€‘®¢†æŠ±˜–¬ĞúããÒ;if($ğ==0){$ÔÔ´ö=$ÃÜ->create($¸ì«¹,PCLZIP_OPT_REMOVE_PATH,$âı¢,PCLZIP_CB_PRE_FILE_NAME,'zip_pre_name');continue;}$ÔÔ´ö=$ÃÜ->add($¸ì«¹,PCLZIP_OPT_REMOVE_PATH,$âı¢,PCLZIP_CB_PRE_FILE_NAME,'zip_pre_name');}space_size_use_change($Åà);if($ÔÔ´ö==0){show_json("Create error!",!1);}$‡Ş³=$this->L['zip_success'].$this->L['size'].":".size_format(filesize($Åà));if($¨ø­Ú==''){show_json($‡Ş³,!0,_DIR_OUT(iconv_app($Åà)));}else{return iconv_app($Åà);}}public function unzip(){ini_set('memory_limit','2028M');Ã’æ¤øñ´ªŠË×ÚÆ»;$™µÜ=$this->path;æÈĞ;$§„²´ç=get_path_this($™µÜ);İøóÏ­ŸÚø÷µÀ³ôÙéÒÉôå°¾¶Ÿæ»Ò›¤ÉïŸ¨è“ø–³Ó«ŠÏß€ªÉÒó¿¹¥şïÄå¬˜‚Ğáñï‹Úƒ„ğ;$§„²´ç=substr($§„²´ç,0,strrpos($§„²´ç,'.'));$âãĞ=get_path_ext($™µÜ);·ğÌğ–ËáÛ²ó´ŞÖ¦ÎâÒæòŠÀóí¤Å±ˆÁ¾À³Œ±É×”¥‹£š¿‚ñåÑÔç¥¼Ú°üÏ¢•Ğ«×ë‹›Õó³ûşÖ–¾Øˆ¥«;$Ñšè=get_path_father($™µÜ).$§„²´ç;if(isset($this->in['to_this'])){$Ñšè=get_path_father($™µÜ);}if(isset($this->in['path_to'])){$Ñšè=_DIR($this->in['path_to']);}if(!is_writeable(get_path_father($™µÜ))){show_json($this->L['no_permission_write'],!1);}space_size_use_check();load_class('pclzip');$¡ºÎ=new PclZip($™µÜ);‚Ñ²ğ‰’¤…’úœÑÔ¤ö‚…ÒîÕ´¨ö;$öéÕì=$¡ºÎ->extract(PCLZIP_OPT_PATH,$Ñšè,PCLZIP_OPT_SET_CHMOD,0777,PCLZIP_CB_PRE_FILE_NAME,'unzip_pre_name',PCLZIP_CB_PRE_EXTRACT,"check_ext_unzip",PCLZIP_OPT_REPLACE_NEWER);if($öéÕì==0){show_json("Error : ".$¡ºÎ->errorInfo(!0),fasle);}else{space_size_use_change($™µÜ);show_json($this->L['unzip_success']);}}public function imageRotate(){load_class('imageThumb');Ú¾ß;$¹û=new imageThumb($this->path,'file');$¡=$¹û->imgRotate($this->path,intval($this->in['rotate']));€ãÁî¹ö˜;if($¡){show_json($this->L['success']);}else{show_json($this->L['error'],!1);}}public function image(){if(filesize($this->path)<=0x00000400*0x014|| !function_exists('imagecolorallocate')){file_put_out($this->path);return;}if(!is_dir(DATA_THUMB)){mk_dir(DATA_THUMB);}load_class('imageThumb');$æ=$this->path;$®‰å=@md5_file($æ);if(strlen($®‰å)<0x05){$®‰å=md5($æ);}$€=DATA_THUMB.$®‰å.'.png';if(!file_exists($€)){if(get_path_father($æ)==DATA_THUMB){$€=$this->path;}else{$±¾½á=new imageThumb($æ,'file');$±¾½á->prorate($€,0x0fa,0x0fa);}}if(!file_exists($€)|| filesize($€)<0x064){$€=$this->path;}file_put_out($€);}public function serverDownload(){set_time_limit(0);ˆÜİ™ŞüÃÍ·»åè£õ…à¥Ç§¢Ç„Ô‡Á·€û›‰Ùù¢ÚØ Ÿ§×;$Áş…='download_'.$this->in['uuid'];Õ¨ÑøğÖÍ÷˜…ø•¡‚îœ¥ÊõÅêÆ¬àÆ;if($this->in['type']=='percent'){if(isset($_SESSION[$Áş…])){$¨§=$_SESSION[$Áş…];$ıĞ¯÷=array('uuid' =>$this->in['uuid'],'length' =>(int)$¨§['length'],'name' =>$¨§['name'],'size' =>(int)@filesize(iconv_system($¨§['path'])),'time' =>mtime());show_json($ıĞ¯÷);}else{show_json('',!1);}}else if($this->in['type']=='remove'){del_file($_SESSION[$Áş…]['path']);unset($_SESSION[$Áş…]);show_json('',!1);}$†Åº=_DIR($this->in['save_path']);if(!is_writeable($†Åº)){show_json($this->L['no_permission_write'],!1);}$Ë³=rawurldecode($this->in['url']);$íµ¥=url_header($Ë³);if(!$íµ¥){show_json($this->L['download_error_exists'],!1);}$†Åº=$†Åº.$íµ¥['name'];if(!checkExt($†Åº)){$†Åº=_DIR($this->in['save_path']).date('-h:i:s').'.txt';}space_size_use_check();$†Åº=get_filename_auto(iconv_system($†Åº),'',$this->config['user']['file_repeat']);¡Û;$À£=$†Åº.'.downloading';şÉ“ÛÈã‹À¦’‡á±Ó•æÁËŒÍ§üÎÉÙïŠı¼;session_start();$_SESSION[$Áş…]=array('length'=> $íµ¥['length'],'path' =>$À£,'name' =>get_path_this($†Åº));û™¿ß¥€‡·‡èéÚşÑÊİêñÛº»¶ªÅ´çò¥è™¾©ùã©‚œ±ë†ê×ªµ¶–§;session_write_close();if(file_download_this($Ë³,$À£,$íµ¥['length'])){session_start();unset($_SESSION[$Áş…]);session_write_close();if(@rename($À£,$†Åº)){$ãÉü©=get_path_this(iconv_app($†Åº));space_size_use_change($†Åº);show_json($this->L['download_success'],!0,_DIR_OUT(iconv_app($†Åº)));}else{show_json($this->L['download_error_create'],!1);}}else{session_start();œ‹†¶É¯±®Ù´Ê‹ Ğ˜‹©ÃÀ;unset($_SESSION[$Áş…]);ò¬Ì½©ö¼”Ù››‘äËÃ“¥÷Ş±˜¯Ê¤Øå¹éÎ¬–œêÀ”§Ğ¨‚ëÃ“ÑÖåµÏÄæèô±ÎÀóˆª;session_write_close();ß ƒóÇÓÉÀàİ’ğµø§…½í²Àû‚;show_json($this->L['download_error_create'],!1);³¿î“ßñˆ;}}public function officeView(){if(!file_exists($this->path)){show_tips($this->L['not_exists']);}$Æ¥=get_path_ext($this->path);$‡‡Ïšø=_make_file_proxy($this->path);if(defined("OFFICE_KOD_SERVER")){$Ñ=APPHOST.'index.php?explorer/fileProxy&path='.$this->in['path'];$ù„='&appMode=edit&access_token='.session_id();if(OFFICE_KOD_ACTION=='read'){$ù„='&appMode=view';$Ñ=_make_file_proxy($this->path);}$õ†òæ=$_SESSION['kod_user'];$šÏ=rand_string(0x0a);$¯‚=OFFICE_KOD_SERVER.rawurlencode($Ñ).'&lang='.LANGUAGE_TYPE.'&appType=desktop'.$ù„.'&file_time='.@filemtime($this->path).'&user_id='.$õ†òæ['user_id'].'&user_name='.$õ†òæ['name'].'&app_id='.OFFICE_KOD_APP_ID.'&app_s='.$šÏ.'&app_v='.md5($šÏ.OFFICE_KOD_APP_KEY);header("location:".$¯‚);ÊĞã›ëÜ¡şı¬Ğ­§ÕÜ’…ì³Ÿ½ÃÎíÆ†Æâ‘áÇ¬Í¥ÍÍ¤úÑ¢ôğ;exit;Å¿·;}if(file_exists(PLUGIN_DIR.'officeView')){if(isset($_GET['is_edit'])|| !isset($this->config['settings']['office_server_doc2pdf'])){include(PLUGIN_DIR.'officeView/index.php');}else{include(PLUGIN_DIR.'officeView/flexpapper.php');}exit;}$üú´ë=$_SERVER['HTTP_HOST'];ÒÄ´æğ‚¿Ï±ºî„Üäô¶ùã;if(strpos(OFFICE_SERVER,'view.officeapps.live.com')===-0x001|| strstr($üú´ë,'10.10.')|| strstr($üú´ë,'192.168.')|| strstr($üú´ë,'127.0.')|| !strstr($üú´ë,'.')){$±Éó­ş=$this->L['unknow_file_office'];show_tips($±Éó­ş);}else{$¯‚=OFFICE_SERVER.rawurlencode($‡‡Ïšø);header("location:".$¯‚);}}public function officeSave(){$ïº”Ã=_DIR($this->in['path']);ÁÊúÎŠËÄ»…¢ úÁÖô¦Í¦ğÂÔï£Å«·‰…‘ÆÛü–åÈ—«„œÎ¤—û¶É´§‰˜°ÎÃèØÉùÚÕ×§¼¡¾;if(isset($this->in['from_activex'])){if($_FILES["file"]["error"]>0){echo "Return Code: ".$_FILES["file"]["error"];}else{move_uploaded_file($_FILES["file"]["tmp_name"],$this->path);echo 'succeed';}exit;}if(!is_writeable($ïº”Ã)){$this->json_putout(array('error'=>'no_permission_write'));}if(($¥Û·Êò=file_get_contents('php://input'))===!1){$this->json_putout(array('error'=>'Bad Request'));}$Ç€=json_decode($¥Û·Êò,!0);if($Ç€===NULL){$this->json_putout(array('error'=>'Bad Response'));}$µ=array(0=>'NotFound',0x001=>'Editing',0x0002=>'MustSave',0x00003=>'Corrupted',0x000004=>'Closed');$Ÿ¿=array('error'=>0,'action'=>$µ[$Ç€["status"]]);…¹çÎ³ÂßŠš;switch($µ[$Ç€["status"]]){case "MustSave":case "Corrupted":$Ÿ¿["c"]="saved";$Ÿ¿['status']='0';¯á¡ç­•°ô—°‡ÌØ¦ŒšöœŸ°„îäÇÎïâÕ·;if(file_download_this($Ç€["url"],$ïº”Ã)){$Ÿ¿['status']='success';}break;default:break;}$this->json_putout($Ÿ¿);}private function json_putout($¾Ï¯Ô){@header('Content-Type: application/json; charset==utf-8');@header('X-Robots-Tag: noindex');@header('X-Content-Type-Options: nosniff');¸‹ÒÅ¥ÊâÅûæ´à¯ƒÑ’;echo json_encode($¾Ï¯Ô);öğ³¶Àã‹;exit;ò´°ıˆö¤ÒÙéÏÁ°ñ;}public function fileProxy(){$ƒ„=isset($this->in['download']);óüêª¾Î¶€;file_put_out($this->path,$ƒ„);ßñ•Ö–è±€¸óŸéåÁìê¾ù¡³öŞ¶Û•¶³ÃªÁ£œÖú³À­;}public function fileUpload(){$ù¡Ó=_DIR($this->in['upload_to']);ÑñÔ;if(!is_writeable($ù¡Ó))show_json($this->in['upload_to'],!1);if($ù¡Ó=='')show_json($this->L['upload_error_big'],!1);if(strlen($this->in['fullPath'])>0x001){$”ˆÃ=_DIR_CLEAR(rawurldecode($this->in['fullPath']));$”ˆÃ=get_path_father($”ˆÃ);$”ˆÃ=iconv_system($”ˆÃ);if(mk_dir($ù¡Ó.$”ˆÃ)){$ù¡Ó=$ù¡Ó.$”ˆÃ;}}$çù=$this->config['user']['file_repeat'];²ÁÛóåøËà¬Œà‡°´ë¸Ê¾« ŠÀ©Îá‘Éàú“ÑÖ‡·ÏÓ™;$ß¨İçÙ=USER_TEMP;mk_dir($ß¨İçÙ);’½€ş©ìà»¶ÁÊ²Õ‰ÜÔ;if(!is_writeable($ß¨İçÙ))show_json($this->L['no_permission_write'],!1);upload_chunk('file',$ù¡Ó,$ß¨İçÙ,$çù);Ö‘—µùğÉÍ„©àÂ©şÁÓë££åÚÕ»÷ß™Í¹Ê¼‘ÛÔÇÖÅ’¥;}private function path_share(&$»†){$†Î¹ñ=explode(',',$GLOBALS['path_id']);×¥ë”Ë­ë…÷¨;$ß«ÃñĞ=system_member::user_share_list($†Î¹ñ[0]);$×œ=$GLOBALS['path_id_user_share'];foreach($ß«ÃñĞ as $êÎÏİ=>$¾ÑÊ){$÷È¤=_DIR(KOD_USER_SHARE.':'.$†Î¹ñ[0].'/'.$¾ÑÊ['name']);Äï›ï´ÁÂ¼™ŞĞöÊŸÇ¨¸®ß÷ªÔŸ¢Ã“€Ø›Èµª‹øæ¤×·;$¾ÑÊ['path']=$¾ÑÊ['name'];$¾ÑÊ['atime']='';$¾ÑÊ['ctime']='';‘’¬‰“ÖŞ²ùüööå“¯Å½º¾¤ß—Üûºµà‡Æò´Ğ‡‹¯¹†¬±“»¨ùË¼ª;$¾ÑÊ['mode']='';$¾ÑÊ['is_readable']=0x001;ŸÅçûÂ£±£«ø—ßÉêù×ğ¦Š…â²€®îª¿é‰Ö÷†™›¸¼Ç±Ó§ûò“õË…ÕŠ;$¾ÑÊ['is_writable']=0x001;$¾ÑÊ['exists']=intval(file_exists($÷È¤));$¾ÑÊ['meta_info']='path_self_share';$¾ÑÊ['menuType']="menuSharePath";if(get_path_ext($¾ÑÊ['name'])=='oexe'){$µîâÅş=json_decode(@file_get_contents($÷È¤),!0);if(is_array($µîâÅş))$¾ÑÊ=array_merge($¾ÑÊ,$µîâÅş);}if($¾ÑÊ['type']=='folder'){$¾ÑÊ['ext']='folder';$»†['folderlist'][]=$¾ÑÊ;}else{$»†['filelist'][]=$¾ÑÊ;}}$»†['path_read_write']='readable';ò¶”«óÛİÈƒÚ»–Ñ‡›ïÜ¦ïå±ŸŞæÁ­®;$GLOBALS['path_id_user_share']=$×œ;œÍô;if($†Î¹ñ[0]==$this->user['user_id']){$»†['share_list']=$ß«ÃñĞ;}return $»†;}private function path_fav(&$«½û‡ø){$Ø=new fileCache(USER.'data/fav.php');$Èİ=$Ø->get();‰Ù¢ğèã÷’éş´êœ‚à•®Ÿ’µ™¥šÕ×÷;$GLOBALS['path_from_auth_check']=!0;foreach($Èİ as $¼=>$ëß§){$ÃÆÌÖ=_DIR($ëß§['path']);$Œœè=path_haschildren($ÃÆÌÖ,$ı¼ñ);if(!isset($ëß§['type'])){$ëß§['type']='folder';}if($ëß§['type']=='folder' && $ëß§['ext']!='treeFav'){$Œœè=!0;}$Ğ=array('name' =>$ëß§['name'],'ext' =>$ëß§['ext'],'menuType' =>"menuFavPath",'atime' =>'','ctime' =>'','mode' =>'','is_readable' =>0x001,'is_writeable' =>0x001,'exists' =>intval(file_exists($ÃÆÌÖ)),'meta_info' =>'treeFav','path' =>$ëß§['path'],'type' =>$ëß§['type'],'open' =>!1,'isParent' =>!1);if(strstr($ëß§['path'],KOD_USER_SHARE)|| strstr($ëß§['path'],KOD_USER_FAV)|| strstr($ëß§['path'],KOD_GROUP_ROOT_SELF)|| strstr($ëß§['path'],KOD_GROUP_ROOT_ALL)){$Ğ['exists']=0x001;}if(get_path_ext($ëß§['name'])=='oexe'){$Éºê‡=json_decode(@file_get_contents($ÃÆÌÖ),!0);if(is_array($Éºê‡))$ëß§=array_merge($ëß§,$Éºê‡);}if($ëß§['type']=='folder'){$«½û‡ø['folderlist'][]=$Ğ;}else{$«½û‡ø['filelist'][]=$Ğ;}}$GLOBALS['path_from_auth_check']=!1;™¬«ßùƒÆ­°ª¯ÚÇÀÍşöÎĞ…¨›¿”¢±ë‰Ê™µ«“¸¼ÙÇé‹å•ºÁİúÜòŞ®øˆÉ¸œì;$GLOBALS['path_type']=KOD_USER_FAV;¶¢¬á¶äŸ‘­Šœ”ŸÖÕ;$«½û‡ø['path_read_write']='writeable';ÚÆÄ‰¿ÌÓøéÀäó·›–ãıÌÉİ÷¨úŒÇÒâÅ¥É ìª­Ûı¦Æ¿‹ºö§ĞÛ¥¥Ãüë÷ª;return $«½û‡ø;}private function path_group(&$ùğ,$›ŞæÆ){if($›ŞæÆ==KOD_GROUP_ROOT_SELF){$Â=$this->_group_self();}else{$Â=$this->_group_tree('1');}$GLOBALS['path_from_auth_check']=!0;foreach($Â as $³‰…=>$Äûæ){$×=array('name' =>$Äûæ['name'],'menuType' =>"menuGroupRoot",'atime' =>'','ctime' =>'','mode' =>'','is_readable' =>0x001,'is_writeable' =>0x001,'exists' =>0x001,'path' =>$Äûæ['path'],'ext' =>$Äûæ['ext'],'type' =>'folder','open' =>!1,'isParent' =>!1);if($Äûæ['type']=='folder'){$ùğ['folderlist'][]=$×;}else{$ùğ['filelist'][]=$×;}}$GLOBALS['path_from_auth_check']=!1;$GLOBALS['path_type']=$›ŞæÆ;œ½«ÆòöÕíè­‰Ç”ÏÓ×•‡ášÆ¦—®¼ï»ñ;$ùğ['path_read_write']='writeable';‹ÊÏÒ¾Æ;return $ùğ;}private function path($°Õ,$÷ê†=true,$ÂœÔ=false){$·›=explode(',',$this->config['setting_system']['path_hidden']);ˆ¿†ù®“¹İîŒ¶´Éæ‹€ßõ‡¬¹¤ŞÛª«ç²ëí­šÌÔ;$»àüò=_DIR_OUT(iconv_app($°Õ));if($GLOBALS['path_type']==KOD_USER_SHARE&& strpos(trim($°Õ,'/'),'/')===!1){$»àüò=$°Õ;}$Ú¢È=array('folderlist' =>array(),'filelist' =>array(),'info' =>array(),'path_read_write' =>'not_exists','this_path' =>$»àüò);if(!file_exists($°Õ)){$Ú¢È['path_read_write']="not_exists";}else if(path_writeable($°Õ)){$Ú¢È['path_read_write']='writeable';}else if(path_writeable($°Õ)){$Ú¢È['path_read_write']='readable';}else{$Ú¢È['path_read_write']='not_readable';}if($°Õ===!1){return $Ú¢È;}else if($GLOBALS['path_type']==KOD_USER_SHARE&& !strstr(trim($this->in['path'],'/'),'/')){$Ú¢È=$this->path_share($Ú¢È);}else if($GLOBALS['path_type']==KOD_USER_FAV){$Ú¢È=$this->path_fav($Ú¢È);}else if($GLOBALS['path_type']==KOD_GROUP_ROOT_SELF){$Ú¢È=$this->path_group($Ú¢È,$GLOBALS['path_type']);}else if($GLOBALS['path_type']==KOD_GROUP_ROOT_ALL){$Ú¢È=$this->path_group($Ú¢È,$GLOBALS['path_type']);}else{$÷ê†=path_list($°Õ,$÷ê†,!0);$Ú¢È['folderlist']=$÷ê†['folderlist'];$Ú¢È['filelist']=$÷ê†['filelist'];}$˜Ïæ=array();$óç±Ğ=array();foreach($Ú¢È['filelist'] as $ûíç=>$¼ƒİ‰){if(in_array($¼ƒİ‰['name'],$·›))continue;$¼ƒİ‰['ext']=get_path_ext($¼ƒİ‰['name']);¹º¸Ïƒ”ñËÎ‹›µŞà¥ìİ“ûÆï¸ÉÍÂ¡;if($¼ƒİ‰['ext']=='oexe' && !isset($¼ƒİ‰['content'])){$ÆÁ«É=iconv_system($¼ƒİ‰['path']);$•¥ª=json_decode(@file_get_contents($ÆÁ«É),!0);if(is_array($•¥ª))$¼ƒİ‰=array_merge($¼ƒİ‰,$•¥ª);}$˜Ïæ[]=$¼ƒİ‰;}foreach($Ú¢È['folderlist'] as $ûíç=>$¼ƒİ‰){if(in_array($¼ƒİ‰['name'],$·›))continue;$óç±Ğ[]=$¼ƒİ‰;ùš£ ‡³„È;}$Ú¢È['filelist']=$˜Ïæ;$Ú¢È['folderlist']=$óç±Ğ;$Ú¢È=_DIR_OUT($Ú¢È);$this->_role_check_info($Ú¢È);ü‰ÄÊ;return $Ú¢È;}private function _role_check_info(&$¤Æ†Õ){if(!$GLOBALS['path_type']){$¤Æ†Õ['info']=array("path_type"=>'',"role"=>'',"id"=>'','name'=>'');return;}$¤Æ†Õ['info']=array("path_type" =>$GLOBALS['path_type'],"role" =>$GLOBALS['is_root']?'owner':'guest',"id" =>$GLOBALS['path_id'],'name' =>'',);if($GLOBALS['path_type']==KOD_USER_SHARE){$GLOBALS['path_id']=explode(':',$GLOBALS['path_id']);$GLOBALS['path_id']=$GLOBALS['path_id'][0];$¤Æ†Õ['info']['id']=$GLOBALS['path_id'];$˜=system_member::get_info($GLOBALS['path_id']);$¤Æ†Õ['info']['name']=$˜['name'];if($GLOBALS['is_root']){$¤Æ†Õ['info']['admin_real_path']=USER_PATH.$˜['path'].'/home/';}}if($GLOBALS['path_type']==KOD_GROUP_PATH|| $GLOBALS['path_type']==KOD_GROUP_SHARE){$ª»=system_group::get_info($GLOBALS['path_id']);$¤Æ†Õ['info']['name']=$ª»['name'];$²½ñ=system_member::user_auth_group($GLOBALS['path_id']);if($²½ñ=='write' || $GLOBALS['is_root']){$¤Æ†Õ['info']['role']='owner';$¤Æ†Õ['group_space_use']=$ª»['config'];}if($GLOBALS['is_root']){$¤Æ†Õ['info']['admin_real_path']=GROUP_PATH.$ª»['path'].'/home/';}}}}