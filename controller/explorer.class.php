<?php class explorer extends Controller{public $path;public $user;public function __construct(){parent::__construct();Â¾¡”«³· ¸…Õ¦¦ƒ¨ò½ÙóÅªÜ¨ŒÈ;$this->tpl=TEMPLATE.'explorer/';ı×Ú;$this->user=$_SESSION['kod_user'];if(isset($this->in['path'])){$this->path=_DIR($this->in['path']);$this->check_system_path();}}public function index(){$îé¬§Š='';»ÓÁ¾ü´üÖ©;if(isset($this->in['path'])&& $this->in['path']!=''){$îé¬§Š=_DIR_CLEAR($_GET['path']);$îé¬§Š=rtrim($îé¬§Š,'/').'/';}$this->assign('dir',$îé¬§Š);if($this->config['forceWap']){$this->display('index_wap.php');}else{$this->display('index.php');}}private function check_system_path(){if(!in_array(ACT,array('mkfile','mkdir','search','pathCuteDrag','pathCopyDrag','pathPast','fileDownload'))){return;}if($GLOBALS['path_type']==KOD_USER_SHARE&& !strstr(trim($this->in['path'],'/'),'/')){show_json($this->L['error'],!1);}if(in_array($GLOBALS['path_type'],array(KOD_USER_FAV,KOD_GROUP_ROOT_ALL,KOD_GROUP_ROOT_SELF))){show_json($this->L['system_path_not_change'],!1);}}public function pathInfo(){$‚†ë=json_decode($this->in['list'],!0);if(!$‚†ë){show_json($this->L['error'],!1);}foreach($‚†ë as &$ÂæÁ){$ÂæÁ['path']=_DIR($ÂæÁ['path']);}$Âşà²é=path_info_muti($‚†ë,$this->L['time_type_info']);if(!$Âşà²é){show_json($this->L['not_exists'],!1);}if(count($‚†ë)==0x001&& $‚†ë[0]['type']!='folder'){if($GLOBALS['is_root']|| $GLOBALS['auth']['explorer:fileDownload']==0x001){$Âşà²é['download_path']=_make_file_proxy($‚†ë[0]['path']);}$Ú=$‚†ë[0]['path'];if($Âşà²é['size']<0x064*0x00000400*0x00000400|| isset($this->in['get_md5'])){$Âşà²é['file_md5']=@md5_file($Ú);}else{$Âşà²é['file_md5']="...";}$óˆ¯Ü=get_path_ext($Ú);if(in_array($óˆ¯Ü,array('jpg','gif','png','jpeg','bmp'))){load_class('imageThumb');$îÚ†ë=imageThumb::imageSize($Ú);if($îÚ†ë){$Âşà²é['image_size']=$îÚ†ë;}}}$Âşà²é['path']=_DIR_OUT($Âşà²é['path']);show_json($Âşà²é);}public function pathChmod(){$´µ=json_decode($this->in['list'],!0);if(!$´µ){show_json($this->L['error'],!1);}$…ŞÒ=octdec('0'.$this->in['mod']);$ »° =0;¾şŸÇÏ;$ß¿=0;foreach($´µ as $«²•Û){$Ë÷ªÑÖ=_DIR($«²•Û['path']);¹ğ˜ÖÔ£‚”¢¢Û±ñ’±‚øİ´ºœÚ²Æ­‰ÄíıŞšÔ´½×Èàù¥“ì§¥ŸªŸüß®;if(chmod_path($Ë÷ªÑÖ,$…ŞÒ)){$ »° ++;}else{$ß¿++;}}$û‰ê=$ß¿==0?!0:!1;‰¥õ‡…‘Ü¹Îµƒ°°©ÃÑé¼û‰ºÛ·ñØÁİœùÒ¥ŸÈ­¤Ú‹İªÀáÚğ‹;$İ=$ »° .' success,'.$ß¿.' error';if(count($´µ)==0x001&& $ß¿==0){$İ=$this->L['success'];}show_json($İ,$û‰ê);}public function mkfile(){$Ù”†=BASIC_PATH.'static/others/newfile-tpl/';space_size_use_check();Ö«‰©Ğ¨òşÌÍŠ;$÷Ê='skip';if(isset($this->in['repeat_type'])){$÷Ê=$this->in['repeat_type'];}$¼šòÊ=rtrim($this->path,'/');$¼šòÊ=get_filename_auto($¼šòÊ,'',$÷Ê);Ñ‘ˆŞ——ííÃö˜•Ÿ‹”ìÙ;if(@touch($¼šòÊ)){chmod_path($¼šòÊ,0777);if(isset($this->in['content'])){file_put_contents($¼šòÊ,$this->in['content']);}else{$Ñ=get_path_ext($¼šòÊ);$§¥¥Á˜=$Ù”†.'newfile.'.$Ñ;if(file_exists($§¥¥Á˜)){$¹–‰Œ¨=file_get_contents($§¥¥Á˜);file_put_contents($¼šòÊ,$¹–‰Œ¨);}}space_size_use_change($¼šòÊ);show_json($this->L['create_success'],!0,_DIR_OUT(iconv_app($¼šòÊ)));}else{show_json($this->L['create_error'],!1);}}public function mkdir(){space_size_use_check();$ô¬='skip';†ŒĞ›øª¹“û£º¢Éü»º·ÑÃÃúêØƒ©‡÷Õ÷ä›şğëšê—Ôı”÷¹¶Á¶òüî;if(isset($this->in['repeat_type'])){$ô¬=$this->in['repeat_type'];}$Á²À=rtrim($this->path,'/');$Á²À=get_filename_auto($Á²À,'',$ô¬);if(mk_dir($Á²À,0777)){chmod_path($Á²À,0777);show_json($this->L['create_success'],!0,_DIR_OUT(iconv_app($Á²À)));}else{show_json($this->L['create_error'],!1);}}public function pathRname(){$Ã=_DIR($this->in['rname_to']);­Œ¡É‹“µ¦şÍú;if(file_exist_case($Ã)){show_json($this->L['name_isexists'],!1);}if(@rename($this->path,$Ã)){show_json($this->L['rname_success'],!0,_DIR_OUT(iconv_app($Ã)));}else{show_json($this->L['no_permission_write_all'],!1);}}public function search(){if(!isset($this->in['search']))show_json($this->L['please_inpute_search_words'],!1);$áó·™µ=intval($this->in['is_content']);İÑô“¢×;$°”§½¶=intval($this->in['is_case']);§ïÉôëÆ×ßşğ•íüÈËÏ¾Üãàú»Ú¬Ï‚é‡ò³Ñ›¤›â;$ïáØ†Ğ=trim($this->in['ext']);§ù‹ïõÆÊ¢—ÍŒÁ¿ï;if($GLOBALS['path_type']==KOD_USER_SHARE&& strstr($this->path,KOD_USER_SHARE)){show_json($this->L['path_cannot_search'],!1);}$ã‹ìô=path_search($this->path,iconv_system(rawurldecode($this->in['search'])),$áó·™µ,$ïáØ†Ğ,$°”§½¶);show_json(_DIR_OUT($ã‹ìô));Ğ¯ë¡†¼¾®Ë¹¹¼¯ˆÑ˜ÕŞ·—Ÿ§óƒ³áø¢·ŞòæË•íˆÔœÔÖ‘¾×™‘ğïï¨ˆĞü“…;}public function pathList(){$Œ§—ê=$this->in['path'];if($Œ§—ê=="")$Œ§—ê='/';$¶±ì¿†=$this->path($this->path);if($this->path== MYHOME|| $this->path==HOME){$this->_self_root_load($¶±ì¿†['folderlist']);}if($¶±ì¿†['info']['path_type']==KOD_GROUP_PATH&& !strstr(trim(_DIR_CLEAR($this->in['path']),'/'),'/')){$this->_self_group_load($¶±ì¿†['folderlist']);}$¶±ì¿†['user_space']=$this->user['config'];show_json($¶±ì¿†);}public function treeList(){$á=$this->in['app'];if(isset($this->in['type'])&& $this->in['type']=='init'){$this->_tree_init($á);}switch(trim(rawurldecode($this->in['path']))){case KOD_USER_FAV:show_json($this->_tree_fav(),!0);break;case KOD_GROUP_ROOT_SELF:show_json($this->_group_self(),!0);break;case KOD_GROUP_ROOT_ALL:show_json($this->_group_tree('1'),!0);break;default:break;}if((isset($this->in['tree_icon'])&& $this->in['tree_icon']!='groupPublic')&& !strstr(trim(rawurldecode($this->in['path']),'/'),'/')&&($GLOBALS['path_type']==KOD_GROUP_PATH|| $GLOBALS['path_type']==KOD_GROUP_SHARE)){$¹Àä«=$this->_group_tree($GLOBALS['path_id']);show_json($¹Àä«,!0);return;}$ÕÔ=_DIR($this->in['path']);if(!is_readable($ÕÔ))show_json($this->L['no_permission_read'],!1);$ä¦¶=($á=='editor'?!0:!1);…Ó­ïï­§¡;$¹Àä«=$this->path($ÕÔ,$ä¦¶,!0);function sort_by_key($¨¥û½‡,$‘Á){if($¨¥û½‡['name']==$‘Á['name'])return 0;return($¨¥û½‡['name']>$‘Á['name'])?0x001:-0x001;}usort($¹Àä«['folderlist'],"sort_by_key");–ÍÂÏ²è‡«•°èË¡ØøÈú”°£º­àÂĞò…µêòË¸¶œë £—µÁÈŸêø‡´óœä—×’øšãì ™×“å‘Êƒüê§”¡éİÁ÷Èºşü¯œâ;usort($¹Àä«['filelist'],"sort_by_key");ÀÙ­¯ó†ÃÚ—İ”ù†©œïˆİçĞ™çÎÈ…²ø¨Ğ‰ƒş¸÷…üÒœ‹±±†¸Ú¢¨â€‘´™ø„áı¶ñ÷ßÃ‚âÂºÛÇ·®äÃà–É™ñëÂÕìÓŠ‡Í;if($ÕÔ==MYHOME|| $ÕÔ==HOME){}if($á=='editor'){$é=array_merge($¹Àä«['folderlist'],$¹Àä«['filelist']);show_json($é,!0);}else{show_json($¹Àä«['folderlist'],!0);}}private function _self_group_load(&$ÆÜÄ){foreach($ÆÜÄ as $ Æ=>$ã){if($ã['name']=='share'){$ÆÜÄ[$ Æ]=array('name' =>$this->L['group_share'],'menuType' =>"menufolder folderBox",'ext' =>"folder_share",'isParent' =>!0,'is_readable' =>!0,'is_writeable' =>!0,'path' =>KOD_GROUP_PATH.':'.$GLOBALS['path_id'].'/share/','type' =>'folder','open' =>!1,'isParent' =>!1);break;}}$ÆÜÄ=array_values($ÆÜÄ);}private function _self_root_load(&$«º•‘ş){foreach($«º•‘ş as $§È‘šµ=>$ï£§ú){if($ï£§ú['name']=='share'){$«º•‘ş[$§È‘šµ]=array('name' =>$this->L['my_share'],'menuType' =>"menuTreeUser",'ext' =>"folder_share",'isParent' =>!0,'is_readable' =>!0,'is_writeable' =>!0,'path' =>KOD_USER_SHARE.':'.$this->user["user_id"].'/','type' =>'folder','open' =>!1,'isParent' =>!1);break;}}$«º•‘ş=array_values($«º•‘ş);if($this->config['user']['recycle_open']=="1"){}}private function _tree_fav(){$Š•ÂĞñ=($this->in['app']=='editor'?!0:!1);$“Î‚öÑ=new fileCache(USER.'data/fav.php');ş´Œõ;$Õ‡ö‹=$“Î‚öÑ->get();ƒâÚøìï»¾âÃ¶õ“¹íå¢‘ò¡Æş˜¤ÔŸ›àú„‘;$æë÷ÔÛ=array();$GLOBALS['path_from_auth_check']=!0;foreach($Õ‡ö‹ as $øÊµ=>$…){$ò¨=path_haschildren(_DIR($…['path']),$Š•ÂĞñ);if(!isset($…['type'])){$…['type']='folder';}if(in_array($…['type'],array('group'))){$ò¨=!0;}$Êüæâ¡=array('name' =>$…['name'],'ext' =>$…['ext'],'menuType' =>"menuTreeFav",'path' =>$…['path'],'type' =>$…['type'],'open' =>!1,'isParent' =>$ò¨);if(isset($…['type'])&& $…['type']!='folder'){$Êüæâ¡['ext']=$…['type'];}$æë÷ÔÛ[]=$Êüæâ¡;}$GLOBALS['path_from_auth_check']=!1;return $æë÷ÔÛ;}private function _tree_init($ıÁ){if($ıÁ=='editor' && isset($this->in['project'])){$ü©=$this->path(_DIR($this->in['project']),!0,!0);$õı=array_merge($ü©['folderlist'],$ü©['filelist']);$«’·¥İ=array(array('name'=> get_path_this($this->in['project']),'children' =>$õı,'menuType' =>"menuTreeRoot",'ext' =>"folder",'path' =>$this->in['project'],'type' =>'folder','open' =>!0,'isParent' =>count($õı)>0?!0:!1));show_json($«’·¥İ);return;}$³â’¦‹=($ıÁ=='editor'?!0:!1);$ÕÅ=$this->_tree_fav($ıÁ);±¼¥Ï»çş¸‘›¯“Û¢Ë‚€¹µãÌÜî–êÅÜßşÄ‘¼êá÷Òà±ãûá;$½–Û¿=KOD_GROUP_PATH.':1/';if(system_member::user_auth_group(0x001)==!1){$½–Û¿=KOD_GROUP_SHARE.':1/';}$ô=$this->path(_DIR($½–Û¿),$³â’¦‹,!0);$ãÑéù¼=$this->path(_DIR(MYHOME),$³â’¦‹,!0);if($³â’¦‹){$°›¯=array_merge($ãÑéù¼['folderlist'],$ãÑéù¼['filelist']);$‡‘äÙò=array_merge($ô['folderlist'],$ô['filelist']);}else{$°›¯=$ãÑéù¼['folderlist'];$‡‘äÙò=$ô['folderlist'];}$¾=count($°›¯)>0?!0:!1;$ø²€¶É=count($‡‘äÙò)>0?!0:!1;óëÛ×¾ÆÒû÷©š¨ÅÉ•ÌÛú§Î’å¿‹™¿Ââ¹Ã‘¦ éäç¼áßæûˆ­Åú¢™¢ñ¬ˆ±·¡ğú…´É¡Ûé‹ÀÒÈ£²¯;$«’·¥İ=array('webroot'=>array(),'fav'=>array('name' =>$this->L['fav'],'ext' =>"treeFav",'menuType' =>"menuTreeFavRoot",'children' =>$ÕÅ,'path' =>KOD_USER_FAV,'type' =>'folder','open' =>!0,'isParent' =>count($ÕÅ)>0?!0:!1),'my_home'=>array('name' =>$this->L['root_path'],'menuType' =>"menuTreeRoot",'ext' =>"treeSelf",'children' =>$°›¯,'path' =>MYHOME,'type' =>'folder','open' =>!0,'isParent' =>$¾),'public'=>array('name' =>$this->L['public_path'],'menuType' =>"menuTreeGroupRoot",'ext' =>"groupPublic",'children' =>$‡‘äÙò,'path' =>$½–Û¿,'type' =>'folder','open' =>!0,'isParent' =>$ø²€¶É),'my_group'=>array('name' =>$this->L['my_kod_group'],'menuType' =>"menuTreeGroupRoot",'ext' =>"groupSelfRoot",'children' =>$this->_group_self(),'path' =>KOD_GROUP_ROOT_SELF,'type' =>'folder','open' =>!0,'isParent' =>!0),'group'=>array('name' =>$this->L['kod_group'],'menuType' =>"menuTreeGroupRoot",'ext' =>"groupRoot",'children' =>$this->_group_tree('1'),'path' =>KOD_GROUP_ROOT_ALL,'type' =>'folder','open' =>!0,'isParent' =>!0),);if($ıÁ=='editor'){unset($«’·¥İ['my_group']);unset($«’·¥İ['group']);unset($«’·¥İ['public']);if($GLOBALS['is_root']==0x001){$İåÙ=$this->path(_DIR(WEB_ROOT),$³â’¦‹,!0);$ˆòúú=array_merge($İåÙ['folderlist'],$İåÙ['filelist']);$«’·¥İ['webroot']=array('name' =>"webroot",'menuType' =>"menuTreeRoot",'ext' =>"folder",'children' =>$ˆòúú,'path' =>WEB_ROOT,'type' =>'folder','open' =>!0,'isParent' =>!0);}}else{unset($«’·¥İ['webroot']);}$¬=array();Ò«­ˆõÎãßÚ;foreach($«’·¥İ as $²£=>$åÓè){if(count($åÓè['children'])<0x001&& in_array($²£,array('my_group','group'))){continue;}$¬[]=$åÓè;}show_json($¬);}private function _group_tree($Ïú){$Ø=system_group::load_data();Š€æ±ºİÌÃ;$œ¨³ö=$Ø->get(array('parent_id',$Ïú));—Íîî Ñé«ªØ±şç¼€Îí;$ŠË=$this->_make_node_list($œ¨³ö);ˆõÓşÄ»šÜ‰‰İ÷©°âÕÛ;$‡Ú¤=array();±ùııåËíÂğí‡­ˆã¶’Â¯»ò’’ÎÏ™©óÜ…çşæä³«ÓõÁüÊÊáÜ¤±™—Ä«æ”Ä‘ˆ¢–ğ²–Ø¿úŒ;if($Ïú!='1'){$Ï‚ˆ’€=system_member::get_user_at_group($Ïú);foreach($Ï‚ˆ’€ as $ÜáÔ¹=>$†){$Êş†='user';if($†['user_id']==$this->user['user_id']){$Êş†='userSelf';}$‡Ú¤[]=array('name' =>$†['name'],'menuType' =>"menuTreeUser",'ext' =>$Êş†,'path' =>KOD_USER_SHARE.':'.$†['user_id'].'/','type' =>'folder','open' =>!1,'isParent' =>!1);}}$Ã—èæ=array_merge($ŠË,$‡Ú¤);return $Ã—èæ;³ÙÀ¿ÄÂÍ£Â¡€¥öº¬;}private function _group_self(){$ËÉŒÑ=array();foreach($this->user['group_info'] as $é’¸˜=>$ÑÜ «){if($é’¸˜=='1')continue;$ğ®£¾=system_group::get_info($é’¸˜);ÒŒ×¸Ö›„ ¨ÖÉùÀÜ²ØÉ„¶ê°ÔË¡„îàÖÕÂ©á›¶›ñÒŸ’úõÜô·º§…¬ÇïÜœ»ı¡«ß÷¢¡ã;if($ğ®£¾){$ËÉŒÑ[]=$ğ®£¾;}}return $this->_make_node_list($ËÉŒÑ);}private function _make_node_list($ş¯«Ÿ){$§– =array();if(!is_array($ş¯«Ÿ)){return $§– ;}foreach($ş¯«Ÿ as $ÚÃŞà=>$¦ĞÍÃ){$ä¹¬=KOD_GROUP_PATH;$»ÏşŸ=system_member::user_auth_group($¦ĞÍÃ['group_id']);if($»ÏşŸ==!1){$ä¹¬=KOD_GROUP_SHARE;$½…='groupGuest';}else if($»ÏşŸ=='read'){$½…='groupSelf';}else{$½…='groupSelfOwner';}$¬Õ=!0;$È¤=system_member::get_user_at_group($¦ĞÍÃ['group_id']);Ş;if(count($È¤)==0&& $¦ĞÍÃ['children']==''){$¬Õ=!1;}$§– []=array('name' =>$¦ĞÍÃ['name'],'type' =>'folder','path' =>$ä¹¬.':'.$¦ĞÍÃ['group_id'].'/','ext' =>$½…,'tree_icon' =>$½…,'menuType' =>"menuTreeGroup",'isParent' =>$¬Õ);}return $§– ;Ëï½˜ÔöÄ²²”²Ò¢‹òà;}public function pathDelete(){$²=json_decode($this->in['list'],!0);…†®ƒ“;if(!is_dir(USER_RECYCLE)){mk_dir(USER_RECYCLE);}$á‘Ş=$this->config['user']['recycle_open'];if(!path_writeable(USER_RECYCLE)){$á‘Ş='0';}$Ü=0;$Ïô¤Ç=0;foreach($² as $úÏŠÎ){$–ÁÓ§ô=_DIR($úÏŠÎ['path']);if($á‘Ş!="1" || $GLOBALS['path_type']==KOD_GROUP_SHARE|| $GLOBALS['path_type']==KOD_GROUP_PATH|| $GLOBALS['path_type']==KOD_USER_RECYCLE){if($úÏŠÎ['type']=='folder'){if(del_dir($–ÁÓ§ô))$Ü++;else $Ïô¤Ç++;ë­¿€à¡‘À³î„ä´Ì ŒÈğ——ã­Ù¸ÔÏïºÎ¬¦üë§İ¸Â¨®Æã”®ï;}else{if(del_file($–ÁÓ§ô))$Ü++;else $Ïô¤Ç++;ôƒµ;}space_size_use_reset();Ÿ¬ÆîÙ;}else{$ëÆ•ÊÕ=USER_RECYCLE.get_path_this($–ÁÓ§ô);ö™ß…üó³íÑÓõÇ×«—”·;$ëÆ•ÊÕ=get_filename_auto($ëÆ•ÊÕ,date('-h:i:s'),'folder_rename');if(@rename($–ÁÓ§ô,$ëÆ•ÊÕ)){$Ü++;}else{$Ïô¤Ç++;}}}$ı§œ=$Ïô¤Ç==0?!0:!1;Ş¹ÏÈÑÆá±Ìß¦Í÷ÔÄ¿­;$×Â¨„=$Ü.' success,'.$Ïô¤Ç.' error';if($Ïô¤Ç==0){$×Â¨„=$this->L['remove_success'];}show_json($×Â¨„,$ı§œ);}private function clearTemp(){$¡“Ê=USER_TEMP;$ª=@filemtime($¡“Ê);if(time()-$ª>0x0258){del_dir($¡“Ê);mk_dir($¡“Ê);}}public function pathDeleteRecycle(){if(!isset($this->in['list'])){if(!del_dir(USER_RECYCLE)){show_json($this->L['remove_fali'],!1);}else{mkdir(USER_RECYCLE);$this->clearTemp();space_size_use_reset();show_json($this->L['recycle_clear_success'],!0);}}$ò¬Õ=json_decode($this->in['list'],!0);èúƒàÏÇ¡ı¸øÀá‰Å‰ÀæœŒì±¶«—ª¼Ã€€½µè¸¹Ê‰ì‡ºå;$ï=0;$ôÃ=0;foreach($ò¬Õ as $ôôŒ){$ËĞ=_DIR($ôôŒ['path']);if($ôôŒ['type']=='folder'){if(del_dir($ËĞ))$ï++;else $ôÃ++;µÆÏíÖËÔŸèÄ­;}else{if(del_file($ËĞ))$ï++;else $ôÃ++;}}space_size_use_reset();´…Èª”ÕÉß¦é­µ¿ãûÎäËŞÓ£«©;if(count($ò¬Õ)==0x001){if($ï)show_json($this->L['remove_success']);else show_json($this->L['remove_fali'],!1);ï¤ä“÷š˜ÁÄ¬—¾øºó¸ğ‡;}else{$½=$ôÃ==0?!0:!1;“‚¤§ğ”ÌÖ¨ÅñÀ‡¶íŸÆûŞ¿·ÒøÖÃÛè´âû·‡¤¨œñ€Ä·ñ†¾©ôŞïñ½°ª‘©Õ;show_json($this->L['remove_success'].$ï.'success,'.$ôÃ.'error',$½);}}public function pathCopy(){session_start();“º‘ÊÂµóŞ§ó¤ß;$«¡=json_decode($this->in['list'],!0);»°¾ÌÚÀ¢†ù›±µ¬û÷;$_SESSION['path_copy']=json_encode($«¡);‹äüêÊ¨ŠÚÊˆÚİÄ‹‘åİ´ìû¯ˆ®äµ«İ˜œµ¤²ÌÛš¨¦¢ƒ…ç¢øô€®áüİé¬Ã ×¡¸ô×;$_SESSION['path_copy_type']='copy';ìÃæˆëªï’;show_json($this->L['copy_success'],ture,$_SESSION);}public function pathCute(){session_start();ó¶»Õ³;$Àà=json_decode($this->in['list'],!0);€š®×÷¥âåéÊíÖ×™Æê¬Å¡¹¹×ôŒĞìí²¦îÌÔÇÅ;foreach($Àà as $««äõ™=>&$Î²ƒ){$Î²ƒ['path']=rawurldecode($Î²ƒ['path']);_DIR($Î²ƒ['path']);™„³”¿Ÿå­™Óüå©Ä«¤ğ×ŠçñÇ¶¥Ëğ…•Ì™­®ÁÌ•îÚ®ÂØ•;}$_SESSION['path_copy']=json_encode($Àà);‘™œö‹ã®°¯Ÿ¶ÅìÔß;$_SESSION['path_copy_type']='cute';°Ğ;show_json($this->L['cute_success']);}public function pathCuteDrag(){$¬Ó=json_decode($this->in['list'],!0);Î£ªà²ÄıªĞáØ;$’=$this->path;å¸Ô‘Ç…áë¤À‡“©Ö·Ô¸ê™¶•é™íë¬ç¤…Í²½£;$†¨¥=$GLOBALS['path_type'];³ÕÈÜ¬€²åêÌœ€·¶î¤âÖÈè¥û¦È¿­ñ;$ ÀšÓ=$GLOBALS['path_id'];if(!path_writeable($this->path))show_json($this->L['no_permission_write'],!1);$±Ãâä=0;$±ÆÎè=0;à•ÖÉ»Ò;$„“öø=array();foreach($¬Ó as $””Í){$Å‘Ú«»=_DIR($””Í['path']);$‚øÆ€=get_path_this($Å‘Ú«»);$àÍ««=get_filename_auto($’.$‚øÆ€,'',$this->config['user']['file_repeat']);if($ ÀšÓ!=$GLOBALS['path_id']){space_size_use_check();}if(move_path($Å‘Ú«»,$àÍ««,'',$this->config['user']['file_repeat'])){$±Ãâä++;if($ ÀšÓ!=$GLOBALS['path_id']){space_size_use_change($àÍ««);space_size_use_change($àÍ««,!1,$†¨¥,$ ÀšÓ);}$„“öø[]=_DIR_OUT(iconv_app($àÍ««));}else{$±ÆÎè++;’»…Œ;}}$½¡‹™=$±ÆÎè==0?!0:!1;‚ÙŸŞÜ˜¦ÜĞú¾Ÿ§ê©¦ˆ·¹Ä½ÆÀúçĞ‡¨;$õª=$±Ãâä.' success,'.$±ÆÎè.' error';Û®°;if($±ÆÎè==0){$õª=$this->L['success'];}show_json($õª,$½¡‹™,$„“öø);}public function pathCopyDrag(){$€¬÷=json_decode($this->in['list'],!0);$ãÈúë=$this->path;$±¾û=$GLOBALS['path_type'];ÃÁåëçÛ–æñ¡Ã Ñü ıõÀÒÙŠÍÆ‹ƒ÷Êşê†â®ÇÈ›°¥²——;$Û¸¦Ù=$GLOBALS['path_id'];›÷ª¥Æñ°ÉêûÈÕ‚¬…Êô¡ú›Ó“³;space_size_use_check();if(!path_writeable($this->path))show_json($this->L['no_permission_write'],!1);$ëÎÈÆô=0;$íÄ‡´=0;$ı¡´=array();óüéû…ò¸›ş¥êÈëàáÍÎ¦Ô„Ü‚şÁÊö÷¾ôù©“õ®‡†ç;foreach($€¬÷ as $…){$Í=_DIR($…['path']);È½ÖÁ´¬Ä´í¬æÎ¡á÷µ×§¼ŞŞäì³˜Ûãáš»;$Û=get_path_this($Í);¥›°Òƒşóä÷©½;$æ=get_filename_auto($ãÈúë.$Û,'',$this->config['user']['file_repeat']);if($this->in['filename_auto']==0x001&& trim($æ,'/')==trim($Í,'/')){$æ=get_filename_auto($ãÈúë.$Û,'','folder_rename');}if(copy_dir($Í,$æ)){$ëÎÈÆô++;space_size_use_change($Û);$ı¡´[]=_DIR_OUT(iconv_app($æ));}else{$íÄ‡´++;}}$‚Í´=$íÄ‡´==0?!0:!1;$›É«Ö=$ëÎÈÆô.' success,'.$íÄ‡´.' error';ö©î“ÙÁ—Ùµ;if($íÄ‡´==0){$›É«Ö=$this->L['success'];}show_json($›É«Ö,$‚Í´,$ı¡´);}public function clipboard(){$Òß»ñÇ=json_decode($_SESSION['path_copy'],!0);ÛğÂ’;if(!$Òß»ñÇ){$Òß»ñÇ=array();}show_json($Òß»ñÇ,!0,$_SESSION['path_copy_type']);}public function pathPast(){if(!isset($_SESSION['path_copy'])){show_json($this->L['clipboard_null'],!1,array());}$Ó­¢ş=$this->path;session_start();$‡Îä°½='';;$¶¸—=array();¡Íìü¾¯—ƒ¾¹ƒÄ§Š“Œ»Ñ„ÆÑ”¬‰¡ä é;$Œİë‰œ=json_decode($_SESSION['path_copy'],!0);$´ =$_SESSION['path_copy_type'];–®²¢é„¦°Ö»ÜßÜÂ€ÇÒ€Ó±ëİÎ‰;$ƒ©ÒñÍ=$GLOBALS['path_type'];£«å¨Ò—şôßë·à³‹à;$¼=$GLOBALS['path_id'];Öß²‚Î£;if(!path_writeable($Ó­¢ş))show_json($this->L['no_permission_write'],!1,$¶¸—);$GLOBALS['path_from_auth_check']=!0;$Çµ±=count($Œİë‰œ);ï—¾Ğ„ö±·‚“;if($Çµ±==0){show_json($this->L['clipboard_null'],!1,$¶¸—);}for($¿à§=0;$¿à§<$Çµ±;$¿à§++){$¸‡Û=_DIR($Œİë‰œ[$¿à§]['path']);_DIR($this->in['path']);$ˆİèÓ=get_path_this($¸‡Û);$†—=iconv_app($ˆİèÓ);if(!file_exists($¸‡Û)){$‡Îä°½.= "<li>{$†—}".$this->L['copy_not_exists']."</li>";continue;ØÃ†‹û‰;}if($Œİë‰œ[$¿à§]['type']=='folder'){if($¸‡Û==substr($Ó­¢ş,0,strlen($¸‡Û))){$‡Îä°½.="<em style='color:#fff;'>{$†—}".$this->L['current_has_parent']."</em>";continue;}}$€ä•=get_filename_auto($Ó­¢ş.$ˆİèÓ,'',$this->config['user']['file_repeat']);$ˆİèÓ=get_path_this($€ä•);¦Ïú„¸Ïª×ÖÂ€§Ê¿¶£„½®€ÆÍ½Í¢¦†˜øµçôº¡Ååøœ¨øÄò¹ú—½¸Æ¾€”û‘âŸ·è®Ğâä¹ØŸÚ…Ô»­Í€¡ˆû¸Åµş…;if($´ =='copy'){space_size_use_check();copy_dir($¸‡Û,$€ä•);space_size_use_change($ˆİèÓ);}else{if($¼!=$GLOBALS['path_id']){space_size_use_check();}move_path($¸‡Û,$€ä•,'',$this->config['user']['file_repeat']);if($¼!=$GLOBALS['path_id']){space_size_use_change($ˆİèÓ);space_size_use_change($ˆİèÓ,!1,$ƒ©ÒñÍ,$¼);}}$¶¸—[]=_DIR_OUT(iconv_app($€ä•));}if($´ =='copy'){$‚=$this->L['past_success'].$‡Îä°½;}else{$_SESSION['path_copy']=json_encode(array());$_SESSION['path_copy_type']='';$‚=$this->L['cute_past_success'].$‡Îä°½;}$ö¡ş=($‡Îä°½==''?!0:!1);show_json($‚,$ö¡ş,$¶¸—);Ãµ‹Õå»Úº÷‰‰÷ª’ôâ×ªâİàöß¨í‚¨ÎÓø’Š„°ßêëº¦äÄ°;}public function fileDownload(){file_put_out($this->path,!0);ÒÒ›üµøİ¬Ù†›Û¯é°¨üº­­š™šÕ¿ş›ïÜŠ²¯İÎ¬“Ç‹À¡’ÛıÁÅ¯ê;}public function fileDownloadRemove(){$é™ğ=rawurldecode(_DIR_CLEAR($this->in['path']));$é™ğ=USER_TEMP.iconv_system($é™ğ);space_size_use_change($é™ğ,!1);file_put_out($é™ğ,!0);öâæ‚––ßä;del_file($é™ğ);Ï´ÏáÍ¤Öıšç¨‹íÚ–ÉÍ Á±‡ÃÇ£¬â–Ú²Ê;}public function zipDownload(){if(!file_exists(USER_TEMP)){mkdir(USER_TEMP);}else{$•Û=path_list(USER_TEMP,!0,!1);$¹²öÉÍ=0x0e10*0x0000018;if($•Û['filelist']>=0x001){for($òØÍÎ=0;$òØÍÎ<count($•Û['filelist']);$òØÍÎ++){$˜œÙÍ=$•Û['filelist'][$òØÍÎ]['mtime'];if(time()-$˜œÙÍ>$¹²öÉÍ){del_file($•Û['filelist'][$òØÍÎ]['path'].$•Û['filelist'][$òØÍÎ]['name']);}}}}$=$this->zip(USER_TEMP);show_json($this->L['zip_success'],!0,get_path_this($));}public function zip($Ã™×=''){load_class('pclzip');ini_set('memory_limit','2028M');áşÁ›²¸å€˜ØØå§ÈşÃØØ’ğ;$¨¨·ëÂ=json_decode($this->in['list'],!0);$=count($¨¨·ëÂ);for($ğ²•=0;$ğ²•<$;$ğ²•++){$¨¨·ëÂ[$ğ²•]['path']=rtrim(_DIR($¨¨·ëÂ[$ğ²•]['path']),'/');åæÌ¿Íó‰Ì¸â¦ËÓœóüÓà¿ãëÎ–ÀÀÉÕÎ¯¤Â–ŒÕÚƒß¨¼ÂÎˆ—ëü”ÀİÓ¤Ê£º‹ä„á´´;}$ö=$Ã™×;¡î;if($Ã™×==''){$ö=get_path_father($¨¨·ëÂ[0]['path']);}if(!is_writeable($ö)){show_json($this->L['no_permission_write'],!1);}if($==0x001){$=get_path_this($¨¨·ëÂ[0]['path']);}else{$=get_path_this(get_path_father($¨¨·ëÂ[0]['path']));}$Ç=$ö.$.'.zip';$Ç=get_filename_auto($Ç,'',$this->config['user']['file_repeat']);ÚÓÌï”«Ä¸õçò‚Í÷ã‚¬êùöş™îŒš‡ÔŞí¤ºÂñªÖî”×ƒ–¥úú¨¨æ¢ æ;space_size_use_check();$Õ±Ô=array();Ì«í™;for($ğ²•=0;$ğ²•<$;$ğ²•++){if(file_exists($¨¨·ëÂ[$ğ²•]['path'])){$Õ±Ô[]=$¨¨·ëÂ[$ğ²•]['path'];}}if(count($Õ±Ô)==0){show_json($this->L['not_exists'],!1);}$ºˆôÏ=new PclZip($Ç);foreach($Õ±Ô as $÷æ†ó=>$®œÉÑ){$±öö=_DIR_CLEAR(get_path_father($®œÉÑ));if($÷æ†ó==0){$Ëå=$ºˆôÏ->create($®œÉÑ,PCLZIP_OPT_REMOVE_PATH,$±öö,PCLZIP_CB_PRE_FILE_NAME,'zip_pre_name');continue;}$Ëå=$ºˆôÏ->add($®œÉÑ,PCLZIP_OPT_REMOVE_PATH,$±öö,PCLZIP_CB_PRE_FILE_NAME,'zip_pre_name');}space_size_use_change($Ç);if($Ëå==0){show_json("Create error!",!1);}$íÁ÷‡=$this->L['zip_success'].$this->L['size'].":".size_format(filesize($Ç));if($Ã™×==''){show_json($íÁ÷‡,!0,_DIR_OUT(iconv_app($Ç)));}else{return iconv_app($Ç);}}public function unzip(){ini_set('memory_limit','2028M');$œƒ=$this->path;ö‰Ë¦¥–øâÇïÙÏ™¦µÈ¦è£•ª;$œÑ=get_path_this($œƒ);Ñ„»–ˆ½³Ÿ·–ç§ğ¸Á—îŠ¾×­Ó‚ÉğÓ™Âë½Ç§ÔÔ;$œÑ=substr($œÑ,0,strrpos($œÑ,'.'));$ˆ=get_path_ext($œƒ);¸ñğ³¨ß¾æ·ì»º¶¬;$ËÑ¼Š=get_path_father($œƒ).$œÑ;if(isset($this->in['to_this'])){$ËÑ¼Š=get_path_father($œƒ);}if(isset($this->in['path_to'])){$ËÑ¼Š=_DIR($this->in['path_to']);}if(!is_writeable(get_path_father($œƒ))){show_json($this->L['no_permission_write'],!1);}space_size_use_check();load_class('pclzip');–ñ÷æ¼—Ÿ¯¨‘ãĞñ¢¸ªôäÆ¡ó—íÆÓ÷à¹×ĞÏÊÈ¶‡àÖ¶‰è›ÚÚ½”†Í‰ê”«ß¬™¦’‡ºê×Šµ¡Á½‚;$æ=new PclZip($œƒ);â›…Î°°®ÜÊÔİÜÜ˜Çµ£ıÖä»Ùü°æşÀÎÜÊ¿«ÏÛ€½¸Ê“—¨ï¯ğ¥Óîü¸«×¶Ü¾µ’­×Ò;$¨á´¨=$æ->extract(PCLZIP_OPT_PATH,$ËÑ¼Š,PCLZIP_OPT_SET_CHMOD,0777,PCLZIP_CB_PRE_FILE_NAME,'unzip_pre_name',PCLZIP_CB_PRE_EXTRACT,"check_ext_unzip",PCLZIP_OPT_REPLACE_NEWER);if($¨á´¨==0){show_json("Error : ".$æ->errorInfo(!0),fasle);}else{space_size_use_change($œƒ);show_json($this->L['unzip_success']);}}public function imageRotate(){load_class('imageThumb');…£µÉ‰ıÇÁ©Ÿ÷‡Ş®¤ëÁÒÄ•«ìöà–—Î‹ÊÓ¨îŠ¶¸“;$ÕŞ=new imageThumb($this->path,'file');$å€ı‹=$ÕŞ->imgRotate($this->path,intval($this->in['rotate']));±ÔŠŸÌê¶ä¹Á°éŸ™¡Ø­ÖÙ„¶úÒúĞ©ç‘ˆšå’¹³ıï˜¸²;if($å€ı‹){show_json($this->L['success']);}else{show_json($this->L['error'],!1);}}public function image(){if(filesize($this->path)<=0x00000400*0x014|| !function_exists('imagecolorallocate')){file_put_out($this->path);return;}if(!is_dir(DATA_THUMB)){mk_dir(DATA_THUMB);}load_class('imageThumb');$Æœè=$this->path;•œ’Ë˜åé”¶“ûÈ›–®­Ğá«ÁúãóÃ«‘­Œ;$ï›å=@md5_file($Æœè);if(strlen($ï›å)<0x05){$ï›å=md5($Æœè);}$¥”=DATA_THUMB.$ï›å.'.png';if(!file_exists($¥”)){if(get_path_father($Æœè)==DATA_THUMB){$¥”=$this->path;}else{$¹Ë=new imageThumb($Æœè,'file');$¹Ë->prorate($¥”,0x0fa,0x0fa);}}if(!file_exists($¥”)|| filesize($¥”)<0x064){$¥”=$this->path;}file_put_out($¥”);}public function serverDownload(){set_time_limit(0);$”ÊÍ='download_'.$this->in['uuid'];¦¥à¡ŠÕå¶ç“Ã¸ƒŞ‘Ñ¶¡îğí;if($this->in['type']=='percent'){if(isset($_SESSION[$”ÊÍ])){$‚é=$_SESSION[$”ÊÍ];$Åã”ëŠ=array('uuid' =>$this->in['uuid'],'length' =>(int)$‚é['length'],'name' =>$‚é['name'],'size' =>(int)@filesize(iconv_system($‚é['path'])),'time' =>mtime());show_json($Åã”ëŠ);}else{show_json('',!1);}}else if($this->in['type']=='remove'){del_file($_SESSION[$”ÊÍ]['path']);unset($_SESSION[$”ÊÍ]);show_json('',!1);}$”ËóÊ=_DIR($this->in['save_path']);if(!is_writeable($”ËóÊ)){show_json($this->L['no_permission_write'],!1);}$ˆë=rawurldecode($this->in['url']);$í=url_header($ˆë);if(!$í){show_json($this->L['download_error_exists'],!1);}$”ËóÊ=$”ËóÊ.$í['name'];if(!checkExt($”ËóÊ)){$”ËóÊ=_DIR($this->in['save_path']).date('-h:i:s').'.txt';}space_size_use_check();$”ËóÊ=get_filename_auto(iconv_system($”ËóÊ),'',$this->config['user']['file_repeat']);$ÜÔËÅ=$”ËóÊ.'.downloading';session_start();ÕãÔ¹øÀÃîÎØ»;$_SESSION[$”ÊÍ]=array('length'=> $í['length'],'path' =>$ÜÔËÅ,'name' =>get_path_this($”ËóÊ));Ë²Û× æôÄÉ»‘ÇûşÕÒã«ÜëÑÌ»ª‰€Î÷;session_write_close();£¢»™¿âú;if(file_download_this($ˆë,$ÜÔËÅ,$í['length'])){session_start();unset($_SESSION[$”ÊÍ]);session_write_close();if(@rename($ÜÔËÅ,$”ËóÊ)){$ò=get_path_this(iconv_app($”ËóÊ));space_size_use_change($”ËóÊ);show_json($this->L['download_success'],!0,_DIR_OUT(iconv_app($”ËóÊ)));}else{show_json($this->L['download_error_create'],!1);}}else{session_start();šáÖÅî³²ÀîëŠîºƒº¼×İ;unset($_SESSION[$”ÊÍ]);Ÿ•Ú›§ÎŞ·Áøš˜¾‰ÌğÊÍß·ØÎñ;session_write_close();´èÈà®Ş;show_json($this->L['download_error_create'],!1);}}public function officeView(){if(!file_exists($this->path)){show_tips($this->L['not_exists']);}$†‹©=get_path_ext($this->path);$Ì¢Ø=_make_file_proxy($this->path);²Ó®´åÚ„×·‡ëö–µØÄ”•› ¸ÙíÛ²Ó½•‡‘Ã‰ÆªãÊƒ›ØŠˆĞ¡½©æÒ¿õíß¯ÇÎ‹ú¢É‘;if(defined("OFFICE_KOD_SERVER")){$ÛÕ=APPHOST.'index.php?explorer/fileProxy&path='.$this->in['path'];$¢€—='&appMode=edit&access_token='.session_id();if(OFFICE_KOD_ACTION=='read'){$¢€—='&appMode=view';$ÛÕ=_make_file_proxy($this->path);}$ƒ³Æ»=$_SESSION['kod_user'];$¯=rand_string(0x0a);Ì‚ºá¼ƒ±ÈşÔ;$=OFFICE_KOD_SERVER.rawurlencode($ÛÕ).'&lang='.LANGUAGE_TYPE.'&appType=desktop'.$¢€—.'&file_time='.@filemtime($this->path).'&user_id='.$ƒ³Æ»['user_id'].'&user_name='.$ƒ³Æ»['name'].'&app_id='.OFFICE_KOD_APP_ID.'&app_s='.$¯.'&app_v='.md5($¯.OFFICE_KOD_APP_KEY);²‘åÊşèıÅöºİ§´ ½£Ë¼…‰¿·Ñ¿ŒäÏ‹Ó¶¾åŠå†‰«ıÃŠ¦÷«äøÎ°µÔ¹õŒŒµ˜ğ†¤Å¼ã¬Ùí’àö¾ßº;header("location:".$);ôê¬Äœâ;exit;}if(file_exists(PLUGIN_DIR.'officeView')){if(isset($_GET['is_edit'])|| !isset($this->config['settings']['office_server_doc2pdf'])){include(PLUGIN_DIR.'officeView/index.php');}else{include(PLUGIN_DIR.'officeView/flexpapper.php');}exit;}$Ù¦â=$_SERVER['HTTP_HOST'];ä›ÓÈÇ®·Ú®šïé;if(strpos(OFFICE_SERVER,'view.officeapps.live.com')===-0x001|| strstr($Ù¦â,'10.10.')|| strstr($Ù¦â,'192.168.')|| strstr($Ù¦â,'127.0.')|| !strstr($Ù¦â,'.')){$öÙâ=$this->L['unknow_file_office'];show_tips($öÙâ);}else{$=OFFICE_SERVER.rawurlencode($Ì¢Ø);header("location:".$);}}public function officeSave(){$€®=_DIR($this->in['path']);if(isset($this->in['from_activex'])){if($_FILES["file"]["error"]>0){echo "Return Code: ".$_FILES["file"]["error"];}else{move_uploaded_file($_FILES["file"]["tmp_name"],$this->path);echo 'succeed';}exit;}if(!is_writeable($€®)){$this->json_putout(array('error'=>'no_permission_write'));}if(($ˆß¹˜=file_get_contents('php://input'))===!1){$this->json_putout(array('error'=>'Bad Request'));}$®=json_decode($ˆß¹˜,!0);if($®===NULL){$this->json_putout(array('error'=>'Bad Response'));}$Î=array(0=>'NotFound',0x001=>'Editing',0x0002=>'MustSave',0x00003=>'Corrupted',0x000004=>'Closed');$±†ÍÁµ=array('error'=>0,'action'=>$Î[$®["status"]]);Ë©½¦ˆÄ·ıã¿;switch($Î[$®["status"]]){case "MustSave":case "Corrupted":$±†ÍÁµ["c"]="saved";ş¬ˆ„Ö‹ÒÉ¼Ù˜ı€°®ÌÚìòçõ;$±†ÍÁµ['status']='0';if(file_download_this($®["url"],$€®)){$±†ÍÁµ['status']='success';}break;default:break;Øí•öÆ”£Ï™úÚëÄ˜ÆÜ—Õİ;}$this->json_putout($±†ÍÁµ);£ñ‹è;}private function json_putout($–Ú){@header('Content-Type: application/json; charset==utf-8');@header('X-Robots-Tag: noindex');@header('X-Content-Type-Options: nosniff');õœĞğö½¶…”§Úñïà”Ó¼ ¼”¡Ó£üØÆÏ;echo json_encode($–Ú);exit;Ğ·¹îÉ”ƒñïõâĞ•ö¥Ñ˜áæºµŠ·Ñ‡´ÑÍõ£;}public function fileProxy(){$°=isset($this->in['download']);file_put_out($this->path,$°);øí·ïĞ‰…È®×à‘¿œÆÊÓÕÛŠîª“±±Å§­ ›Å‘ìÏ—µşï—¯³Öúˆ­˜ä·ˆ¸;}public function fileUpload(){$Àê=_DIR($this->in['upload_to']);ï‰´¶›¡†²×…£î–Ò£ìÎ;if(!is_writeable($Àê))show_json($this->in['upload_to'],!1);if($Àê=='')show_json($this->L['upload_error_big'],!1);if(strlen($this->in['fullPath'])>0x001){$šæ=_DIR_CLEAR(rawurldecode($this->in['fullPath']));$šæ=get_path_father($šæ);$šæ=iconv_system($šæ);if(mk_dir($Àê.$šæ)){$Àê=$Àê.$šæ;}}$Ò=$this->config['user']['file_repeat'];‹áöì;$ÜÓ=USER_TEMP;æš¢¾ Å®¶™Ñ¤çü¿Ï’¿®Ë;mk_dir($ÜÓ);if(!is_writeable($ÜÓ))show_json($this->L['no_permission_write'],!1);upload_chunk('file',$Àê,$ÜÓ,$Ò);}private function path_share(&$Ú§–){$íª=explode(',',$GLOBALS['path_id']);$ÄÁ”å=system_member::user_share_list($íª[0]);$œ¢•=$GLOBALS['path_id_user_share'];Û¡;foreach($ÄÁ”å as $›=>$²æáÉ){$¼ğ=_DIR(KOD_USER_SHARE.':'.$íª[0].'/'.$²æáÉ['name']);$²æáÉ['path']=$²æáÉ['name'];Œ´¦ÎÉ×©ù£ê†¶ëá×€ı¨²åŠû‡Çí¾´Ì À‚ÇÌÔçÙşâıéè´ÖËŒÖÊµ‰±À…¸‰òö;$²æáÉ['atime']='';$²æáÉ['ctime']='';Ã;$²æáÉ['mode']='';´÷ê;$²æáÉ['is_readable']=0x001;$²æáÉ['is_writable']=0x001;Äô‘ªËÛàÕ¢ÚÆ«Î½êÕêÓ;$²æáÉ['exists']=intval(file_exists($¼ğ));$²æáÉ['meta_info']='path_self_share';óÏŸÏ¹½”Ö³¦‚€ƒãÕ†±Ö²€•‘ëˆä¢„É÷š­ÇÓëÜ«Ÿ„®Ÿ‡’ô—˜¦îË§…è¸ğñ“öè¡î„Î·×»•;$²æáÉ['menuType']="menuSharePath";if(get_path_ext($²æáÉ['name'])=='oexe'){$™²ú¡=json_decode(@file_get_contents($¼ğ),!0);if(is_array($™²ú¡))$²æáÉ=array_merge($²æáÉ,$™²ú¡);}if($²æáÉ['type']=='folder'){$²æáÉ['ext']='folder';$Ú§–['folderlist'][]=$²æáÉ;}else{$Ú§–['filelist'][]=$²æáÉ;}}$Ú§–['path_read_write']='readable';Ş—¨ª¿®”ø ‡—´ıÕí…¥¦İà»á¼Õ•·öÚ¨°ºÀÙä‰ùù©;$GLOBALS['path_id_user_share']=$œ¢•;if($íª[0]==$this->user['user_id']){$Ú§–['share_list']=$ÄÁ”å;}return $Ú§–;}private function path_fav(&$ş“´í){$õ=new fileCache(USER.'data/fav.php');$Øù§í=$õ->get();$GLOBALS['path_from_auth_check']=!0;foreach($Øù§í as $ÚÏ„=>$ªé){$³ã=_DIR($ªé['path']);$åª¼ä=path_haschildren($³ã,$ñÒÖ);Š¸¦„ß”¶şŞ‘Îâ®ùÍÌ®²åŒ˜ÈıÎºÑ¦ˆ¹ó’ñš–Ñ®ÍĞß ğ›¿ÛÉñÁÖ;if(!isset($ªé['type'])){$ªé['type']='folder';}if($ªé['type']=='folder' && $ªé['ext']!='treeFav'){$åª¼ä=!0;}$ˆ¡=array('name' =>$ªé['name'],'ext' =>$ªé['ext'],'menuType' =>"menuFavPath",'atime' =>'','ctime' =>'','mode' =>'','is_readable' =>0x001,'is_writeable' =>0x001,'exists' =>intval(file_exists($³ã)),'meta_info' =>'treeFav','path' =>$ªé['path'],'type' =>$ªé['type'],'open' =>!1,'isParent' =>!1);if(strstr($ªé['path'],KOD_USER_SHARE)|| strstr($ªé['path'],KOD_USER_FAV)|| strstr($ªé['path'],KOD_GROUP_ROOT_SELF)|| strstr($ªé['path'],KOD_GROUP_ROOT_ALL)){$ˆ¡['exists']=0x001;}if(get_path_ext($ªé['name'])=='oexe'){$ÙÇã“=json_decode(@file_get_contents($³ã),!0);if(is_array($ÙÇã“))$ªé=array_merge($ªé,$ÙÇã“);}if($ªé['type']=='folder'){$ş“´í['folderlist'][]=$ˆ¡;}else{$ş“´í['filelist'][]=$ˆ¡;}}$GLOBALS['path_from_auth_check']=!1;$GLOBALS['path_type']=KOD_USER_FAV;×†Û©”»Ê†Ê;$ş“´í['path_read_write']='writeable';¯·ç‡Âº§ÊÜƒ¥¥æ¹áŞ¿¹;return $ş“´í;ÉÂÓ…ÙĞóŸö¤×ß«;}private function path_group(&$›Ò,$øÕŒŸ½){if($øÕŒŸ½==KOD_GROUP_ROOT_SELF){$‚œ‡=$this->_group_self();}else{$‚œ‡=$this->_group_tree('1');}$GLOBALS['path_from_auth_check']=!0;foreach($‚œ‡ as $ŠŸú=>$âÎÙï){$ªã=array('name' =>$âÎÙï['name'],'menuType' =>"menuGroupRoot",'atime' =>'','ctime' =>'','mode' =>'','is_readable' =>0x001,'is_writeable' =>0x001,'exists' =>0x001,'path' =>$âÎÙï['path'],'ext' =>$âÎÙï['ext'],'type' =>'folder','open' =>!1,'isParent' =>!1);¡ƒ´;if($âÎÙï['type']=='folder'){$›Ò['folderlist'][]=$ªã;}else{$›Ò['filelist'][]=$ªã;}}$GLOBALS['path_from_auth_check']=!1;$GLOBALS['path_type']=$øÕŒŸ½;$›Ò['path_read_write']='writeable';return $›Ò;}private function path($·š,$¹·şôÁ=true,$ï–=false){$¿=explode(',',$this->config['setting_system']['path_hidden']);›Ö²½ßÔÀ•’ßœ¶÷øæ°”ŞéÌŞßüĞ¥€•òù±Ê¬î«°À”‘ÜÊŠÖ±ºë‘¥¸ï†ÇíÖìíçƒàá´«¤Ö‘Õ—¥æôïñ;$¢­¸=_DIR_OUT(iconv_app($·š));if($GLOBALS['path_type']==KOD_USER_SHARE&& strpos(trim($·š,'/'),'/')===!1){$¢­¸=$·š;}$ğ¤Ù¸=array('folderlist' =>array(),'filelist' =>array(),'info' =>array(),'path_read_write' =>'not_exists','this_path' =>$¢­¸);if(!file_exists($·š)){$ğ¤Ù¸['path_read_write']="not_exists";}else if(path_writeable($·š)){$ğ¤Ù¸['path_read_write']='writeable';}else if(path_writeable($·š)){$ğ¤Ù¸['path_read_write']='readable';}else{$ğ¤Ù¸['path_read_write']='not_readable';}if($·š===!1){return $ğ¤Ù¸;}else if($GLOBALS['path_type']==KOD_USER_SHARE&& !strstr(trim($this->in['path'],'/'),'/')){$ğ¤Ù¸=$this->path_share($ğ¤Ù¸);}else if($GLOBALS['path_type']==KOD_USER_FAV){$ğ¤Ù¸=$this->path_fav($ğ¤Ù¸);}else if($GLOBALS['path_type']==KOD_GROUP_ROOT_SELF){$ğ¤Ù¸=$this->path_group($ğ¤Ù¸,$GLOBALS['path_type']);}else if($GLOBALS['path_type']==KOD_GROUP_ROOT_ALL){$ğ¤Ù¸=$this->path_group($ğ¤Ù¸,$GLOBALS['path_type']);}else{$¹·şôÁ=path_list($·š,$¹·şôÁ,!0);$ğ¤Ù¸['folderlist']=$¹·şôÁ['folderlist'];$ğ¤Ù¸['filelist']=$¹·şôÁ['filelist'];}$±=array();$‚™=array();foreach($ğ¤Ù¸['filelist'] as $ûİ‹=>$×ş){if(in_array($×ş['name'],$¿))continue;$×ş['ext']=get_path_ext($×ş['name']);³±ÁÕßùŠ³ê¯¤Â¾ÊÄØô¨ÕÒ¸áÕ ş­ŸÂí•õ ÖÌ€ĞÖ³¼†ÁáÉ­Ú¢·°;if($×ş['ext']=='oexe' && !isset($×ş['content'])){$ï’Ê‘’=iconv_system($×ş['path']);$±ÔæÆË=json_decode(@file_get_contents($ï’Ê‘’),!0);if(is_array($±ÔæÆË))$×ş=array_merge($×ş,$±ÔæÆË);}$±[]=$×ş;}foreach($ğ¤Ù¸['folderlist'] as $ûİ‹=>$×ş){if(in_array($×ş['name'],$¿))continue;$‚™[]=$×ş;}$ğ¤Ù¸['filelist']=$±;$ğ¤Ù¸['folderlist']=$‚™;$ğ¤Ù¸=_DIR_OUT($ğ¤Ù¸);¬öşÀ€»ÏÚİ‡ŒÓ÷ŸŸŠ±™»†‚Ò‰ ê‘ÚÎ»ÑÍÊ“Î†âªäê¶;$this->_role_check_info($ğ¤Ù¸);return $ğ¤Ù¸;íˆñ©ò¬áûÌÍÜ¨İ™ú«äùêñ¥ĞİÛŠÂ²ã°ºÕÚÉÉˆ¬ÆÕùÔ²¢³ÌŞ±;}private function _role_check_info(&$Ù){if(!$GLOBALS['path_type']){$Ù['info']=array("path_type"=>'',"role"=>'',"id"=>'','name'=>'');return;}$Ù['info']=array("path_type" =>$GLOBALS['path_type'],"role" =>$GLOBALS['is_root']?'owner':'guest',"id" =>$GLOBALS['path_id'],'name' =>'',);if($GLOBALS['path_type']==KOD_USER_SHARE){$GLOBALS['path_id']=explode(':',$GLOBALS['path_id']);$GLOBALS['path_id']=$GLOBALS['path_id'][0];$Ù['info']['id']=$GLOBALS['path_id'];$şî=system_member::get_info($GLOBALS['path_id']);$Ù['info']['name']=$şî['name'];if($GLOBALS['is_root']){$Ù['info']['admin_real_path']=USER_PATH.$şî['path'].'/home/';}}if($GLOBALS['path_type']==KOD_GROUP_PATH|| $GLOBALS['path_type']==KOD_GROUP_SHARE){$ÛøÁÜ=system_group::get_info($GLOBALS['path_id']);$Ù['info']['name']=$ÛøÁÜ['name'];$É³Í”ü=system_member::user_auth_group($GLOBALS['path_id']);if($É³Í”ü=='write' || $GLOBALS['is_root']){$Ù['info']['role']='owner';$Ù['group_space_use']=$ÛøÁÜ['config'];}if($GLOBALS['is_root']){$Ù['info']['admin_real_path']=GROUP_PATH.$ÛøÁÜ['path'].'/home/';}}}}