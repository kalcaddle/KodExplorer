<?php class explorer extends Controller{public $path;public $user;public function __construct(){parent::__construct();“÷îïº£¼Ë™™ıõÒ†²œ;$this->tpl=TEMPLATE.'explorer/';$this->user=$_SESSION['kod_user'];if(isset($this->in['path'])){$this->path=_DIR($this->in['path']);$this->check_system_path();}}public function index(){$ ƒ='';¯·ÒÂ¯Â²êåî¶€‰Äı;if(isset($this->in['path'])&& $this->in['path']!=''){$ ƒ=_DIR_CLEAR($_GET['path']);$ ƒ=rtrim($ ƒ,'/').'/';}$this->assign('dir',$ ƒ);if($this->config['forceWap']){$this->display('index_wap.php');}else{$this->display('index.php');}}private function check_system_path(){if(!in_array(ACT,array('mkfile','mkdir','search','pathCuteDrag','pathCopyDrag','pathPast','fileDownload'))){return;}if($GLOBALS['path_type']==KOD_USER_SHARE&& !strstr(trim($this->in['path'],'/'),'/')){show_json($this->L['error'],!1);}if(in_array($GLOBALS['path_type'],array(KOD_USER_FAV,KOD_GROUP_ROOT_ALL,KOD_GROUP_ROOT_SELF))){show_json($this->L['system_path_not_change'],!1);}}public function pathInfo(){$˜„±´´=json_decode($this->in['list'],!0);if(!$˜„±´´){show_json($this->L['error'],!1);}foreach($˜„±´´ as &$ÔÂê™ä){$ÔÂê™ä['path']=_DIR($ÔÂê™ä['path']);}$¦„=path_info_muti($˜„±´´,$this->L['time_type_info']);if(!$¦„){show_json($this->L['not_exists'],!1);}if(count($˜„±´´)==0x001&& $˜„±´´[0]['type']!='folder'){if($GLOBALS['is_root']|| $GLOBALS['auth']['explorer:fileDownload']==0x001){$¦„['download_path']=_make_file_proxy($˜„±´´[0]['path']);}$İ×œ=$˜„±´´[0]['path'];if($¦„['size']<0x064*0x00000400*0x00000400|| isset($this->in['get_md5'])){$¦„['file_md5']=@md5_file($İ×œ);}else{$¦„['file_md5']="...";}$Ïø=get_path_ext($İ×œ);if(in_array($Ïø,array('jpg','gif','png','jpeg','bmp'))){load_class('imageThumb');$¿=imageThumb::imageSize($İ×œ);if($¿){$¦„['image_size']=$¿;}}}$¦„['path']=_DIR_OUT($¦„['path']);show_json($¦„);}public function pathChmod(){$ôşÈ=json_decode($this->in['list'],!0);if(!$ôşÈ){show_json($this->L['error'],!1);}$ú=octdec('0'.$this->in['mod']);$¸¯«=0;$—§×ÁÍ=0;³¹ºÎ‰³ÎÉâÏ“;foreach($ôşÈ as $ÏÛæÓ){$©Œ‡Ô=_DIR($ÏÛæÓ['path']);if(chmod_path($©Œ‡Ô,$ú)){$¸¯«++;}else{$—§×ÁÍ++;}}$ëÂÒ®‘=$—§×ÁÍ==0?!0:!1;$½â„=$¸¯«.' success,'.$—§×ÁÍ.' error';«×Ñê;if(count($ôşÈ)==0x001&& $—§×ÁÍ==0){$½â„=$this->L['success'];}show_json($½â„,$ëÂÒ®‘);}public function mkfile(){$¡ÇÏõ =BASIC_PATH.'static/others/newfile-tpl/';Î¢»;space_size_use_check();ñ¥µ°ˆº¨ºÈÔ¼¡äŒÍ±Ô§ô—ªæÈÀ¢ª¶ŒœÛÂÌäüõ ÅËİæ±ìó€ŸÈÇ¾¶ñÜ»¿åÓÌƒ°Ğ•ŒÇ¶Ò“”ºÅ‚®Å;$÷ä='skip';Û”¹—±ùı†Æ·;if(isset($this->in['repeat_type'])){$÷ä=$this->in['repeat_type'];}$ÑÌã™=rtrim($this->path,'/');$ÑÌã™=get_filename_auto($ÑÌã™,'',$÷ä);if(@touch($ÑÌã™)){chmod_path($ÑÌã™,0777);if(isset($this->in['content'])){file_put_contents($ÑÌã™,$this->in['content']);}else{$­˜ñ=get_path_ext($ÑÌã™);$š¡¹»š=$¡ÇÏõ .'newfile.'.$­˜ñ;if(file_exists($š¡¹»š)){$¥Ñ=file_get_contents($š¡¹»š);file_put_contents($ÑÌã™,$¥Ñ);}}space_size_use_change($ÑÌã™);show_json($this->L['create_success'],!0,_DIR_OUT(iconv_app($ÑÌã™)));}else{show_json($this->L['create_error'],!1);˜í–µ˜Õê£ñ…§©²Àœ§;}}public function mkdir(){space_size_use_check();—Ø¼ª»½‘°Ö©ŸíÈÔ†ŸáğÃÓõêı©«šĞ‡Ø³±´ÚÛï™í¡ï—;$İà•='skip';ÕÃÌÌ¯ËöÛåÈ;if(isset($this->in['repeat_type'])){$İà•=$this->in['repeat_type'];}$¾ûğ=rtrim($this->path,'/');$¾ûğ=get_filename_auto($¾ûğ,'',$İà•);if(mk_dir($¾ûğ,0777)){chmod_path($¾ûğ,0777);show_json($this->L['create_success'],!0,_DIR_OUT(iconv_app($¾ûğ)));}else{show_json($this->L['create_error'],!1);}}public function pathRname(){$Í õ»=_DIR($this->in['rname_to']);ƒÄ´˜©´‘ş÷ŞÌ¨ªÃ„ŒæÏˆèÀ¸ÅÙ¼Êœ£ŸçÒ¸‘ˆÊ‘©İ©Ó¢­ä®”µ¶ıõïÄ;if(file_exist_case($Í õ»)){show_json($this->L['name_isexists'],!1);}if(@rename($this->path,$Í õ»)){show_json($this->L['rname_success'],!0,_DIR_OUT(iconv_app($Í õ»)));}else{show_json($this->L['no_permission_write_all'],!1);}}public function search(){if(!isset($this->in['search']))show_json($this->L['please_inpute_search_words'],!1);$É=intval($this->in['is_content']);$æ¥ï†=intval($this->in['is_case']);$¿ŸË=trim($this->in['ext']);if($GLOBALS['path_type']==KOD_USER_SHARE&& strstr($this->path,KOD_USER_SHARE)){show_json($this->L['path_cannot_search'],!1);}$Ì³=path_search($this->path,iconv_system(rawurldecode($this->in['search'])),$É,$¿ŸË,$æ¥ï†);show_json(_DIR_OUT($Ì³));}public function pathList(){$ˆ²£ìà=$this->in['path'];if($ˆ²£ìà=="")$ˆ²£ìà='/';$˜¶=$this->path($this->path);if($this->path== MYHOME|| $this->path==HOME){$this->_self_root_load($˜¶['folderlist']);}if($˜¶['info']['path_type']==KOD_GROUP_PATH&& !strstr(trim(_DIR_CLEAR($this->in['path']),'/'),'/')){$this->_self_group_load($˜¶['folderlist']);}$˜¶['user_space']=$this->user['config'];show_json($˜¶);}public function treeList(){$ŸÒüğ¹=$this->in['app'];if(isset($this->in['type'])&& $this->in['type']=='init'){$this->_tree_init($ŸÒüğ¹);}switch(trim(rawurldecode($this->in['path']))){case KOD_USER_FAV:show_json($this->_tree_fav(),!0);break;case KOD_GROUP_ROOT_SELF:show_json($this->_group_self(),!0);break;case KOD_GROUP_ROOT_ALL:show_json($this->_group_tree('1'),!0);break;default:break;}if((isset($this->in['tree_icon'])&& $this->in['tree_icon']!='groupPublic')&& !strstr(trim(rawurldecode($this->in['path']),'/'),'/')&&($GLOBALS['path_type']==KOD_GROUP_PATH|| $GLOBALS['path_type']==KOD_GROUP_SHARE)){$À±£=$this->_group_tree($GLOBALS['path_id']);show_json($À±£,!0);return;}$î‹ƒ¼=_DIR($this->in['path']);if(!is_readable($î‹ƒ¼))show_json($this->L['no_permission_read'],!1);$“²Ç=($ŸÒüğ¹=='editor'?!0:!1);§Ø¿ÆñÈÂ’œÀƒÕãã—–ˆ˜æ÷¤ê´äıç­Ä¾;$À±£=$this->path($î‹ƒ¼,$“²Ç,!0);»­•®öØÁ“šÄéş©•²šüª¿çß¤æÇÒ¬†µšÕñÇë¡¿ÄâÒß§¼ŞÑ¾ô„Ùñ¯™Ú¾;function sort_by_key($Ö‘î,$ÇŠ³¹){if($Ö‘î['name']==$ÇŠ³¹['name'])return 0;return($Ö‘î['name']>$ÇŠ³¹['name'])?0x001:-0x001;}usort($À±£['folderlist'],"sort_by_key");’ä¾äÅæ¢¤¸àš½ºìÔçû“ªÓ¥š;usort($À±£['filelist'],"sort_by_key");if($î‹ƒ¼==MYHOME|| $î‹ƒ¼==HOME){}if($ŸÒüğ¹=='editor'){$¥æ§÷‡=array_merge($À±£['folderlist'],$À±£['filelist']);show_json($¥æ§÷‡,!0);}else{show_json($À±£['folderlist'],!0);}}private function _self_group_load(&$Š){foreach($Š as $Áï±©’=>$âóñ ){if($âóñ ['name']=='share'){$Š[$Áï±©’]=array('name' =>$this->L['group_share'],'menuType' =>"menufolder folderBox",'ext' =>"folder_share",'isParent' =>!0,'is_readable' =>!0,'is_writeable' =>!0,'path' =>KOD_GROUP_PATH.':'.$GLOBALS['path_id'].'/share/','type' =>'folder','open' =>!1,'isParent' =>!1);break;}}$Š=array_values($Š);}private function _self_root_load(&$ƒç‰—){foreach($ƒç‰— as $İ=>$­©){if($­©['name']=='share'){$ƒç‰—[$İ]=array('name' =>$this->L['my_share'],'menuType' =>"menuTreeUser",'ext' =>"folder_share",'isParent' =>!0,'is_readable' =>!0,'is_writeable' =>!0,'path' =>KOD_USER_SHARE.':'.$this->user["user_id"].'/','type' =>'folder','open' =>!1,'isParent' =>!1);break;}}$ƒç‰—=array_values($ƒç‰—);ÊıÔÕê—ÅÀØô£ÌæÄúæÑşÎÛ—áºÓÊıâÂÏ®Á¥…­¼ÊÊı¤À¢ğ¨æì¹ìŞ–„ÀĞØĞœ×´Ş;if($this->config['user']['recycle_open']=="1"){}}private function _tree_fav(){$â =($this->in['app']=='editor'?!0:!1);‹³™Š×Ú­Éƒ•¶“Ï£ñå¨²¶ƒÓØ·²‚›ÓÏ„¢Û¸¼æ‘—”Úš©’­øµŸßİÑ—ßÕ;$¸»ª=new fileCache(USER.'data/fav.php');”ççĞÎùç;$Ôƒæ=$¸»ª->get();$=array();¢şÚøé”‡ˆÏ²ùÛáÄÉà”ÃÉ÷™Ì†ıÎõšñôõêß‹òçÛ¥â·‡òüÑÔ‘–‰°ë±éĞ¹”ê«Šà–êìŠÒÈ¯¶·ªıŠş ;$GLOBALS['path_from_auth_check']=!0;foreach($Ôƒæ as $Ğ‹=>$ƒõ){$Ó¯Ü=path_haschildren(_DIR($ƒõ['path']),$â );if(!isset($ƒõ['type'])){$ƒõ['type']='folder';}if(in_array($ƒõ['type'],array('group'))){$Ó¯Ü=!0;}$ç ñÒ=array('name' =>$ƒõ['name'],'ext' =>$ƒõ['ext'],'menuType' =>"menuTreeFav",'path' =>$ƒõ['path'],'type' =>$ƒõ['type'],'open' =>!1,'isParent' =>$Ó¯Ü);if(isset($ƒõ['type'])&& $ƒõ['type']!='folder'){$ç ñÒ['ext']=$ƒõ['type'];}$[]=$ç ñÒ;}$GLOBALS['path_from_auth_check']=!1;return $;­İ×åˆÕïˆå‘§€â³©å©ñ¹ÙÏøµ¸™¨;}private function _tree_init($§){if($§=='editor' && isset($this->in['project'])){$²ı=$this->path(_DIR($this->in['project']),!0,!0);$Õ¹™=array_merge($²ı['folderlist'],$²ı['filelist']);$ª¢=array(array('name'=> get_path_this($this->in['project']),'children' =>$Õ¹™,'menuType' =>"menuTreeRoot",'ext' =>"folder",'path' =>$this->in['project'],'type' =>'folder','open' =>!0,'isParent' =>count($Õ¹™)>0?!0:!1));show_json($ª¢);return;}$»=($§=='editor'?!0:!1);$“ı=$this->_tree_fav($§);$¨=KOD_GROUP_PATH.':1/';if(system_member::user_auth_group(0x001)==!1){$¨=KOD_GROUP_SHARE.':1/';}$‚€·=$this->path(_DIR($¨),$»,!0);$¹Ñá=$this->path(_DIR(MYHOME),$»,!0);ö÷Ü‡Î—¡;if($»){$ÁÃü=array_merge($¹Ñá['folderlist'],$¹Ñá['filelist']);$›Œ=array_merge($‚€·['folderlist'],$‚€·['filelist']);}else{$ÁÃü=$¹Ñá['folderlist'];$›Œ=$‚€·['folderlist'];}$ ´‘Ş=count($ÁÃü)>0?!0:!1;$’—ï=count($›Œ)>0?!0:!1;‘âÛˆÚ¸©Ğ²¥’õµ„×«¹ÌÄÊ«ûİÂì©¬ÀºœÃêÕÔ”¦‡º¹ıïÈ‚Èô’‚Á×Íì;$ª¢=array('webroot'=>array(),'fav'=>array('name' =>$this->L['fav'],'ext' =>"treeFav",'menuType' =>"menuTreeFavRoot",'children' =>$“ı,'path' =>KOD_USER_FAV,'type' =>'folder','open' =>!0,'isParent' =>count($“ı)>0?!0:!1),'my_home'=>array('name' =>$this->L['root_path'],'menuType' =>"menuTreeRoot",'ext' =>"treeSelf",'children' =>$ÁÃü,'path' =>MYHOME,'type' =>'folder','open' =>!0,'isParent' =>$ ´‘Ş),'public'=>array('name' =>$this->L['public_path'],'menuType' =>"menuTreeGroupRoot",'ext' =>"groupPublic",'children' =>$›Œ,'path' =>$¨,'type' =>'folder','open' =>!0,'isParent' =>$’—ï),'my_group'=>array('name' =>$this->L['my_kod_group'],'menuType' =>"menuTreeGroupRoot",'ext' =>"groupSelfRoot",'children' =>$this->_group_self(),'path' =>KOD_GROUP_ROOT_SELF,'type' =>'folder','open' =>!0,'isParent' =>!0),'group'=>array('name' =>$this->L['kod_group'],'menuType' =>"menuTreeGroupRoot",'ext' =>"groupRoot",'children' =>$this->_group_tree('1'),'path' =>KOD_GROUP_ROOT_ALL,'type' =>'folder','open' =>!0,'isParent' =>!0),);ÁÕİƒ‘ì Õ×õªì²¨Ö;if($§=='editor'){unset($ª¢['my_group']);unset($ª¢['group']);unset($ª¢['public']);if($GLOBALS['is_root']==0x001){$™ =$this->path(_DIR(WEB_ROOT),$»,!0);$á–Æ=array_merge($™ ['folderlist'],$™ ['filelist']);$ª¢['webroot']=array('name' =>"webroot",'menuType' =>"menuTreeRoot",'ext' =>"folder",'children' =>$á–Æ,'path' =>WEB_ROOT,'type' =>'folder','open' =>!0,'isParent' =>!0);}}else{unset($ª¢['webroot']);³ÅòŞöµ´Ô¸ÆÂØœšÏÇˆí;}$±Å¬Êå=array();¦“ÔÅÆš¸¥‘íÚå§¡¨€¾ÃÏ†Ì½ıƒ­ÈéöæµŠ»úĞÖ´öç£;foreach($ª¢ as $ÎÊó÷=>$²¼›){if(count($²¼›['children'])<0x001&& in_array($ÎÊó÷,array('my_group','group'))){continue;}$±Å¬Êå[]=$²¼›;}show_json($±Å¬Êå);}private function _group_tree($Ù){$‡Üè=system_group::load_data();Ç¯®Òê©£ÁŞšª‚ìùÌáñ˜•®³Î¸ŠÀêó‘³ìÙâ›­ÎÅĞ¤ë»¦Ùµó»¨ŒÑ×À¡Í¬Ğ¹;$âì=$‡Üè->get(array('parent_id',$Ù));$Ï©ê=$this->_make_node_list($âì);$¼¯”¨ë=array();if($Ù!='1'){$¡=system_member::get_user_at_group($Ù);foreach($¡ as $¾Ê=>$‘¢û){$³Ê='user';if($‘¢û['user_id']==$this->user['user_id']){$³Ê='userSelf';}$¼¯”¨ë[]=array('name' =>$‘¢û['name'],'menuType' =>"menuTreeUser",'ext' =>$³Ê,'path' =>KOD_USER_SHARE.':'.$‘¢û['user_id'].'/','type' =>'folder','open' =>!1,'isParent' =>!1);}}$…„€è=array_merge($Ï©ê,$¼¯”¨ë);Á¹’à©Î‘;return $…„€è;}private function _group_self(){$üøúŸ¨=array();foreach($this->user['group_info'] as $äËàş=>$¬İÆ){if($äËàş=='1')continue;$Ş¯=system_group::get_info($äËàş);if($Ş¯){$üøúŸ¨[]=$Ş¯;}}return $this->_make_node_list($üøúŸ¨);¨èÆÒ¸×‘°Ô‹¬ô³æß™³ìú²®§‘ôØğ¤ûßúá‰ã¨ÛœíÍÖøùË­á«Æ•™ÁÈÇéÙ¼ÃÊ;}private function _make_node_list($¿«Ü¢){$ÀË‘=array();«£÷¦ï¥ˆ›ì´¯æü™Á¹Ü›¸÷¿í¹‹ş—ØşÃû÷éëòˆ‹’½ºùºÔ»ó±ÉÏ‚‰ğÃ›ğÚóïŸğ;if(!is_array($¿«Ü¢)){return $ÀË‘;}foreach($¿«Ü¢ as $Šİ†üå=>$){$ÌŠ=KOD_GROUP_PATH;$¡ÆÒÓ=system_member::user_auth_group($['group_id']);if($¡ÆÒÓ==!1){$ÌŠ=KOD_GROUP_SHARE;$ã='groupGuest';}else if($¡ÆÒÓ=='read'){$ã='groupSelf';}else{$ã='groupSelfOwner';}$“ì=!0;$„±Ï=system_member::get_user_at_group($['group_id']);ä¬µÍ¶“Ô´ùæÄ;if(count($„±Ï)==0&& $['children']==''){$“ì=!1;}$ÀË‘[]=array('name' =>$['name'],'type' =>'folder','path' =>$ÌŠ.':'.$['group_id'].'/','ext' =>$ã,'tree_icon' =>$ã,'menuType' =>"menuTreeGroup",'isParent' =>$“ì);}return $ÀË‘;}public function pathDelete(){$ÎûÕ=json_decode($this->in['list'],!0);if(!is_dir(USER_RECYCLE)){mk_dir(USER_RECYCLE);}$©¦³Í=$this->config['user']['recycle_open'];if(!path_writeable(USER_RECYCLE)){$©¦³Í='0';}$¡¾=0;$Ñ³ß–=0;foreach($ÎûÕ as $Ë){$Ãß¼÷Ù=_DIR($Ë['path']);if($©¦³Í!="1" || $GLOBALS['path_type']==KOD_GROUP_SHARE|| $GLOBALS['path_type']==KOD_GROUP_PATH|| $GLOBALS['path_type']==KOD_USER_RECYCLE){if($Ë['type']=='folder'){if(del_dir($Ãß¼÷Ù))$¡¾++;else $Ñ³ß–++;}else{if(del_file($Ãß¼÷Ù))$¡¾++;else $Ñ³ß–++;ó¬¡ÃÕÈö;}space_size_use_reset();}else{$˜=USER_RECYCLE.get_path_this($Ãß¼÷Ù);$˜=get_filename_auto($˜,date('-h:i:s'),'folder_rename');ôËØÙõœº²””ÕĞŒ­Ü€ÚşÃ±È»ÕËÓûÀó‚Œ‚‘äÜˆ—»–«’æ¸¿Ä¸šÄüË¸¢ØŒåÍ’èÙ”ù¿ğƒÁ‰¾×µÑ¿í‘…¦¬;if(@rename($Ãß¼÷Ù,$˜)){$¡¾++;}else{$Ñ³ß–++;}}}$£ø×=$Ñ³ß–==0?!0:!1;è¹˜·Ë‘àûĞÑş;$Û=$¡¾.' success,'.$Ñ³ß–.' error';if($Ñ³ß–==0){$Û=$this->L['remove_success'];}show_json($Û,$£ø×);}private function clearTemp(){$‘ªş¢=USER_TEMP;$Ïù=@filemtime($‘ªş¢);¦ä„ŸœÇëÙÌš«Ÿ™¾úØ©éÔŒŒ…²Üşü¦Ñ£ŒÕ´«òü˜;if(time()-$Ïù>0x0258){del_dir($‘ªş¢);mk_dir($‘ªş¢);}}public function pathDeleteRecycle(){if(!isset($this->in['list'])){if(!del_dir(USER_RECYCLE)){show_json($this->L['remove_fali'],!1);}else{mkdir(USER_RECYCLE);$this->clearTemp();space_size_use_reset();show_json($this->L['recycle_clear_success'],!0);}}$åªƒ†=json_decode($this->in['list'],!0);;$ˆÁ›•=0;ÆÊ™™î¥ï¤Ñâ¢éóùĞüÖã¿Øƒ«ç‹ì„¡´Ñ”û­•Ó…²¥èÔÜÎàûË¸ßŒ‘â·ùî¥ı‘;$Ğ¦Öí=0;¨ñ®ÎÚƒß·ÒÀ³Ÿø”«‹÷â…ç‰ƒøãÓŸ»Âó§¾šíëôñË­Äáã‡õ’îó˜Öü›Ğáïğ²åÅñƒßßïÕÑ¼„—ÉåûÑÜŒäÌ€ü£ı˜ô;foreach($åªƒ† as $ˆåı»){$Ã­Ï=_DIR($ˆåı»['path']);if($ˆåı»['type']=='folder'){if(del_dir($Ã­Ï))$ˆÁ›•++;else $Ğ¦Öí++;}else{if(del_file($Ã­Ï))$ˆÁ›•++;else $Ğ¦Öí++;üş÷Çåó™Ã€ı€û´ı”©ŞÜÙÜ¡ˆ­Æ–íÁöëÁî³¨âÍëâÌüãÈ²áİÛÁûìŸÖÊÀŞø‡ôæÉëÓ‹Ú‡´½Õ ¡£…;}}space_size_use_reset();Ë­©ÈšÉŸåŠıŞ’óÆÛàšç¼¢œúø½œœÛ¢‰­ŠÕÚ´õı½Û‰¼»›°‚÷’àÎ¿ıÉ¸»;if(count($åªƒ†)==0x001){if($ˆÁ›•)show_json($this->L['remove_success']);else show_json($this->L['remove_fali'],!1);‰ŞÅ“µ¡ÈÓ—Ç‘óĞÎ;}else{$ì€=$Ğ¦Öí==0?!0:!1;show_json($this->L['remove_success'].$ˆÁ›•.'success,'.$Ğ¦Öí.'error',$ì€);ÅàÃ«È€’™›ıß¯³;}}public function pathCopy(){session_start();$‡™À™=json_decode($this->in['list'],!0);$_SESSION['path_copy']=json_encode($‡™À™);çğãúÁªÛÑîˆ›ïš¹‰¶¸èåëêŞó„ ’²õĞ±ŞÂ–Ù…ÀµÖ°¾ñ Ø¬ªä”õÑşÕÅ;$_SESSION['path_copy_type']='copy';show_json($this->L['copy_success'],ture,$_SESSION);¨ÊçÚ©«ğƒ°±¹ˆâ;}public function pathCute(){session_start();Ñ¦®á;$Ã=json_decode($this->in['list'],!0);®¤Ç¥øŞÎÃÇ©ìòšï¤Ì©¬°¢§´óÍãÖÚ§¯¹êİİ²„Ö’ÒšÙü;foreach($Ã as $Í=>&$÷){$÷['path']=rawurldecode($÷['path']);•ÅÅÊ¹”®ïÖÀ©Á‡ô£Şˆõùá;_DIR($÷['path']);Œù¢ğ;}$_SESSION['path_copy']=json_encode($Ã);ˆÑœ€®Öî¶™;$_SESSION['path_copy_type']='cute';show_json($this->L['cute_success']);}public function pathCuteDrag(){$—=json_decode($this->in['list'],!0);$ù=$this->path;$ª¨=$GLOBALS['path_type'];$š²¡=$GLOBALS['path_id'];if(!path_writeable($this->path))show_json($this->L['no_permission_write'],!1);$ò=0;$óâÁ=0;äà·ô’ÕŒ»í‡×ˆ²€œĞ½ç¦°›Û¤şïÑ–Õ²ÎÊÄ¤×’ŞÙš‘Ú¸‘öŠ¡µñÈå¤‹ÂûŞÙÑ‘¨;$ÖÌ=array();Ó±ùå³ö…½˜º¯á¡¾†­ËÈ©«¢û½Ê˜”˜ìöáŸñÇ¬¥¾±â×ì“¹ÒÀ»ŠåÊ­á;foreach($— as $ø){$œ‘‰Šˆ=_DIR($ø['path']);²Ö ñ‰„Êõ˜……êÆÁŠĞ§ÔıŠÜö…ùˆ…‘ù®Œ­…¬Ÿ°ê;$Š´·Ë¾=get_path_this($œ‘‰Šˆ);$”†ığı=get_filename_auto($ù.$Š´·Ë¾,'',$this->config['user']['file_repeat']);if($š²¡!=$GLOBALS['path_id']){space_size_use_check();}if(move_path($œ‘‰Šˆ,$”†ığı,'',$this->config['user']['file_repeat'])){$ò++;if($š²¡!=$GLOBALS['path_id']){space_size_use_change($”†ığı);space_size_use_change($”†ığı,!1,$ª¨,$š²¡);}$ÖÌ[]=_DIR_OUT(iconv_app($”†ığı));}else{$óâÁ++;ğ˜Œ;}}$¥¹=$óâÁ==0?!0:!1;$Ù´ƒÅ=$ò.' success,'.$óâÁ.' error';if($óâÁ==0){$Ù´ƒÅ=$this->L['success'];}show_json($Ù´ƒÅ,$¥¹,$ÖÌ);}public function pathCopyDrag(){$¶Ä‚í=json_decode($this->in['list'],!0);$õ„Õ=$this->path;ú‡³ƒ™¥›;$ÅÀ=$GLOBALS['path_type'];» —Úä·Ÿæ¥°¨›µ;$™¸Å•¿=$GLOBALS['path_id'];Ÿ´äôáĞ‰ñ ŸÌ†×ììü–;space_size_use_check();if(!path_writeable($this->path))show_json($this->L['no_permission_write'],!1);$•³ŒÛ=0;à¦ô•§Ú‹Š¬•¨ŸµÈë»¡Ù©ŸöÀ¹ÊÕìÖ±µ£ˆ—Êı¬ñØ¸ü†Í¦¥„;$’À‘ëê=0;$«é¯=array();Œ«¼¤õºÑ;foreach($¶Ä‚í as $”Šåš×){$À=_DIR($”Šåš×['path']);¿ˆ½¤³§ÔµşÛéŒ‡¦°ıá‚æõŒÍ‘äÙÑÁÖ¥ßãäç¢ŠœÉŞÑÉº¼ÕÂã†ÁÅˆ©»•öÌúÑŸ¼¨ÄœŒ;$…®=get_path_this($À);$ø”=get_filename_auto($õ„Õ.$…®,'',$this->config['user']['file_repeat']);°˜“”ŸÔÚ¨ı–½õã¸ÇƒõïÇ“üò˜¬¨º¥¼®èŒß‚Ÿô¡;if($this->in['filename_auto']==0x001&& trim($ø”,'/')==trim($À,'/')){$ø”=get_filename_auto($õ„Õ.$…®,'','folder_rename');}if(copy_dir($À,$ø”)){$•³ŒÛ++;space_size_use_change($…®);$«é¯[]=_DIR_OUT(iconv_app($ø”));}else{$’À‘ëê++;}}$ÏÉóæˆ=$’À‘ëê==0?!0:!1;±Í·¢–ÊŸŠâË²ñîÌÚú­Ü›¢şòÈ„ÙĞí¤’ ò;$ÂŠ”=$•³ŒÛ.' success,'.$’À‘ëê.' error';®Ç— ¶ãú²‘ØÍ´×Ş¨¡ã‚òÒ§…ò;if($’À‘ëê==0){$ÂŠ”=$this->L['success'];}show_json($ÂŠ”,$ÏÉóæˆ,$«é¯);}public function clipboard(){$Ï¶=json_decode($_SESSION['path_copy'],!0);if(!$Ï¶){$Ï¶=array();}show_json($Ï¶,!0,$_SESSION['path_copy_type']);}public function pathPast(){if(!isset($_SESSION['path_copy'])){show_json($this->L['clipboard_null'],!1,array());}$™ºİÇ=$this->path;session_start();$ç¹Ùãì=''; –šÈ·ıË«Ğò±Äúµæ”ğÄÛó¹Ä­;$şæ=array();ğéµîµàÀ©“…¸”íû•ŞÀñÓú¶ßœÆò®Ää˜;$ÔÎÛ•÷=json_decode($_SESSION['path_copy'],!0);„œŸ€²şÁ¤Ò¼ÛÔ;$»ğÙ=$_SESSION['path_copy_type'];$‰ÇÉ¢=$GLOBALS['path_type'];Ÿ´éĞ›”ìº• ¹ÖÅŒ”¡àßÜÒºà¸Ä©ƒçë;$ÙŒ=$GLOBALS['path_id'];§Ş¯•šÄµÓœúà°œ;if(!path_writeable($™ºİÇ))show_json($this->L['no_permission_write'],!1,$şæ);$GLOBALS['path_from_auth_check']=!0;•ËÛÍ‘…ĞøñòÓıÉ˜šğöÉ‡’¼;$«¸ÆÜÕ=count($ÔÎÛ•÷);if($«¸ÆÜÕ==0){show_json($this->L['clipboard_null'],!1,$şæ);}for($Ïº¬ì=0;$Ïº¬ì<$«¸ÆÜÕ;$Ïº¬ì++){$±¾Æ¤=_DIR($ÔÎÛ•÷[$Ïº¬ì]['path']);_DIR($this->in['path']);$û²=get_path_this($±¾Æ¤);$ª‡ô¼—=iconv_app($û²);if(!file_exists($±¾Æ¤)){$ç¹Ùãì.= "<li>{$ª‡ô¼—}".$this->L['copy_not_exists']."</li>";continue;}if($ÔÎÛ•÷[$Ïº¬ì]['type']=='folder'){if($±¾Æ¤==substr($™ºİÇ,0,strlen($±¾Æ¤))){$ç¹Ùãì.="<em style='color:#fff;'>{$ª‡ô¼—}".$this->L['current_has_parent']."</em>";continue; Àó‘“Ê½€—ï¾İ”ğø·í«ôÛÕüÑ“”„¶×ï¡ø±•‰Â¨Ô©ëñèÊ‡ÚÄ¿Èï´¥Æ²÷ÙÆû‘Ÿì²™Ç£áğ÷ã›ä;}}$„°ÜŞ=get_filename_auto($™ºİÇ.$û²,'',$this->config['user']['file_repeat']);åÑÍ¬…Å‡ËÂ˜;$û²=get_path_this($„°ÜŞ);†Î”©±…¢• ‡ê¥·È…­å­“¸úÀ½ÁÈŠ…;if($»ğÙ=='copy'){space_size_use_check();copy_dir($±¾Æ¤,$„°ÜŞ);space_size_use_change($û²);}else{if($ÙŒ!=$GLOBALS['path_id']){space_size_use_check();}move_path($±¾Æ¤,$„°ÜŞ,'',$this->config['user']['file_repeat']);if($ÙŒ!=$GLOBALS['path_id']){space_size_use_change($û²);space_size_use_change($û²,!1,$‰ÇÉ¢,$ÙŒ);}}$şæ[]=_DIR_OUT(iconv_app($„°ÜŞ));­ü…Á§¶ÇÉËèĞ·‰”¶æÁÊ ½‹Ş€Óè…µàºâŞ¿¥†öíĞÂ;}if($»ğÙ=='copy'){$¢ùå«=$this->L['past_success'].$ç¹Ùãì;}else{$_SESSION['path_copy']=json_encode(array());$_SESSION['path_copy_type']='';$¢ùå«=$this->L['cute_past_success'].$ç¹Ùãì;}$úââ¼­=($ç¹Ùãì==''?!0:!1);show_json($¢ùå«,$úââ¼­,$şæ);}public function fileDownload(){file_put_out($this->path,!0);ùÌ€Â®»¦úÌ“òºäµ’‡°ø³¬ó–±Ä”¬ı÷§‹Å§Îóâõ;}public function fileDownloadRemove(){$Ş=rawurldecode(_DIR_CLEAR($this->in['path']));şù‡‘‚¸‹µä€Ìô±‘Šİ;$Ş=USER_TEMP.iconv_system($Ş);space_size_use_change($Ş,!1);file_put_out($Ş,!0);del_file($Ş);¼á¾î¥ÓÁ¤ÎÉ¶Ğ‚Â‡çÂÓİóåçÒõëØ’´†ıñ—à°‡;}public function zipDownload(){if(!file_exists(USER_TEMP)){mkdir(USER_TEMP);}else{$…=path_list(USER_TEMP,!0,!1);$«Ô’=0x0e10*0x0000018;if($…['filelist']>=0x001){for($¦•¥­=0;$¦•¥­<count($…['filelist']);$¦•¥­++){$ç‚ÚÜç=$…['filelist'][$¦•¥­]['mtime'];if(time()-$ç‚ÚÜç>$«Ô’){del_file($…['filelist'][$¦•¥­]['path'].$…['filelist'][$¦•¥­]['name']);}}}}$°Ş¯=$this->zip(USER_TEMP);show_json($this->L['zip_success'],!0,get_path_this($°Ş¯));ïÖ¨Ğˆ°×ù„â;}public function zip($‰¢¶ =''){load_class('pclzip');Ó¡¿„€îñÔ á«É²³ùŠÁó¤õ®¤ƒåÄøŸÀÌÁ€ÑÁïà´Ä‚–ïËÉ¤ÆÔæ;ini_set('memory_limit','2028M');$Œ¼Ùº=json_decode($this->in['list'],!0);¥Ö¿å¤æöÃÖØ÷›ÚŒ§Ù±í;$˜¨=count($Œ¼Ùº);for($åì=0;$åì<$˜¨;$åì++){$Œ¼Ùº[$åì]['path']=rtrim(_DIR($Œ¼Ùº[$åì]['path']),'/');€ì¢ÀÓÇÂ»¾‡’˜€®ó»›éì‰˜†²««˜˜‹ßãŒÍ†Ì¢;}$İ—=$‰¢¶ ;Ÿš§Ú¶‘È;if($‰¢¶ ==''){$İ—=get_path_father($Œ¼Ùº[0]['path']);}if(!is_writeable($İ—)){show_json($this->L['no_permission_write'],!1);}if($˜¨==0x001){$ªÎò=get_path_this($Œ¼Ùº[0]['path']);}else{$ªÎò=get_path_this(get_path_father($Œ¼Ùº[0]['path']));}$úŒî†=$İ—.$ªÎò.'.zip';$úŒî†=get_filename_auto($úŒî†,'',$this->config['user']['file_repeat']);»Ùßİ¨ï¼·ˆ­İ;space_size_use_check();$øÆ©¯=array();ƒÁâÙ¼ïÈÃÜœÕ˜ö¶ö §³×¯áµÏ¯¯—ØŞïËÏò²ÌÊ¢–€²ä˜©œÉÃÃ¢ó¥×ÃÕ‡Ú¯æËú¶¿‰éÔ£âÖÈ¦ä¶Ë¨ù;for($åì=0;$åì<$˜¨;$åì++){if(file_exists($Œ¼Ùº[$åì]['path'])){$øÆ©¯[]=$Œ¼Ùº[$åì]['path'];}}if(count($øÆ©¯)==0){show_json($this->L['not_exists'],!1);}$ Åáõ=new PclZip($úŒî†);foreach($øÆ©¯ as $½¦µ‰=>$ìÈ){$ÖÕ=_DIR_CLEAR(get_path_father($ìÈ));if($½¦µ‰==0){$ùãñĞ=$ Åáõ->create($ìÈ,PCLZIP_OPT_REMOVE_PATH,$ÖÕ,PCLZIP_CB_PRE_FILE_NAME,'zip_pre_name');continue;}$ùãñĞ=$ Åáõ->add($ìÈ,PCLZIP_OPT_REMOVE_PATH,$ÖÕ,PCLZIP_CB_PRE_FILE_NAME,'zip_pre_name');}space_size_use_change($úŒî†);if($ùãñĞ==0){show_json("Create error!",!1);}$Ñ=$this->L['zip_success'].$this->L['size'].":".size_format(filesize($úŒî†));if($‰¢¶ ==''){show_json($Ñ,!0,_DIR_OUT(iconv_app($úŒî†)));}else{return iconv_app($úŒî†);}}public function unzip(){ini_set('memory_limit','2028M');$ºÉ‹=$this->path;ºà ÷‡Õ©ÂÊÕš¡Öş›ºğëçŠ½ùØÛµ£æ¹ÈîÙÁö°Ã¡óö¯ÍÊ‰ş·ğ‰ôêá;$ …¹®=get_path_this($ºÉ‹);$ …¹®=substr($ …¹®,0,strrpos($ …¹®,'.'));Íºù;$ı›òŒ“=get_path_ext($ºÉ‹);$áˆ=get_path_father($ºÉ‹).$ …¹®;Û—µÆù‡æ€À–“;if(isset($this->in['to_this'])){$áˆ=get_path_father($ºÉ‹);}if(isset($this->in['path_to'])){$áˆ=_DIR($this->in['path_to']);}if(!is_writeable(get_path_father($ºÉ‹))){show_json($this->L['no_permission_write'],!1);}space_size_use_check();load_class('pclzip');$–=new PclZip($ºÉ‹);$‘‚Ç=$–->extract(PCLZIP_OPT_PATH,$áˆ,PCLZIP_OPT_SET_CHMOD,0777,PCLZIP_CB_PRE_FILE_NAME,'unzip_pre_name',PCLZIP_CB_PRE_EXTRACT,"check_ext_unzip",PCLZIP_OPT_REPLACE_NEWER);if($‘‚Ç==0){show_json("Error : ".$–->errorInfo(!0),fasle);}else{space_size_use_change($ºÉ‹);show_json($this->L['unzip_success']);}}public function imageRotate(){load_class('imageThumb');ö’£†›•Úé¬‘±§™™§Ú°º¿Ñ’Šã”Ò’Š§ÓºöˆÕ;$ïÉ=new imageThumb($this->path,'file');Û»™¶ëÔÆ«¦Ùµ‹îˆø°ğúëçƒÁí óŞê¶€Ü;$É§ÊÓ=$ïÉ->imgRotate($this->path,intval($this->in['rotate']));ıÙ’›ÒÃ;if($É§ÊÓ){show_json($this->L['success']);}else{show_json($this->L['error'],!1);}}public function image(){if(filesize($this->path)<=0x00000400*0x014|| !function_exists('imagecolorallocate')){file_put_out($this->path);return;}if(!is_dir(DATA_THUMB)){mk_dir(DATA_THUMB);}load_class('imageThumb');$°õĞñ=$this->path;ÂİÃº±€±ú¨üŒûï÷†íÑ™Š¤İ—òÄñ¶çµ”†ùÏ·ù³£şÀŸî¸¦ÜŠÀç¯ş¢¬ç­€Ÿ–¶´œ°„Ô«†ˆÎ…É;$ó‚–Ñ=@md5_file($°õĞñ);ô¹ß¢ÇÇĞÈçæ€œ„± ØÜ§á¬¬¬œ¡®;if(strlen($ó‚–Ñ)<0x05){$ó‚–Ñ=md5($°õĞñ);}$ó¼=DATA_THUMB.$ó‚–Ñ.'.png';if(!file_exists($ó¼)){if(get_path_father($°õĞñ)==DATA_THUMB){$ó¼=$this->path;}else{$®=new imageThumb($°õĞñ,'file');$®->prorate($ó¼,0x0fa,0x0fa);}}if(!file_exists($ó¼)|| filesize($ó¼)<0x064){$ó¼=$this->path;}file_put_out($ó¼);}public function serverDownload(){set_time_limit(0);Ù¢±¢óùŠÛù;$ß«='download_'.$this->in['uuid'];îœ¶œ;if($this->in['type']=='percent'){if(isset($_SESSION[$ß«])){$Ò¾÷=$_SESSION[$ß«];$²=array('uuid' =>$this->in['uuid'],'length' =>(int)$Ò¾÷['length'],'name' =>$Ò¾÷['name'],'size' =>(int)@filesize(iconv_system($Ò¾÷['path'])),'time' =>mtime());show_json($²);}else{show_json('',!1);}}else if($this->in['type']=='remove'){del_file($_SESSION[$ß«]['path']);unset($_SESSION[$ß«]);show_json('',!1);}$á®=_DIR($this->in['save_path']);if(!is_writeable($á®)){show_json($this->L['no_permission_write'],!1);}$Ê=rawurldecode($this->in['url']);$³=url_header($Ê);öµ„ñÜä¥Ÿ§•¼Ş;if(!$³){show_json($this->L['download_error_exists'],!1);}$á®=$á®.$³['name'];if(!checkExt($á®)){$á®=_DIR($this->in['save_path']).date('-h:i:s').'.txt';}space_size_use_check();$á®=get_filename_auto(iconv_system($á®),'',$this->config['user']['file_repeat']);$±=$á®.'.downloading';¤²É†àÚĞéÍ•¸ÄË¼¶©¢ÔÎÁüãıÛ–„ˆ‚Æ¬µ‘²—ë„‚ûÑ—´—ã;session_start();”£ÛÖ ÀÔ;$_SESSION[$ß«]=array('length'=> $³['length'],'path' =>$±,'name' =>get_path_this($á®));ŠßÜÑ“âÀªÏÄ¬Ë—Ä®¨òü¶ˆ “ŞÁÓ´½¬ÈêššııÚ©Í Öš¸›œçÄå;session_write_close();ö;if(file_download_this($Ê,$±,$³['length'])){session_start();unset($_SESSION[$ß«]);session_write_close();if(@rename($±,$á®)){$ã«†=get_path_this(iconv_app($á®));space_size_use_change($á®);show_json($this->L['download_success'],!0,_DIR_OUT(iconv_app($á®)));}else{show_json($this->L['download_error_create'],!1);}}else{session_start();unset($_SESSION[$ß«]);session_write_close();é¸¤è”Î¶µ¥Ñ;show_json($this->L['download_error_create'],!1);Ö‡ı¼ƒ–Ã’Œö¹“‡óâ¥šÍŞ¿¶óíª´¿™ö®ïı¬­‚Ãñ•ÑıŒ‹’”şôºšÂ;}}public function officeView(){if(!file_exists($this->path)){show_tips($this->L['not_exists']);}$Ùù=get_path_ext($this->path);$è=_make_file_proxy($this->path);¨Ñ•ÖÂ”ƒğ–Çâ«;if(defined("OFFICE_KOD_SERVER")){$á=APPHOST.'index.php?explorer/fileProxy&path='.$this->in['path'];$¤óÌ='&appMode=edit&access_token='.session_id();if(OFFICE_KOD_ACTION=='read'){$¤óÌ='&appMode=view';$á=_make_file_proxy($this->path);}$è‡=$_SESSION['kod_user'];$¬¡™=rand_string(0x0a);$‚=OFFICE_KOD_SERVER.rawurlencode($á).'&lang='.LANGUAGE_TYPE.'&appType=desktop'.$¤óÌ.'&file_time='.@filemtime($this->path).'&user_id='.$è‡['user_id'].'&user_name='.$è‡['name'].'&app_id='.OFFICE_KOD_APP_ID.'&app_s='.$¬¡™.'&app_v='.md5($¬¡™.OFFICE_KOD_APP_KEY);»¶şË“ïáÚÓóµÆ˜;header("location:".$‚);exit;}if(file_exists(PLUGIN_DIR.'officeView')){if(isset($_GET['is_edit'])|| !isset($this->config['settings']['office_server_doc2pdf'])){include(PLUGIN_DIR.'officeView/index.php');}else{include(PLUGIN_DIR.'officeView/flexpapper.php');}exit;}$“šû=$_SERVER['HTTP_HOST'];çì™÷Õº°’ñÀ;if(strpos(OFFICE_SERVER,'view.officeapps.live.com')===-0x001|| strstr($“šû,'10.10.')|| strstr($“šû,'192.168.')|| strstr($“šû,'127.0.')|| !strstr($“šû,'.')){$½=$this->L['unknow_file_office'];show_tips($½);}else{$‚=OFFICE_SERVER.rawurlencode($è);header("location:".$‚);}}public function officeSave(){$‚ ®Õ=_DIR($this->in['path']);if(isset($this->in['from_activex'])){if($_FILES["file"]["error"]>0){echo "Return Code: ".$_FILES["file"]["error"];}else{move_uploaded_file($_FILES["file"]["tmp_name"],$this->path);echo 'succeed';}exit;}if(!is_writeable($‚ ®Õ)){$this->json_putout(array('error'=>'no_permission_write'));}if(($Œô=file_get_contents('php://input'))===!1){$this->json_putout(array('error'=>'Bad Request'));}$¶ˆù=json_decode($Œô,!0);if($¶ˆù===NULL){$this->json_putout(array('error'=>'Bad Response'));}$£õ‹=array(0=>'NotFound',0x001=>'Editing',0x0002=>'MustSave',0x00003=>'Corrupted',0x000004=>'Closed');$óÍ¦=array('error'=>0,'action'=>$£õ‹[$¶ˆù["status"]]);¶ÓİÇ‘±Ê±à à„­Õ¿ãŞ¹®ƒ°¹ã¾­±;switch($£õ‹[$¶ˆù["status"]]){case "MustSave":case "Corrupted":$óÍ¦["c"]="saved";Æ·Œš–Ó¬ÇŸŞ¨¿¿­ì–íÑô;$óÍ¦['status']='0';if(file_download_this($¶ˆù["url"],$‚ ®Õ)){$óÍ¦['status']='success';}break;default:break;}$this->json_putout($óÍ¦);Û—çü‚âÃºïŞĞÄ‹˜ãêÁ£ªï‘Àİâ¶†ã®ß‹ö†;}private function json_putout($ô){@header('Content-Type: application/json; charset==utf-8');@header('X-Robots-Tag: noindex');ì˜“±¤¬•î¹ºŞÊú¼®±Â’à¢°ëš¶†;@header('X-Content-Type-Options: nosniff');echo json_encode($ô);exit;â–¡‡Ã¶—³ïÑ“;}public function fileProxy(){$ÍĞê=isset($this->in['download']);file_put_out($this->path,$ÍĞê);}public function fileUpload(){$á¶®ÎÑ=_DIR($this->in['upload_to']);¥×¬¨Ç¾è˜ƒ ¯¶‘‚ÊÌĞ›·Ñ¯µ³æä‚¸ÊÖœï¯È˜öÙ×àñÚ‚¡’“¤İßõø˜Ç¨Îû;if(!is_writeable($á¶®ÎÑ))show_json($this->in['upload_to'],!1);if($á¶®ÎÑ=='')show_json($this->L['upload_error_big'],!1);if(strlen($this->in['fullPath'])>0x001){$ÈıÕäî=_DIR_CLEAR(rawurldecode($this->in['fullPath']));$ÈıÕäî=get_path_father($ÈıÕäî);$ÈıÕäî=iconv_system($ÈıÕäî);if(mk_dir($á¶®ÎÑ.$ÈıÕäî)){$á¶®ÎÑ=$á¶®ÎÑ.$ÈıÕäî;}}$ı=$this->config['user']['file_repeat'];$Şùºá=USER_TEMP;mk_dir($Şùºá);«Õ·¥í€Í½ûÜğú¦ïĞ‹ŞÖ¹åÕÂÅµ¼—ØÏŒ›ûâÒ¡ÑÒîÏÌ€ÊòïœşÏ;if(!is_writeable($Şùºá))show_json($this->L['no_permission_write'],!1);upload_chunk('file',$á¶®ÎÑ,$Şùºá,$ı);Éûûş¸ü–’Í£­É†ê×ÔÚç¤§ç;}private function path_share(&$›Ø‹š¨){$ÓŞÈĞÚ=explode(',',$GLOBALS['path_id']);Şœ§‚Êğ‰ÌÛà¡¶;$ÅŞ±=system_member::user_share_list($ÓŞÈĞÚ[0]);$‹Á•´À=$GLOBALS['path_id_user_share'];ºî;foreach($ÅŞ± as $ÄÈ±á=>$³¬à¼ø){$›ô=_DIR(KOD_USER_SHARE.':'.$ÓŞÈĞÚ[0].'/'.$³¬à¼ø['name']);š—Î¥ØäÙšÎí¥‰Ü÷Í¦©°–İÜö›Öµ¹òª¢Ôş¼ëÎâÅ³½à‚«†‹‰ıÙ¯¨ŠÆ†ç¾;$³¬à¼ø['path']=$³¬à¼ø['name'];$³¬à¼ø['atime']='';²Ÿş‡»óìŸº Ü›¢‰¡®“Ÿ‰ÃÈ”ŠÎüÈğ¼½ÌïÜËöûˆëè¨¦Š†Á­ãÛ£„åçÌùñ›ö»´ùÚ¤Ö§œÒ;$³¬à¼ø['ctime']='';$³¬à¼ø['mode']='';$³¬à¼ø['is_readable']=0x001;$³¬à¼ø['is_writable']=0x001;ŞñóîÖĞ’Ú¶ù¨±ìÄ©©Ñİ£¬ƒúÓ Í;$³¬à¼ø['exists']=intval(file_exists($›ô));$³¬à¼ø['meta_info']='path_self_share';$³¬à¼ø['menuType']="menuSharePath";if(get_path_ext($³¬à¼ø['name'])=='oexe'){$ÙÒ¼Ì=json_decode(@file_get_contents($›ô),!0);if(is_array($ÙÒ¼Ì))$³¬à¼ø=array_merge($³¬à¼ø,$ÙÒ¼Ì);}if($³¬à¼ø['type']=='folder'){$³¬à¼ø['ext']='folder';$›Ø‹š¨['folderlist'][]=$³¬à¼ø;}else{$›Ø‹š¨['filelist'][]=$³¬à¼ø;}}$›Ø‹š¨['path_read_write']='readable';˜¾€Î¹¨€§í©Ğ¿;$GLOBALS['path_id_user_share']=$‹Á•´À;if($ÓŞÈĞÚ[0]==$this->user['user_id']){$›Ø‹š¨['share_list']=$ÅŞ±;}return $›Ø‹š¨;}private function path_fav(&$ìŒïÁ¬){$ÅÖÉ=new fileCache(USER.'data/fav.php');$œà=$ÅÖÉ->get();¤ûË¤Ë…ÍË¬;$GLOBALS['path_from_auth_check']=!0;foreach($œà as $ıûşòè=>$â){$¸¡=_DIR($â['path']);•ÂˆõÁëƒåèÎ‹´ÔØ‚•ö;$‘=path_haschildren($¸¡,$òú‚Õ¦);if(!isset($â['type'])){$â['type']='folder';}if($â['type']=='folder' && $â['ext']!='treeFav'){$‘=!0;}$™Ëâ¯=array('name' =>$â['name'],'ext' =>$â['ext'],'menuType' =>"menuFavPath",'atime' =>'','ctime' =>'','mode' =>'','is_readable' =>0x001,'is_writeable' =>0x001,'exists' =>intval(file_exists($¸¡)),'meta_info' =>'treeFav','path' =>$â['path'],'type' =>$â['type'],'open' =>!1,'isParent' =>!1);if(strstr($â['path'],KOD_USER_SHARE)|| strstr($â['path'],KOD_USER_FAV)|| strstr($â['path'],KOD_GROUP_ROOT_SELF)|| strstr($â['path'],KOD_GROUP_ROOT_ALL)){$™Ëâ¯['exists']=0x001;}if(get_path_ext($â['name'])=='oexe'){$¥ĞØ©·=json_decode(@file_get_contents($¸¡),!0);if(is_array($¥ĞØ©·))$â=array_merge($â,$¥ĞØ©·);}if($â['type']=='folder'){$ìŒïÁ¬['folderlist'][]=$™Ëâ¯;}else{$ìŒïÁ¬['filelist'][]=$™Ëâ¯;}}$GLOBALS['path_from_auth_check']=!1;õÍ÷Ï²îĞÄæÃÀé™æ¥‘ñô°àÖÒ¹€‹ûùÏñÇìé˜ŸÙèäÁ­¥«ÆÑØÃÍ;$GLOBALS['path_type']=KOD_USER_FAV;$ìŒïÁ¬['path_read_write']='writeable';™è•¤äô×;return $ìŒïÁ¬;ğ‚ÚæŞˆŒŠÏ™Ü¨¨ öææ¦û€’¥õ¢šÍúû‘ìş®ÇåÏò™ ;}private function path_group(&$Éµ—À,$ç™ş÷¬){if($ç™ş÷¬==KOD_GROUP_ROOT_SELF){$îÏ=$this->_group_self();}else{$îÏ=$this->_group_tree('1');}$GLOBALS['path_from_auth_check']=!0;foreach($îÏ as $¼Ê¼=>$·»ı€){$ŒĞ=array('name' =>$·»ı€['name'],'menuType' =>"menuGroupRoot",'atime' =>'','ctime' =>'','mode' =>'','is_readable' =>0x001,'is_writeable' =>0x001,'exists' =>0x001,'path' =>$·»ı€['path'],'ext' =>$·»ı€['ext'],'type' =>'folder','open' =>!1,'isParent' =>!1);if($·»ı€['type']=='folder'){$Éµ—À['folderlist'][]=$ŒĞ;}else{$Éµ—À['filelist'][]=$ŒĞ;}}$GLOBALS['path_from_auth_check']=!1;$GLOBALS['path_type']=$ç™ş÷¬;ºÙ³ûö²ã‘;$Éµ—À['path_read_write']='writeable';return $Éµ—À;Ë—‰ÙÓØ’Ö’²âãÈ‰Õì¦ÆÚ¾ñĞ¿Î—›¯¤÷ƒ;}private function path($‹“ÔÆ,$‚Á=true,$üèèÄ=false){$öƒÑ=explode(',',$this->config['setting_system']['path_hidden']);·ã©ÓƒØ÷ûÜõ;$ğ=_DIR_OUT(iconv_app($‹“ÔÆ));ƒ¨ÇÅÅ®êŠòáÄÊâÖƒ;if($GLOBALS['path_type']==KOD_USER_SHARE&& strpos(trim($‹“ÔÆ,'/'),'/')===!1){$ğ=$‹“ÔÆ;}$ÖÊ=array('folderlist' =>array(),'filelist' =>array(),'info' =>array(),'path_read_write' =>'not_exists','this_path' =>$ğ);if(!file_exists($‹“ÔÆ)){$ÖÊ['path_read_write']="not_exists";}else if(path_writeable($‹“ÔÆ)){$ÖÊ['path_read_write']='writeable';}else if(path_writeable($‹“ÔÆ)){$ÖÊ['path_read_write']='readable';}else{$ÖÊ['path_read_write']='not_readable';}if($‹“ÔÆ===!1){return $ÖÊ;}else if($GLOBALS['path_type']==KOD_USER_SHARE&& !strstr(trim($this->in['path'],'/'),'/')){$ÖÊ=$this->path_share($ÖÊ);}else if($GLOBALS['path_type']==KOD_USER_FAV){$ÖÊ=$this->path_fav($ÖÊ);}else if($GLOBALS['path_type']==KOD_GROUP_ROOT_SELF){$ÖÊ=$this->path_group($ÖÊ,$GLOBALS['path_type']);}else if($GLOBALS['path_type']==KOD_GROUP_ROOT_ALL){$ÖÊ=$this->path_group($ÖÊ,$GLOBALS['path_type']);}else{$‚Á=path_list($‹“ÔÆ,$‚Á,!0);$ÖÊ['folderlist']=$‚Á['folderlist'];$ÖÊ['filelist']=$‚Á['filelist'];}$ÏÆ·Æ=array();$¨’óà=array();foreach($ÖÊ['filelist'] as $¨Û=>$î‹){if(in_array($î‹['name'],$öƒÑ))continue;$î‹['ext']=get_path_ext($î‹['name']);if($î‹['ext']=='oexe' && !isset($î‹['content'])){$ıê‡Ãµ=iconv_system($î‹['path']);$š¹±›=json_decode(@file_get_contents($ıê‡Ãµ),!0);if(is_array($š¹±›))$î‹=array_merge($î‹,$š¹±›);}$ÏÆ·Æ[]=$î‹;Â®§Öº…¸Ğ¡á­¿Ğ¸ÈÉ·³Ğúé»–£ì²´é©–¬×¾½¯øÂèÊäÊ÷¤›±íäé¢¶åŒñû°ß¯åÉÙüõ±»´áµ÷Ê€Ü;}foreach($ÖÊ['folderlist'] as $¨Û=>$î‹){if(in_array($î‹['name'],$öƒÑ))continue;$¨’óà[]=$î‹;}$ÖÊ['filelist']=$ÏÆ·Æ;ªï–”’;$ÖÊ['folderlist']=$¨’óà;¿öÏŸ¦¶è€³ß²ï••¥à¦éöŸë¨É;$ÖÊ=_DIR_OUT($ÖÊ);îÙÌĞŞì÷–ÖøÊ¶¬ºÌÁàÙ£‡Ãš¦°Âğ‚ĞüªŒÜúëÉó‚;$this->_role_check_info($ÖÊ);return $ÖÊ;™ˆ¤ÛèşşïÂ™—óÜ‰ŞÙıî„ŠË€õ–óø·àÅúÎ´Ö·³Ö¨öïÀêÍÉ;}private function _role_check_info(&$­¤êœ©){if(!$GLOBALS['path_type']){$­¤êœ©['info']=array("path_type"=>'',"role"=>'',"id"=>'','name'=>'');return;}$­¤êœ©['info']=array("path_type" =>$GLOBALS['path_type'],"role" =>$GLOBALS['is_root']?'owner':'guest',"id" =>$GLOBALS['path_id'],'name' =>'',);if($GLOBALS['path_type']==KOD_USER_SHARE){$GLOBALS['path_id']=explode(':',$GLOBALS['path_id']);$GLOBALS['path_id']=$GLOBALS['path_id'][0];$­¤êœ©['info']['id']=$GLOBALS['path_id'];$è©ëş=system_member::get_info($GLOBALS['path_id']);$­¤êœ©['info']['name']=$è©ëş['name'];if($GLOBALS['is_root']){$­¤êœ©['info']['admin_real_path']=USER_PATH.$è©ëş['path'].'/home/';}}if($GLOBALS['path_type']==KOD_GROUP_PATH|| $GLOBALS['path_type']==KOD_GROUP_SHARE){$¶€¬Æ=system_group::get_info($GLOBALS['path_id']);$­¤êœ©['info']['name']=$¶€¬Æ['name'];$úûÒ²°=system_member::user_auth_group($GLOBALS['path_id']);if($úûÒ²°=='write' || $GLOBALS['is_root']){$­¤êœ©['info']['role']='owner';$­¤êœ©['group_space_use']=$¶€¬Æ['config'];}if($GLOBALS['is_root']){$­¤êœ©['info']['admin_real_path']=GROUP_PATH.$¶€¬Æ['path'].'/home/';}}}}