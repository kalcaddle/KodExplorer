<?php class explorer extends Controller{public $path;public $user;public function __construct(){parent::__construct();$this->tpl=TEMPLATE.'explorer/';¸¾¸÷º Ä¡ô¿—äÂ‹Ûı—¯ö‹Ş¥;$this->user=$_SESSION['kod_user'];if(isset($this->in['path'])){$this->path=_DIR($this->in['path']);$this->check_system_path();}}public function index(){$È¶ä='';if(isset($this->in['path'])&& $this->in['path']!=''){$È¶ä=_DIR_CLEAR($_GET['path']);$È¶ä=rtrim($È¶ä,'/').'/';}$this->assign('dir',$È¶ä);if($this->config['forceWap']){$this->display('index_wap.php');}else{$this->display('index.php');}}private function check_system_path(){if(!in_array(ACT,array('mkfile','mkdir','search','pathCuteDrag','pathCopyDrag','pathPast','fileDownload'))){return;}if($GLOBALS['path_type']==KOD_USER_SHARE&& !strstr(trim($this->in['path'],'/'),'/')){show_json($this->L['error'],!1);}if(in_array($GLOBALS['path_type'],array(KOD_USER_FAV,KOD_GROUP_ROOT_ALL,KOD_GROUP_ROOT_SELF))){show_json($this->L['system_path_not_change'],!1);}}public function pathInfo(){$ÑéŒŠ=json_decode($this->in['list'],!0);ŒÉæ‰şæÌ;if(!$ÑéŒŠ){show_json($this->L['error'],!1);}foreach($ÑéŒŠ as &$Â){$Â['path']=_DIR($Â['path']);}$£òÂ=path_info_muti($ÑéŒŠ,$this->L['time_type_info']);if(!$£òÂ){show_json($this->L['not_exists'],!1);}if(count($ÑéŒŠ)==0x001&& $ÑéŒŠ[0]['type']!='folder'){if($GLOBALS['is_root']|| $GLOBALS['auth']['explorer:fileDownload']==0x001){$£òÂ['download_path']=_make_file_proxy($ÑéŒŠ[0]['path']);}$Ñç=$ÑéŒŠ[0]['path'];if($£òÂ['size']<0x064*0x00000400*0x00000400|| isset($this->in['get_md5'])){$£òÂ['file_md5']=@md5_file($Ñç);}else{$£òÂ['file_md5']="...";}$†°êâ=get_path_ext($Ñç);if(in_array($†°êâ,array('jpg','gif','png','jpeg','bmp'))){load_class('imageThumb');$½Ì÷Ç¹=imageThumb::imageSize($Ñç);if($½Ì÷Ç¹){$£òÂ['image_size']=$½Ì÷Ç¹;}}}$£òÂ['path']=_DIR_OUT($£òÂ['path']);ÆõÇĞô®ñè¤;show_json($£òÂ);¸“º¾ÄØª§Äçô¼°¯¹¾ô´½Ñªìï¬ŞØ;}public function pathChmod(){$Å…¤ı=json_decode($this->in['list'],!0);if(!$Å…¤ı){show_json($this->L['error'],!1);}$½İ¸è=octdec('0'.$this->in['mod']);$ü=0;‚«ôÁ¡õöŞÈ¢Ë¸Î«’Ÿñ—Äï°¤®İ—–Ûè“–ë¿‹®à¦ÀÊÈƒ—¹;$·=0;foreach($Å…¤ı as $üœ){$¡Êî€=_DIR($üœ['path']);Ì™ñ¹Øüçºşú;if(chmod_path($¡Êî€,$½İ¸è)){$ü++;}else{$·++;}}$Ö‰Î=$·==0?!0:!1;§í“¤‹ñÆÕáÆ¹ç¢†•¿Ú’§•’¶‘İ›¬ıİ‘¥Ì¤É×—­øÖæàùíâ;$­=$ü.' success,'.$·.' error';if(count($Å…¤ı)==0x001&& $·==0){$­=$this->L['success'];}show_json($­,$Ö‰Î);}public function mkfile(){$ÕÓ=BASIC_PATH.'static/others/newfile-tpl/';space_size_use_check();$“›¿='skip';if(isset($this->in['repeat_type'])){$“›¿=$this->in['repeat_type'];}$Ñ¾«õ=rtrim($this->path,'/');$Ñ¾«õ=get_filename_auto($Ñ¾«õ,'',$“›¿);if(@touch($Ñ¾«õ)){chmod_path($Ñ¾«õ,0777);if(isset($this->in['content'])){file_put_contents($Ñ¾«õ,$this->in['content']);}else{$=get_path_ext($Ñ¾«õ);$²ˆ=$ÕÓ.'newfile.'.$;if(file_exists($²ˆ)){$šéëˆÌ=file_get_contents($²ˆ);file_put_contents($Ñ¾«õ,$šéëˆÌ);}}space_size_use_change($Ñ¾«õ);ŒŞÔ™;show_json($this->L['create_success'],!0,_DIR_OUT(iconv_app($Ñ¾«õ)));Å¨Î¥ùÑï—Õş±ˆ‡¤¢ğª¾àÉ«í¨€‡íè¼´‘‹Ù;}else{show_json($this->L['create_error'],!1);}}public function mkdir(){space_size_use_check();$û±='skip';if(isset($this->in['repeat_type'])){$û±=$this->in['repeat_type'];}$ãŠƒˆ­=rtrim($this->path,'/');$ãŠƒˆ­=get_filename_auto($ãŠƒˆ­,'',$û±);²¦ºüÒ¨¦Ó°”¼íÉÎø¤Ù“ĞÖ;if(mk_dir($ãŠƒˆ­,0777)){chmod_path($ãŠƒˆ­,0777);show_json($this->L['create_success'],!0,_DIR_OUT(iconv_app($ãŠƒˆ­)));}else{show_json($this->L['create_error'],!1);}}public function pathRname(){$ÒÒª=_DIR($this->in['rname_to']);ŒÉÌäüó úÆÈ¡šù¶×ç€¦á¤õõØ»È«æ§;if(file_exist_case($ÒÒª)){show_json($this->L['name_isexists'],!1);}if(@rename($this->path,$ÒÒª)){show_json($this->L['rname_success'],!0,_DIR_OUT(iconv_app($ÒÒª)));}else{show_json($this->L['no_permission_write_all'],!1);}}public function search(){if(!isset($this->in['search']))show_json($this->L['please_inpute_search_words'],!1);$š=intval($this->in['is_content']);$æ™É=intval($this->in['is_case']);¢ƒå½ıœ•å¼ÈÂ¾¾¸—úÂá©ÄûİãöÙ;$±á=trim($this->in['ext']);if($GLOBALS['path_type']==KOD_USER_SHARE&& strstr($this->path,KOD_USER_SHARE)){show_json($this->L['path_cannot_search'],!1);}$Ÿ=path_search($this->path,iconv_system(rawurldecode($this->in['search'])),$š,$±á,$æ™É);show_json(_DIR_OUT($Ÿ));}public function pathList(){$µ™=$this->in['path'];if($µ™=="")$µ™='/';$á‚²¡º=$this->path($this->path);ıåÒúÃâŞ»½ìÛ€¢;if($this->path== MYHOME|| $this->path==HOME){$this->_self_root_load($á‚²¡º['folderlist']);}if($á‚²¡º['info']['path_type']==KOD_GROUP_PATH&& !strstr(trim(_DIR_CLEAR($this->in['path']),'/'),'/')){$this->_self_group_load($á‚²¡º['folderlist']);}$á‚²¡º['user_space']=$this->user['config'];show_json($á‚²¡º);„ÕïÃÉÒÅûó€Æ‘¼Ô£§‹æ‹ê¢È;}public function treeList(){$=$this->in['app'];if(isset($this->in['type'])&& $this->in['type']=='init'){$this->_tree_init($);}switch(trim(rawurldecode($this->in['path']))){case KOD_USER_FAV:show_json($this->_tree_fav(),!0);break;case KOD_GROUP_ROOT_SELF:show_json($this->_group_self(),!0);break;case KOD_GROUP_ROOT_ALL:show_json($this->_group_tree('1'),!0);break;default:break;}if((isset($this->in['tree_icon'])&& $this->in['tree_icon']!='groupPublic')&& !strstr(trim(rawurldecode($this->in['path']),'/'),'/')&&($GLOBALS['path_type']==KOD_GROUP_PATH|| $GLOBALS['path_type']==KOD_GROUP_SHARE)){$²=$this->_group_tree($GLOBALS['path_id']);show_json($²,!0);return;}$ª=_DIR($this->in['path']);if(!is_readable($ª))show_json($this->L['no_permission_read'],!1);$Œ=($=='editor'?!0:!1);$²=$this->path($ª,$Œ,!0);Ì•ÇÀ–ÑÒäâõíİ™Øââ‘ˆìÄ‘˜ÎšÇìå”ƒ­Õ™½¨ë¢;function sort_by_key($â,$ùÁ){if($â['name']==$ùÁ['name'])return 0;return($â['name']>$ùÁ['name'])?0x001:-0x001;}usort($²['folderlist'],"sort_by_key");¬¶Ôµ¤šÆ¼èãÖ±Ñ¼ÆÔêœí©ÅÙÌĞ½üËşÇŸÂóÖ˜©ú²;usort($²['filelist'],"sort_by_key");ÔÍ§Í”û¹±éâö;if($ª==MYHOME|| $ª==HOME){}if($=='editor'){$°È‚=array_merge($²['folderlist'],$²['filelist']);show_json($°È‚,!0);}else{show_json($²['folderlist'],!0);}}private function _self_group_load(&$”‚){foreach($”‚ as $´Äé‹Ü=>$‡){if($‡['name']=='share'){$”‚[$´Äé‹Ü]=array('name' =>$this->L['group_share'],'menuType' =>"menufolder folderBox",'ext' =>"folder_share",'isParent' =>!0,'is_readable' =>!0,'is_writeable' =>!0,'path' =>KOD_GROUP_PATH.':'.$GLOBALS['path_id'].'/share/','type' =>'folder','open' =>!1,'isParent' =>!1);break;}}$”‚=array_values($”‚);}private function _self_root_load(&$¿){foreach($¿ as $ÚĞ=>$‚ı×){if($‚ı×['name']=='share'){$¿[$ÚĞ]=array('name' =>$this->L['my_share'],'menuType' =>"menuTreeUser",'ext' =>"folder_share",'isParent' =>!0,'is_readable' =>!0,'is_writeable' =>!0,'path' =>KOD_USER_SHARE.':'.$this->user["user_id"].'/','type' =>'folder','open' =>!1,'isParent' =>!1);break;}}$¿=array_values($¿);·­ë€¯š•±ÊöùÕÓİã”ïî‹ò™ñäÙÚ¡’ˆ“¸§©ê·;if($this->config['user']['recycle_open']=="1"){}}private function _tree_fav(){$á±Ê¶À=($this->in['app']=='editor'?!0:!1);$ÕÆ=new fileCache(USER.'data/fav.php');$µ·º=$ÕÆ->get();©¬‡Ê¾×ÑÈşú´·ï–éºÍ«ãè«•;$àÍƒ=array();$GLOBALS['path_from_auth_check']=!0;foreach($µ·º as $ÍË=>$™‹È){$İ’ğØÆ=path_haschildren(_DIR($™‹È['path']),$á±Ê¶À);if(!isset($™‹È['type'])){$™‹È['type']='folder';}if(in_array($™‹È['type'],array('group'))){$İ’ğØÆ=!0;}$İ’„=array('name' =>$™‹È['name'],'ext' =>$™‹È['ext'],'menuType' =>"menuTreeFav",'path' =>$™‹È['path'],'type' =>$™‹È['type'],'open' =>!1,'isParent' =>$İ’ğØÆ);if(isset($™‹È['type'])&& $™‹È['type']!='folder'){$İ’„['ext']=$™‹È['type'];}$àÍƒ[]=$İ’„;}$GLOBALS['path_from_auth_check']=!1;return $àÍƒ;}private function _tree_init($”¿”ª‰){if($”¿”ª‰=='editor' && isset($this->in['project'])){$øŒš™¼=$this->path(_DIR($this->in['project']),!0,!0);$åô‚ğ½=array_merge($øŒš™¼['folderlist'],$øŒš™¼['filelist']);$ÎÏä¨—=array(array('name'=> get_path_this($this->in['project']),'children' =>$åô‚ğ½,'menuType' =>"menuTreeRoot",'ext' =>"folder",'path' =>$this->in['project'],'type' =>'folder','open' =>!0,'isParent' =>count($åô‚ğ½)>0?!0:!1));show_json($ÎÏä¨—);return;}$ñ=($”¿”ª‰=='editor'?!0:!1);$¡ö Şß=$this->_tree_fav($”¿”ª‰);$ôà=KOD_GROUP_PATH.':1/';if(system_member::user_auth_group(0x001)==!1){$ôà=KOD_GROUP_SHARE.':1/';}$Úµ…óñ=$this->path(_DIR($ôà),$ñ,!0);$ÙçñË¥=$this->path(_DIR(MYHOME),$ñ,!0);ËÃÚµƒû­¤ÛÙúƒ»¤í–ÚóŠÍããµÕ¯;if($ñ){$¼ÊÑ‰=array_merge($ÙçñË¥['folderlist'],$ÙçñË¥['filelist']);$ß=array_merge($Úµ…óñ['folderlist'],$Úµ…óñ['filelist']);}else{$¼ÊÑ‰=$ÙçñË¥['folderlist'];$ß=$Úµ…óñ['folderlist'];}$Äâßò=count($¼ÊÑ‰)>0?!0:!1;$»=count($ß)>0?!0:!1;$ÎÏä¨—=array('webroot'=>array(),'fav'=>array('name' =>$this->L['fav'],'ext' =>"treeFav",'menuType' =>"menuTreeFavRoot",'children' =>$¡ö Şß,'path' =>KOD_USER_FAV,'type' =>'folder','open' =>!0,'isParent' =>count($¡ö Şß)>0?!0:!1),'my_home'=>array('name' =>$this->L['root_path'],'menuType' =>"menuTreeRoot",'ext' =>"treeSelf",'children' =>$¼ÊÑ‰,'path' =>MYHOME,'type' =>'folder','open' =>!0,'isParent' =>$Äâßò),'public'=>array('name' =>$this->L['public_path'],'menuType' =>"menuTreeGroupRoot",'ext' =>"groupPublic",'children' =>$ß,'path' =>$ôà,'type' =>'folder','open' =>!0,'isParent' =>$»),'my_group'=>array('name' =>$this->L['my_kod_group'],'menuType' =>"menuTreeGroupRoot",'ext' =>"groupSelfRoot",'children' =>$this->_group_self(),'path' =>KOD_GROUP_ROOT_SELF,'type' =>'folder','open' =>!0,'isParent' =>!0),'group'=>array('name' =>$this->L['kod_group'],'menuType' =>"menuTreeGroupRoot",'ext' =>"groupRoot",'children' =>$this->_group_tree('1'),'path' =>KOD_GROUP_ROOT_ALL,'type' =>'folder','open' =>!0,'isParent' =>!0),);Û;if($”¿”ª‰=='editor'){unset($ÎÏä¨—['my_group']);unset($ÎÏä¨—['group']);unset($ÎÏä¨—['public']);if($GLOBALS['is_root']==0x001){$´¶æ¾„=$this->path(_DIR(WEB_ROOT),$ñ,!0);$£º¡=array_merge($´¶æ¾„['folderlist'],$´¶æ¾„['filelist']);$ÎÏä¨—['webroot']=array('name' =>"webroot",'menuType' =>"menuTreeRoot",'ext' =>"folder",'children' =>$£º¡,'path' =>WEB_ROOT,'type' =>'folder','open' =>!0,'isParent' =>!0);}}else{unset($ÎÏä¨—['webroot']);Ÿçç­ÈËò¬¬å´çæ—Ÿë´ûŞ;}$³Æ¨¸‘=array(); ‰‘¿ñùí»ÅàçòÇÚ¯´ú›é÷úÓ¬ÁûäÓÈØ‡éâ™©Ô“;foreach($ÎÏä¨— as $øøÌÁ=>$¨){if(count($¨['children'])<0x001&& in_array($øøÌÁ,array('my_group','group'))){continue;}$³Æ¨¸‘[]=$¨;}show_json($³Æ¨¸‘);´œ‰ˆÉÊ…®ŸÎˆ¦¸êÀâ¿;}private function _group_tree($úĞ­ô){$ú¶ß=system_group::load_data();$«È=$ú¶ß->get(array('parent_id',$úĞ­ô));$å¾è¯=$this->_make_node_list($«È);$Ş©¼æĞ=array();Ø’äÔâ“É­;if($úĞ­ô!='1'){$³=system_member::get_user_at_group($úĞ­ô);foreach($³ as $¹û=>$™á‚){$ïÒ­×£='user';if($™á‚['user_id']==$this->user['user_id']){$ïÒ­×£='userSelf';}$Ş©¼æĞ[]=array('name' =>$™á‚['name'],'menuType' =>"menuTreeUser",'ext' =>$ïÒ­×£,'path' =>KOD_USER_SHARE.':'.$™á‚['user_id'].'/','type' =>'folder','open' =>!1,'isParent' =>!1);}}$©µ=array_merge($å¾è¯,$Ş©¼æĞ);Ñ ®›Í¾ÛñÆ–í;return $©µ;}private function _group_self(){$ĞÄ=array();foreach($this->user['group_info'] as $í£ÓÁ=>$«äõÕ){if($í£ÓÁ=='1')continue;$ò’=system_group::get_info($í£ÓÁ);if($ò’){$ĞÄ[]=$ò’;}}return $this->_make_node_list($ĞÄ);á¤şİ–Åó…ì¤Ö²Ö¹ úâÌ¹ÈÃã¶¢šüÕ€Ş×¤İµ»;}private function _make_node_list($ªÁ){$Ï=array();if(!is_array($ªÁ)){return $Ï;}foreach($ªÁ as $¦Òå=>$ßÈ){$™‘³©ô=KOD_GROUP_PATH;$Ëç¡=system_member::user_auth_group($ßÈ['group_id']);if($Ëç¡==!1){$™‘³©ô=KOD_GROUP_SHARE;$ùµ¥='groupGuest';}else if($Ëç¡=='read'){$ùµ¥='groupSelf';}else{$ùµ¥='groupSelfOwner';}$ñÉ=!0;$´ÛªÌ=system_member::get_user_at_group($ßÈ['group_id']);if(count($´ÛªÌ)==0&& $ßÈ['children']==''){$ñÉ=!1;}$Ï[]=array('name' =>$ßÈ['name'],'type' =>'folder','path' =>$™‘³©ô.':'.$ßÈ['group_id'].'/','ext' =>$ùµ¥,'tree_icon' =>$ùµ¥,'menuType' =>"menuTreeGroup",'isParent' =>$ñÉ);}return $Ï;ô€;}public function pathDelete(){$äšá™=json_decode($this->in['list'],!0);çë;if(!is_dir(USER_RECYCLE)){mk_dir(USER_RECYCLE);}$÷³=$this->config['user']['recycle_open'];if(!path_writeable(USER_RECYCLE)){$÷³='0';}$®Ø=0;$¡£¸Õ=0;foreach($äšá™ as $£¡¶Â){$«Ã=_DIR($£¡¶Â['path']);Úª¢²®²š›ä“Î‘Â¨íãË;if($÷³!="1" || $GLOBALS['path_type']==KOD_GROUP_SHARE|| $GLOBALS['path_type']==KOD_GROUP_PATH|| $GLOBALS['path_type']==KOD_USER_RECYCLE){if($£¡¶Â['type']=='folder'){if(del_dir($«Ã))$®Ø++;else $¡£¸Õ++;}else{if(del_file($«Ã))$®Ø++;else $¡£¸Õ++;}space_size_use_reset();íÁ —íãşÂê©äØ;}else{$¸=USER_RECYCLE.get_path_this($«Ã);Ãëûò¸£­…¯‹óñ«‹ß›ßÓ‡Š¸¥âĞŞÖÌ«šÚ»‡×¯¿ûÜÅ«ç¹”Äş¥àŞøèé±Ì‚í;$¸=get_filename_auto($¸,date('-h:i:s'),'folder_rename');if(@rename($«Ã,$¸)){$®Ø++;}else{$¡£¸Õ++;}}}$š¿«Ö=$¡£¸Õ==0?!0:!1;‡;$âÍ«Ë‡=$®Ø.' success,'.$¡£¸Õ.' error';É†®©ş—“±¦ß³•…„¯Ä¯†‹³“³ğàŞ¼èª¶ó¤ä¤ü²Õ£’Š¸˜èÜ¾;if($¡£¸Õ==0){$âÍ«Ë‡=$this->L['remove_success'];}show_json($âÍ«Ë‡,$š¿«Ö);}private function clearTemp(){$èñüû¥=USER_TEMP;«Æ¯É;$¤îâÃ“=@filemtime($èñüû¥);„‰ó½¡ƒ¦ıÁ–æ´”ãÙ‚Áß­‰÷ˆ´æê÷úËíäĞöØ™Ü´—ŸËşÓàâ®â¥‘¯Š·Òğ£Ëìï¹ÑÀ±«ÎÊˆ„â¨Ğáû±Åª;if(time()-$¤îâÃ“>0x0258){del_dir($èñüû¥);mk_dir($èñüû¥);}}public function pathDeleteRecycle(){if(!isset($this->in['list'])){if(!del_dir(USER_RECYCLE)){show_json($this->L['remove_fali'],!1);}else{mkdir(USER_RECYCLE);$this->clearTemp();space_size_use_reset();show_json($this->L['recycle_clear_success'],!0);}}$ë=json_decode($this->in['list'],!0);$œ×=0;$«£÷ö=0;foreach($ë as $±â©ã){$¯—ı’À=_DIR($±â©ã['path']);€ºç–§¡½Ãøî˜¤’œ£ùÍ†£±•à­›óíêèªë¤“‚Ë´¿­¯§ÒÁ¸;if($±â©ã['type']=='folder'){if(del_dir($¯—ı’À))$œ×++;else $«£÷ö++;½ëÖî‚ôĞ¯Åú®ÉçÒÜéŸ‘ª®¿ÙÖ’›‚Â¿í;}else{if(del_file($¯—ı’À))$œ×++;else $«£÷ö++;}}space_size_use_reset();if(count($ë)==0x001){if($œ×)show_json($this->L['remove_success']);else show_json($this->L['remove_fali'],!1); ;}else{$Æ¾=$«£÷ö==0?!0:!1;show_json($this->L['remove_success'].$œ×.'success,'.$«£÷ö.'error',$Æ¾);É;}}public function pathCopy(){session_start();ö˜—¶òîÉşËÂŒşÜ¼îì½„Îªù×®Ã¼­´¶Åê©´´¸³ÉöÈÓÊ¸ÁˆÈÎ˜øˆï¨Ì­Æùáü¿Í§ô‚ß©„ª;$’ò=json_decode($this->in['list'],!0);µäõ…òşúş¨Ç­îÁì‚İ”ößô äŸÀö;$_SESSION['path_copy']=json_encode($’ò);$_SESSION['path_copy_type']='copy';show_json($this->L['copy_success'],ture,$_SESSION);¹¶ğ¬Åğ¨Ä™ïòˆ²ƒô´àŠ¬ÁşÌ¦²Ãòñ¯­¨¡Úî’ƒ³¬ó¦´¦ªªÛ;}public function pathCute(){session_start();$ˆÌ³=json_decode($this->in['list'],!0);ã’…¨…÷Ø³¡ú‘Äº…ëï¬–šˆ¡Ï‘í„æáÖËôÜóúÔÌ®õÈ¼‡ÖÎË‘Ô·Í›Šîë›İï‚;foreach($ˆÌ³ as $ÆÍ¶=>&$Â±){$Â±['path']=rawurldecode($Â±['path']);ïØö¯ìÃÀÁúÂÃÉŞÍ¸;_DIR($Â±['path']);ºëØ‚º¦ıÁŸ¡ç¿‡;}$_SESSION['path_copy']=json_encode($ˆÌ³);$_SESSION['path_copy_type']='cute';show_json($this->L['cute_success']);Æ›³ùÉÄêá€×»‚“Ê¨‘ŒÈ ®Øˆîà ›¬ù‹ò–¾„‘ÀÎÖ¬°Ö…ëØ˜·ªÄÉËò£Ôâ„ôş°ïŠ¤†;}public function pathCuteDrag(){$¨—Š=json_decode($this->in['list'],!0);©Ä»•ÔÍ €’êË† è’–çÃ†òç¼‘¤Ç‰“ı²×ºÈö–;$‚Ü=$this->path;$£”=$GLOBALS['path_type'];$šõÏ§³=$GLOBALS['path_id'];éßø¸´å¯ÅüÆÖ¦É³×Ú±ñşÅôæàê¶‰Ÿ˜Õšƒ¶” îÈ‡„åå«°™„‹Ëõ‹‘êòñÖ©ûõÂÒ‘;if(!path_writeable($this->path))show_json($this->L['no_permission_write'],!1);$‰¥æ=0;—ıòıãŸ®ı£ºÉ™ÅÛ…¸ÎÜâÊÓ¥äë¦ŠÒŸùÀ¶÷´´ÜÓãÛö¦‘ã‚–ĞòœÇ§¹¬“à·æ±¨¸ªÜíˆ°Ñã¨ï‹¹ÔÏ;$ŞÃóú‹=0;$¸°—=array();¢¿ÑÌ¿;foreach($¨—Š as $Î‘¹ö){$Å=_DIR($Î‘¹ö['path']);$ÒÉ²=get_path_this($Å);ÑÚäŠ‹ûú£•ãæê¦ÀÏ¸úÇ;$Àø‘=get_filename_auto($‚Ü.$ÒÉ²,'',$this->config['user']['file_repeat']);if($šõÏ§³!=$GLOBALS['path_id']){space_size_use_check();}if(move_path($Å,$Àø‘,'',$this->config['user']['file_repeat'])){$‰¥æ++;if($šõÏ§³!=$GLOBALS['path_id']){space_size_use_change($Àø‘);space_size_use_change($Àø‘,!1,$£”,$šõÏ§³);}$¸°—[]=_DIR_OUT(iconv_app($Àø‘));}else{$ŞÃóú‹++;Àšô“õÙ‚Ö™¥ì·‰Ó¢‹úâÚ³İ¢î›³—Üù×÷ïëîÊŠğ¢¤—;}}$Û=$ŞÃóú‹==0?!0:!1;$ı¬Şà=$‰¥æ.' success,'.$ŞÃóú‹.' error';if($ŞÃóú‹==0){$ı¬Şà=$this->L['success'];}show_json($ı¬Şà,$Û,$¸°—);}public function pathCopyDrag(){$ƒŞ=json_decode($this->in['list'],!0);Şà;$ü£ÈÈ=$this->path;$êÒÑ=$GLOBALS['path_type'];Ş¬Ÿ¾§ÒÍÒÕ¬šÚ¿ø»Ì°•ÉÔŞ“ƒ™şÕêù„İÙ±ı˜¿¦ë;$Á»”œú=$GLOBALS['path_id'];space_size_use_check();î’“Í¦—ç¥ìÒŸğ±ø¢¯’âÕığÏÀ­äİ¨ò·ğ²;if(!path_writeable($this->path))show_json($this->L['no_permission_write'],!1);$„Æ=0;ÜĞÊ°ğ¼áéŞ’üÂèû´¸¼ášŠ‘ÑûÄø‹î«;$Ìü´üí=0;ĞñÕ”ÚÑÈ”ª²©µÄû±‰õ²•åŞş²Û´°Ê¦£÷ƒøŒİËÔòÚ€¦…µê‚çô÷›‹İú‹‘;$¿Á¢å=array();Õ¾ê´‹¿§å¿Íêõ¹ìİ¯åù»ÄôÆÕÌ†˜îìê´ÊÀó¶ôşõå¶êĞ­¥;foreach($ƒŞ as $‹Õ¤){$‘=_DIR($‹Õ¤['path']);¿ÇŞØ¶ËÃë—„ßÍùßÄ—Åúƒ—©©Õ´şúºäµè¥ıÇı´“Á ªÆ÷Áá¼Ø§¸Ü¿á†•—…‘Ò–ö‰şœ‡Æ›¼;$İİ…¥=get_path_this($‘);Á»Àéô©×£¿î©ĞÂ¿ÇË¿äÓ†àŞíæ„Íåê¡«ø–É¢íìâİ—³¡Öûí–áÁâÑşÁÀæÅÌ±íİ—…§ºó”Ò«ÑóƒÎâš;$¤·=get_filename_auto($ü£ÈÈ.$İİ…¥,'',$this->config['user']['file_repeat']);if($this->in['filename_auto']==0x001&& trim($¤·,'/')==trim($‘,'/')){$¤·=get_filename_auto($ü£ÈÈ.$İİ…¥,'','folder_rename');}if(copy_dir($‘,$¤·)){$„Æ++;space_size_use_change($İİ…¥);$¿Á¢å[]=_DIR_OUT(iconv_app($¤·));}else{$Ìü´üí++;}}$¶Õ·œ=$Ìü´üí==0?!0:!1;äÙ«üŞÒ·ÓçÕ¦”¨›˜öı²§£é»š¡‘Ò¿­™ªûı„§úãú³·âŠŞ÷²ù©øÂÑœ¬;$ÎŸŠ=$„Æ.' success,'.$Ìü´üí.' error';if($Ìü´üí==0){$ÎŸŠ=$this->L['success'];}show_json($ÎŸŠ,$¶Õ·œ,$¿Á¢å);}public function clipboard(){$£¹É¡=json_decode($_SESSION['path_copy'],!0);if(!$£¹É¡){$£¹É¡=array();}show_json($£¹É¡,!0,$_SESSION['path_copy_type']);}public function pathPast(){if(!isset($_SESSION['path_copy'])){show_json($this->L['clipboard_null'],!1,array());}$¡ëÑÙ=$this->path;session_start();Ç³×¹­›ŒÊÈš‚—¹Œ¦‡¯ßÑÑÃï¿°Áš€ÓÈ®ˆ;$èµ='';$€†‚=array();Ğ¾¤£‘Áæ‚—Ã;$˜á=json_decode($_SESSION['path_copy'],!0);øƒù®Àî¯Æş²ã;$Á¨™=$_SESSION['path_copy_type'];$¼’¤=$GLOBALS['path_type'];$¯Ó¹ =$GLOBALS['path_id'];if(!path_writeable($¡ëÑÙ))show_json($this->L['no_permission_write'],!1,$€†‚);$GLOBALS['path_from_auth_check']=!0;ÅÉøµø¿´¬¤üíÍ—;$›Ó«÷=count($˜á);if($›Ó«÷==0){show_json($this->L['clipboard_null'],!1,$€†‚);}for($´ëî=0;$´ëî<$›Ó«÷;$´ëî++){$¥=_DIR($˜á[$´ëî]['path']);_DIR($this->in['path']);$ªö¶óï=get_path_this($¥);¡šÕ‰¤µ÷¿Šùëƒª·û™À¡©ş“ÓöÊÈæ·¶˜ÙĞî;$Ù“®ÒÒ=iconv_app($ªö¶óï);if(!file_exists($¥)){$èµ.= "<li>{$Ù“®ÒÒ}".$this->L['copy_not_exists']."</li>";continue;İéõÙƒ·û¬¶­ÙÉ•’®ëÒä­°”€„;}if($˜á[$´ëî]['type']=='folder'){if($¥==substr($¡ëÑÙ,0,strlen($¥))){$èµ.="<em style='color:#fff;'>{$Ù“®ÒÒ}".$this->L['current_has_parent']."</em>";continue;Œ¬¬‚†°¹‚İğ‘ŞŸë©µıªãêüÏª²ä«¶³ùø¿§¦Â;}}$×û=get_filename_auto($¡ëÑÙ.$ªö¶óï,'',$this->config['user']['file_repeat']);$ªö¶óï=get_path_this($×û);if($Á¨™=='copy'){space_size_use_check();copy_dir($¥,$×û);space_size_use_change($ªö¶óï);}else{if($¯Ó¹ !=$GLOBALS['path_id']){space_size_use_check();}move_path($¥,$×û,'',$this->config['user']['file_repeat']);if($¯Ó¹ !=$GLOBALS['path_id']){space_size_use_change($ªö¶óï);space_size_use_change($ªö¶óï,!1,$¼’¤,$¯Ó¹ );}}$€†‚[]=_DIR_OUT(iconv_app($×û));­¿Â¬ê§˜ç¨;}if($Á¨™=='copy'){$“ÚÍ¿’=$this->L['past_success'].$èµ;}else{$_SESSION['path_copy']=json_encode(array());$_SESSION['path_copy_type']='';$“ÚÍ¿’=$this->L['cute_past_success'].$èµ;}$º=($èµ==''?!0:!1);show_json($“ÚÍ¿’,$º,$€†‚);}public function fileDownload(){file_put_out($this->path,!0);ƒ‹€¿ÀîÖü¯–ÀÜçôé‘İıì¬½ş­ø‹îÚ¾ò;}public function fileDownloadRemove(){$ÉóªŠâ=rawurldecode(_DIR_CLEAR($this->in['path']));$ÉóªŠâ=USER_TEMP.iconv_system($ÉóªŠâ);÷ ¹øˆ®âšà‡¹Ÿ†ç˜‘ÖóÏÊŞš¾Š¤¡¶†‚“ş£Ì÷¬ûÛÆ‰½ÍÃÜÓ«õåƒé¶ÍÉĞŒÓõ;space_size_use_change($ÉóªŠâ,!1);file_put_out($ÉóªŠâ,!0);del_file($ÉóªŠâ);ûÔëôèĞÇò•¶;}public function zipDownload(){if(!file_exists(USER_TEMP)){mkdir(USER_TEMP);}else{$éââĞæ=path_list(USER_TEMP,!0,!1);$‡µ—×=0x0e10*0x0000018;if($éââĞæ['filelist']>=0x001){for($êÎğ=0;$êÎğ<count($éââĞæ['filelist']);$êÎğ++){$Ë£–È÷=$éââĞæ['filelist'][$êÎğ]['mtime'];if(time()-$Ë£–È÷>$‡µ—×){del_file($éââĞæ['filelist'][$êÎğ]['path'].$éââĞæ['filelist'][$êÎğ]['name']);}}}}$½=$this->zip(USER_TEMP);ÁßÖ—ŠÁúí’á;show_json($this->L['zip_success'],!0,get_path_this($½));}public function zip($˜Ñ=''){load_class('pclzip');ÁÌµïÌÖçÏ•á¼¤£œÂù´Í¼¯»Ï‘öé©ÉÜ„ˆÑ½¬Á‹;ini_set('memory_limit','2028M');$Û™=json_decode($this->in['list'],!0);$µ=count($Û™);for($Îæš‹¶=0;$Îæš‹¶<$µ;$Îæš‹¶++){$Û™[$Îæš‹¶]['path']=rtrim(_DIR($Û™[$Îæš‹¶]['path']),'/');}$¡=$˜Ñ;ÚÔ¬“ÉîŸÎ™úç¥”¥ÔÊ§€µöæÏ‚û…¿ÑÑ¾¬§ÛÙ»¦ÈÚôâÕÜˆêƒİµªİê¡Å»¤ã·©¤‰ûâ¶¤;if($˜Ñ==''){$¡=get_path_father($Û™[0]['path']);}if(!is_writeable($¡)){show_json($this->L['no_permission_write'],!1);}if($µ==0x001){$àå=get_path_this($Û™[0]['path']);}else{$àå=get_path_this(get_path_father($Û™[0]['path']));}$»Ú¼’=$¡.$àå.'.zip';$»Ú¼’=get_filename_auto($»Ú¼’,'',$this->config['user']['file_repeat']);space_size_use_check();£³å‚ˆÇÙ¬¬‘ÖĞ›Ó´Ñ÷óâÙÙ½•´ù¨ìÀ¦¨ãÙæø–®ÓÃÛäš­í;$ÓæÖ¶=array();ÖåîşÓ¯¥û”€Šúø¡ªÌä†²€³³î–‡Õì¾—Ÿ³í…£íÙÒ”Õç”à;for($Îæš‹¶=0;$Îæš‹¶<$µ;$Îæš‹¶++){if(file_exists($Û™[$Îæš‹¶]['path'])){$ÓæÖ¶[]=$Û™[$Îæš‹¶]['path'];}}if(count($ÓæÖ¶)==0){show_json($this->L['not_exists'],!1);}$ƒÚ=new PclZip($»Ú¼’);foreach($ÓæÖ¶ as $•èÉÂ=>$ßÉ®Í){$½´òà£=_DIR_CLEAR(get_path_father($ßÉ®Í));£œÍ„Û‡·ï¥ÅØïˆ±ÏÒßÜ;if($•èÉÂ==0){$Œš=$ƒÚ->create($ßÉ®Í,PCLZIP_OPT_REMOVE_PATH,$½´òà£,PCLZIP_CB_PRE_FILE_NAME,'zip_pre_name');continue;}$Œš=$ƒÚ->add($ßÉ®Í,PCLZIP_OPT_REMOVE_PATH,$½´òà£,PCLZIP_CB_PRE_FILE_NAME,'zip_pre_name');}space_size_use_change($»Ú¼’);ıÌ¯¶ïÌ„ôÎßüŞ˜ì…İÆôå÷Å¹×ã–ıï°Øï¬Ö¼Ü­©’£÷ò ×‹ÜèÔÑÏÍ—‰¥ûŸ£ëĞüÜüÓšÚáÇ„ôêüçŒÕòš²Üî„¬¼œ¶â˜Ö‡…§„á¥Øü€»;if($Œš==0){show_json("Create error!",!1);}$…°°=$this->L['zip_success'].$this->L['size'].":".size_format(filesize($»Ú¼’));if($˜Ñ==''){show_json($…°°,!0,_DIR_OUT(iconv_app($»Ú¼’)));}else{return iconv_app($»Ú¼’);}}public function unzip(){ini_set('memory_limit','2028M');$Œ×Œè=$this->path;„­Ìç;$¤îÌ=get_path_this($Œ×Œè);ñÌ¬òˆñø¹£ûÒàÕŞ¸áÈ€óŞ…¡¬ìèĞÛµÏä‘ƒ;$¤îÌ=substr($¤îÌ,0,strrpos($¤îÌ,'.'));$û=get_path_ext($Œ×Œè);²ˆÎ‘À±ÙÁ¥¹ÆÇæ³±·æÕàÌåıŞè¤áå„‰Ş¶‘®ÇÒ;$¢”†Ü=get_path_father($Œ×Œè).$¤îÌ;ûŸçÑ€µ·ş”¡£öˆ§æŞ“–§åöÉúı§ÖÍëåÎç…·;if(isset($this->in['to_this'])){$¢”†Ü=get_path_father($Œ×Œè);}if(isset($this->in['path_to'])){$¢”†Ü=_DIR($this->in['path_to']);}if(!is_writeable(get_path_father($Œ×Œè))){show_json($this->L['no_permission_write'],!1);}space_size_use_check();load_class('pclzip');$ì=new PclZip($Œ×Œè);”;$øœ=$ì->extract(PCLZIP_OPT_PATH,$¢”†Ü,PCLZIP_OPT_SET_CHMOD,0777,PCLZIP_CB_PRE_FILE_NAME,'unzip_pre_name',PCLZIP_CB_PRE_EXTRACT,"check_ext_unzip",PCLZIP_OPT_REPLACE_NEWER);¯šÖ;if($øœ==0){show_json("Error : ".$ì->errorInfo(!0),fasle);}else{space_size_use_change($Œ×Œè);show_json($this->L['unzip_success']);}}public function imageRotate(){load_class('imageThumb');îÉÅİµ;$¬=new imageThumb($this->path,'file');$×¸ÑÊ=$¬->imgRotate($this->path,intval($this->in['rotate']));if($×¸ÑÊ){show_json($this->L['success']);}else{show_json($this->L['error'],!1);}}public function image(){if(filesize($this->path)<=0x00000400*0x014|| !function_exists('imagecolorallocate')){file_put_out($this->path);return;}if(!is_dir(DATA_THUMB)){mk_dir(DATA_THUMB);}load_class('imageThumb');$ŞçÌú=$this->path;$şéÔ=@md5_file($ŞçÌú);if(strlen($şéÔ)<0x05){$şéÔ=md5($ŞçÌú);}$É«ã=DATA_THUMB.$şéÔ.'.png';if(!file_exists($É«ã)){if(get_path_father($ŞçÌú)==DATA_THUMB){$É«ã=$this->path;}else{$»­ş=new imageThumb($ŞçÌú,'file');$»­ş->prorate($É«ã,0x0fa,0x0fa);}}if(!file_exists($É«ã)|| filesize($É«ã)<0x064){$É«ã=$this->path;}file_put_out($É«ã);}public function serverDownload(){set_time_limit(0);$«Æ‚İ='download_'.$this->in['uuid'];if($this->in['type']=='percent'){if(isset($_SESSION[$«Æ‚İ])){$–ı¥Õ=$_SESSION[$«Æ‚İ];$„½Ÿ€=array('uuid' =>$this->in['uuid'],'length' =>(int)$–ı¥Õ['length'],'name' =>$–ı¥Õ['name'],'size' =>(int)@filesize(iconv_system($–ı¥Õ['path'])),'time' =>mtime());show_json($„½Ÿ€);}else{show_json('',!1);}}else if($this->in['type']=='remove'){del_file($_SESSION[$«Æ‚İ]['path']);unset($_SESSION[$«Æ‚İ]);show_json('',!1);}$æ€á¼š=_DIR($this->in['save_path']);if(!is_writeable($æ€á¼š)){show_json($this->L['no_permission_write'],!1);}$†Å=rawurldecode($this->in['url']);$µ=url_header($†Å);if(!$µ){show_json($this->L['download_error_exists'],!1);}$æ€á¼š=$æ€á¼š.$µ['name'];if(!checkExt($æ€á¼š)){$æ€á¼š=_DIR($this->in['save_path']).date('-h:i:s').'.txt';}space_size_use_check();$æ€á¼š=get_filename_auto(iconv_system($æ€á¼š),'',$this->config['user']['file_repeat']);$ê=$æ€á¼š.'.downloading';õß›¶à ó€ ëæ Î£º;session_start();ø;$_SESSION[$«Æ‚İ]=array('length'=> $µ['length'],'path' =>$ê,'name' =>get_path_this($æ€á¼š));¨ È”…;session_write_close();Ù½¤ôó…•è…¶ÕëÖ¤;if(file_download_this($†Å,$ê,$µ['length'])){session_start();unset($_SESSION[$«Æ‚İ]);session_write_close();if(@rename($ê,$æ€á¼š)){$’=get_path_this(iconv_app($æ€á¼š));space_size_use_change($æ€á¼š);show_json($this->L['download_success'],!0,_DIR_OUT(iconv_app($æ€á¼š)));}else{show_json($this->L['download_error_create'],!1);}}else{session_start();unset($_SESSION[$«Æ‚İ]);session_write_close();show_json($this->L['download_error_create'],!1);}}public function officeView(){if(!file_exists($this->path)){show_tips($this->L['not_exists']);}$˜¿=get_path_ext($this->path);$¸ˆà=_make_file_proxy($this->path);if(defined("OFFICE_KOD_SERVER")){$¾ÓÆûø=APPHOST.'index.php?explorer/fileProxy&path='.$this->in['path'];$ğıÑ='&appMode=edit&access_token='.session_id();if(OFFICE_KOD_ACTION=='read'){$ğıÑ='&appMode=view';$¾ÓÆûø=_make_file_proxy($this->path);}$ƒˆ°ï=$_SESSION['kod_user'];$Õ€òì=rand_string(0x0a);$ı=OFFICE_KOD_SERVER.rawurlencode($¾ÓÆûø).'&lang='.LANGUAGE_TYPE.'&appType=desktop'.$ğıÑ.'&file_time='.@filemtime($this->path).'&user_id='.$ƒˆ°ï['user_id'].'&user_name='.$ƒˆ°ï['name'].'&app_id='.OFFICE_KOD_APP_ID.'&app_s='.$Õ€òì.'&app_v='.md5($Õ€òì.OFFICE_KOD_APP_KEY);ª×Æ‹—³ÉêúÆã·¸â‰“;header("location:".$ı);Öñ›×äˆ’ë†ïŒÄ›;exit;ûÀğç»¸;}if(file_exists(PLUGIN_DIR.'officeView')){if(isset($_GET['is_edit'])|| !isset($this->config['settings']['office_server_doc2pdf'])){include(PLUGIN_DIR.'officeView/index.php');}else{include(PLUGIN_DIR.'officeView/flexpapper.php');}exit;}$òğ¯=$_SERVER['HTTP_HOST'];Êí;if(strpos(OFFICE_SERVER,'view.officeapps.live.com')===-0x001|| strstr($òğ¯,'10.10.')|| strstr($òğ¯,'192.168.')|| strstr($òğ¯,'127.0.')|| !strstr($òğ¯,'.')){$å=$this->L['unknow_file_office'];show_tips($å);}else{$ı=OFFICE_SERVER.rawurlencode($¸ˆà);header("location:".$ı);}}public function officeSave(){$çíØ=_DIR($this->in['path']);áºäÆÆŒÂ‡üªÃµö·§§µ­¾Å÷¬Èİó±ÌÌ‡Â–èüú¯Ã‡òË…»•Çã¼ü‘ûÂ‰©‹;if(isset($this->in['from_activex'])){if($_FILES["file"]["error"]>0){echo "Return Code: ".$_FILES["file"]["error"];}else{move_uploaded_file($_FILES["file"]["tmp_name"],$this->path);echo 'succeed';}exit;}if(!is_writeable($çíØ)){$this->json_putout(array('error'=>'no_permission_write'));}if(($½µéÄ=file_get_contents('php://input'))===!1){$this->json_putout(array('error'=>'Bad Request'));}$€­õûÜ=json_decode($½µéÄ,!0);if($€­õûÜ===NULL){$this->json_putout(array('error'=>'Bad Response'));}$„Ï†=array(0=>'NotFound',0x001=>'Editing',0x0002=>'MustSave',0x00003=>'Corrupted',0x000004=>'Closed');$í=array('error'=>0,'action'=>$„Ï†[$€­õûÜ["status"]]);switch($„Ï†[$€­õûÜ["status"]]){case "MustSave":case "Corrupted":$í["c"]="saved";©ÁÚº½Äæ©­;$í['status']='0';if(file_download_this($€­õûÜ["url"],$çíØ)){$í['status']='success';}break;default:break;«ÜïÙÒë¶ğ‡“úõ©Àùˆê»â¦ù€êàª™å‘üÔ½ÙÅ—­±Îº£ÖÎÌøŞÇÊ„ãğıäÛßõÆ¢òœßÍá÷ú”Æ¶·;}$this->json_putout($í);}private function json_putout($Õ){@header('Content-Type: application/json; charset==utf-8');³€·äğ¶ÊÍ—ÚÃİü·úİ…ÜÕğ·¨»½ş§½´Ú¾µ“£§ÊîôáÊ¹;@header('X-Robots-Tag: noindex');»¦ö™üøŠš±²Õî±ü¬æØêœìÃ·ş¹šÉóÛ“å˜¹Ü±¶Ö»Ñˆî§÷¡¥¤ˆş¥ë é¤ ;@header('X-Content-Type-Options: nosniff');echo json_encode($Õ);exit;ıı³·Ûä;}public function fileProxy(){$²¡À»=isset($this->in['download']);ØºéßúŠÉŸªíŞ–‡ù”…;file_put_out($this->path,$²¡À»);}public function fileUpload(){$à“»=_DIR($this->in['upload_to']);if(!is_writeable($à“»))show_json($this->in['upload_to'],!1);if($à“»=='')show_json($this->L['upload_error_big'],!1);if(strlen($this->in['fullPath'])>0x001){$ûÏÅ=_DIR_CLEAR(rawurldecode($this->in['fullPath']));$ûÏÅ=get_path_father($ûÏÅ);$ûÏÅ=iconv_system($ûÏÅ);if(mk_dir($à“».$ûÏÅ)){$à“»=$à“».$ûÏÅ;}}$ƒöôÛ=$this->config['user']['file_repeat'];$€=USER_TEMP;ûËş’Òù¦×¨ò¸»®Ìğ«œ¶‘ ;mk_dir($€);if(!is_writeable($€))show_json($this->L['no_permission_write'],!1);upload_chunk('file',$à“»,$€,$ƒöôÛ);}private function path_share(&$àŒÂòŒ){$›=explode(',',$GLOBALS['path_id']);$í¦=system_member::user_share_list($›[0]);»€‹êÍû—ê³©‹á°ˆÂ½Ê¶Éİ†õí¢¢‘ÈÙ×—–Ø£¦ ™;$Ó=$GLOBALS['path_id_user_share'];ó¥ù±ï°úÎ·ñ½Ú•;foreach($í¦ as $ëİ§Ä=>$½™¿Ä){$ØÖ=_DIR(KOD_USER_SHARE.':'.$›[0].'/'.$½™¿Ä['name']);$½™¿Ä['path']=$½™¿Ä['name'];™¿ÂŠğ¾Ù©;$½™¿Ä['atime']='';$½™¿Ä['ctime']='';$½™¿Ä['mode']='';$½™¿Ä['is_readable']=0x001;¤µ›ËÓµŒ™ïäïşãÄ’ı…Ô‰ö“â Äú¥‹à–¯îÌËº¡Æºñ¬ªğ®µÀº–—±ªùÒîô÷úÖ«ÅÛö€üøÇ·êó;$½™¿Ä['is_writable']=0x001;ñ’ã€Íú—€¥’Ò•‡ËİÚ¼¤¶³;$½™¿Ä['exists']=intval(file_exists($ØÖ));$½™¿Ä['meta_info']='path_self_share';$½™¿Ä['menuType']="menuSharePath";if(get_path_ext($½™¿Ä['name'])=='oexe'){$ë˜àÎô=json_decode(@file_get_contents($ØÖ),!0);if(is_array($ë˜àÎô))$½™¿Ä=array_merge($½™¿Ä,$ë˜àÎô);}if($½™¿Ä['type']=='folder'){$½™¿Ä['ext']='folder';$àŒÂòŒ['folderlist'][]=$½™¿Ä;}else{$àŒÂòŒ['filelist'][]=$½™¿Ä;}}$àŒÂòŒ['path_read_write']='readable';$GLOBALS['path_id_user_share']=$Ó;ÁÕãØÕŠê© òô±Ñ;if($›[0]==$this->user['user_id']){$àŒÂòŒ['share_list']=$í¦;}return $àŒÂòŒ;}private function path_fav(&$íõ†¢){$ºÏ=new fileCache(USER.'data/fav.php');$çé=$ºÏ->get();¶å×÷»»Ñ‘Æ½ºæ±¯˜ƒş‡ù†©–ÀøæáˆÜ¿ö”¥Îá‹ŞòÑ®¹ÎİÒÒİÙÌä„â¥ü‚ßŠê ‚şÆĞ;$GLOBALS['path_from_auth_check']=!0;foreach($çé as $ëœ®Š=>$çØ©){$«‡•=_DIR($çØ©['path']);Ü’˜ß ÷ê‹™ì‹ß½˜‰š„¥;$ğ±=path_haschildren($«‡•,$šì”¡ƒ);if(!isset($çØ©['type'])){$çØ©['type']='folder';}if($çØ©['type']=='folder' && $çØ©['ext']!='treeFav'){$ğ±=!0;}$=array('name' =>$çØ©['name'],'ext' =>$çØ©['ext'],'menuType' =>"menuFavPath",'atime' =>'','ctime' =>'','mode' =>'','is_readable' =>0x001,'is_writeable' =>0x001,'exists' =>intval(file_exists($«‡•)),'meta_info' =>'treeFav','path' =>$çØ©['path'],'type' =>$çØ©['type'],'open' =>!1,'isParent' =>!1);if(strstr($çØ©['path'],KOD_USER_SHARE)|| strstr($çØ©['path'],KOD_USER_FAV)|| strstr($çØ©['path'],KOD_GROUP_ROOT_SELF)|| strstr($çØ©['path'],KOD_GROUP_ROOT_ALL)){$['exists']=0x001;}if(get_path_ext($çØ©['name'])=='oexe'){$¡µÊÁ®=json_decode(@file_get_contents($«‡•),!0);if(is_array($¡µÊÁ®))$çØ©=array_merge($çØ©,$¡µÊÁ®);}if($çØ©['type']=='folder'){$íõ†¢['folderlist'][]=$;}else{$íõ†¢['filelist'][]=$;}}$GLOBALS['path_from_auth_check']=!1;$GLOBALS['path_type']=KOD_USER_FAV;×¨àï²ûôØÄ„Éõìäã†;$íõ†¢['path_read_write']='writeable';„ú¶º;return $íõ†¢;üÅ²¡Úƒş„çÃ‰±ºö–÷†‰³‹„êÆËã°ÉªâêÈ¾î×ÌíÜ´²ææíİıŒÖ›“ßÏãºä°•úÉøæ’·Õê„ÃÇ¹õ® äŒ;}private function path_group(&$âº…ÂŠ,$§Å){if($§Å==KOD_GROUP_ROOT_SELF){$Ø=$this->_group_self();}else{$Ø=$this->_group_tree('1');}$GLOBALS['path_from_auth_check']=!0;foreach($Ø as $ŸÓ®˜=>$ÁÏ‘){$ÔÕ=array('name' =>$ÁÏ‘['name'],'menuType' =>"menuGroupRoot",'atime' =>'','ctime' =>'','mode' =>'','is_readable' =>0x001,'is_writeable' =>0x001,'exists' =>0x001,'path' =>$ÁÏ‘['path'],'ext' =>$ÁÏ‘['ext'],'type' =>'folder','open' =>!1,'isParent' =>!1);£¯±¯Î£“‰¨Ö”Ì;if($ÁÏ‘['type']=='folder'){$âº…ÂŠ['folderlist'][]=$ÔÕ;}else{$âº…ÂŠ['filelist'][]=$ÔÕ;}}$GLOBALS['path_from_auth_check']=!1;×¿õ¬îç°ŞùÜ³ÏÑÂœôñÍ¤Àñ¸Êšßæ»½åû´“êÃû›¢õøÖÆÊ™â¿Œ±ä;$GLOBALS['path_type']=$§Å;˜¾­ø¦»´ä¢;$âº…ÂŠ['path_read_write']='writeable';return $âº…ÂŠ;}private function path($œÜ²,$€¨±=true,$îüğÒ=false){$ü…£=explode(',',$this->config['setting_system']['path_hidden']);ãçîÜª’òÌÂƒßê¶˜êŞÉÂ;$Ç³¢…=_DIR_OUT(iconv_app($œÜ²));if($GLOBALS['path_type']==KOD_USER_SHARE&& strpos(trim($œÜ²,'/'),'/')===!1){$Ç³¢…=$œÜ²;}$¨ú=array('folderlist' =>array(),'filelist' =>array(),'info' =>array(),'path_read_write' =>'not_exists','this_path' =>$Ç³¢…);if(!file_exists($œÜ²)){$¨ú['path_read_write']="not_exists";}else if(path_writeable($œÜ²)){$¨ú['path_read_write']='writeable';}else if(path_writeable($œÜ²)){$¨ú['path_read_write']='readable';}else{$¨ú['path_read_write']='not_readable';}if($œÜ²===!1){return $¨ú;}else if($GLOBALS['path_type']==KOD_USER_SHARE&& !strstr(trim($this->in['path'],'/'),'/')){$¨ú=$this->path_share($¨ú);}else if($GLOBALS['path_type']==KOD_USER_FAV){$¨ú=$this->path_fav($¨ú);}else if($GLOBALS['path_type']==KOD_GROUP_ROOT_SELF){$¨ú=$this->path_group($¨ú,$GLOBALS['path_type']);}else if($GLOBALS['path_type']==KOD_GROUP_ROOT_ALL){$¨ú=$this->path_group($¨ú,$GLOBALS['path_type']);}else{$€¨±=path_list($œÜ²,$€¨±,!0);$¨ú['folderlist']=$€¨±['folderlist'];$¨ú['filelist']=$€¨±['filelist'];}$éŞ¸Ø=array();$Ç„Î=array();foreach($¨ú['filelist'] as $’ÈÕñ=>$ŒŠ){if(in_array($ŒŠ['name'],$ü…£))continue;$ŒŠ['ext']=get_path_ext($ŒŠ['name']);»œ•İ¢Å†ËÁÖ¶¡İ×”¬“å¿Û»±È¼¯´‘‘ï®¦ÍÑìÔ®«ÔÏ¼ä®•øÛ©ß›†œ;if($ŒŠ['ext']=='oexe' && !isset($ŒŠ['content'])){$–äŠÅ=iconv_system($ŒŠ['path']);$›Ö=json_decode(@file_get_contents($–äŠÅ),!0);if(is_array($›Ö))$ŒŠ=array_merge($ŒŠ,$›Ö);}$éŞ¸Ø[]=$ŒŠ;}foreach($¨ú['folderlist'] as $’ÈÕñ=>$ŒŠ){if(in_array($ŒŠ['name'],$ü…£))continue;$Ç„Î[]=$ŒŠ;œê­ºšÙê—ô™¬îõÖÎ‘ÜëŞóĞé¹ê†‘õĞÎíúü©–×¸î®›œ’òì£ÏØƒÄªìş–óŒÄ¡Û³ÙÜ³±•;}$¨ú['filelist']=$éŞ¸Ø;$¨ú['folderlist']=$Ç„Î;$¨ú=_DIR_OUT($¨ú);áã¯Îˆ€¨ŒÄÒøÃèìÔõ²öÑå”«ÂÈİØııĞ»€´;$this->_role_check_info($¨ú);ë÷È±ËÂõµ°Ë«ãÂıÊÖªŸˆæ‡…îÂ…£®Õà›;return $¨ú;šíÃĞŸûƒÑúÍ©¦ÛÉ¯Âç¶È×øÎû¨;}private function _role_check_info(&$İÃ){if(!$GLOBALS['path_type']){$İÃ['info']=array("path_type"=>'',"role"=>'',"id"=>'','name'=>'');return;}$İÃ['info']=array("path_type" =>$GLOBALS['path_type'],"role" =>$GLOBALS['is_root']?'owner':'guest',"id" =>$GLOBALS['path_id'],'name' =>'',);if($GLOBALS['path_type']==KOD_USER_SHARE){$GLOBALS['path_id']=explode(':',$GLOBALS['path_id']);$GLOBALS['path_id']=$GLOBALS['path_id'][0];$İÃ['info']['id']=$GLOBALS['path_id'];$ˆ‘õÔ=system_member::get_info($GLOBALS['path_id']);$İÃ['info']['name']=$ˆ‘õÔ['name'];if($GLOBALS['is_root']){$İÃ['info']['admin_real_path']=USER_PATH.$ˆ‘õÔ['path'].'/home/';}}if($GLOBALS['path_type']==KOD_GROUP_PATH|| $GLOBALS['path_type']==KOD_GROUP_SHARE){$–ãÛ™=system_group::get_info($GLOBALS['path_id']);$İÃ['info']['name']=$–ãÛ™['name'];$×çà=system_member::user_auth_group($GLOBALS['path_id']);if($×çà=='write' || $GLOBALS['is_root']){$İÃ['info']['role']='owner';$İÃ['group_space_use']=$–ãÛ™['config'];}if($GLOBALS['is_root']){$İÃ['info']['admin_real_path']=GROUP_PATH.$–ãÛ™['path'].'/home/';}}}}