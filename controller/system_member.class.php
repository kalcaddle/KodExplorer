<?php class system_member extends Controller{public static $static_sql=null;private $sql;function __construct(){parent::__construct();$this->tpl=TEMPLATE.'member/';»¨¦È½Óëçï“ùû«Ÿ°ã³û³ï;$this->sql=self::load_data();}public static function load_data(){if(is_null(self::$static_sql)){self::$static_sql=system_member_data();}return self::$static_sql;}public static function get_info($„Ë¬´“){$”ÏÈ=self::load_data();return $”ÏÈ->get($„Ë¬´“);Êıãº‘Ş¶½îÕîÒ‰ê†ù£ƒıï¯²„;}public static function space_change($ÇÓÀ…Ê,$•Ğä=false){$âÄ‡¡=self::load_data();$‘‡çû=$âÄ‡¡->get($ÇÓÀ…Ê);if(!is_array($‘‡çû)){show_json($this->L["data_not_full"],!1);}if($•Ğä===!1){$ ‘ß‘=_path_info_more(USER_PATH.$‘‡çû['path'].'/');$“•¸=$ ‘ß‘['size'];if(isset($‘‡çû['home_path'])&& file_exists(iconv_app($‘‡çû['home_path']))){$ ‘ß‘=_path_info_more(iconv_app($‘‡çû['home_path']));$“•¸+= $ ‘ß‘['size'];}}else{$“•¸=floatval($‘‡çû['config']['size_use'])+floatval($•Ğä);à´ËáÊÇ›Œ¢£À´Çè±ÕÊÑæ«ã¨¾øàšâÚú—§İáÄ¥ıÆ²¡éó¢Ÿ»ŒĞ‘Ö£øƒ‡¡Á€ƒÜãİ×ú…µİÊÛÛ‘üûƒ ›¿¬ìÑ;}$‘‡çû['config']['size_use']=$“•¸<0?0:$“•¸;$âÄ‡¡->set($ÇÓÀ…Ê,$‘‡çû);}public static function space_check($‡˜ë){$˜î¦=self::load_data();÷Ò´Ö‘²¯¡°«¥ĞÇäü´¶Å‚ˆİíÑöİ÷ó«öìş¬Ã¾õÌß§ø…÷Àêõõ¡ö»£€™’Ò‘ğÊ…Âñœï;$¹¯­=$˜î¦->get($‡˜ë);if(!is_array($¹¯­)){show_json($this->L["data_not_full"],!1);}$Ô=floatval($¹¯­['config']['size_use']);$•=floatval($¹¯­['config']['size_max']);Ã;if($•!=0&& $•*0x0000040000000<$Ô){show_json($GLOBALS['L']['space_is_full'],!1);}}public static function group_remove_user_update($£ºò){$ºÙ=self::load_data();$ËØ=$ºÙ->get();foreach($ËØ as $œ—†Í=>$¼úÇ){if(in_array($£ºò,array_keys($¼úÇ['group_info']))){unset($¼úÇ['group_info'][$£ºò]);$ºÙ->set($¼úÇ['user_id'],$¼úÇ);}}}public static function role_remove_user_update($ÏÇâ){$ã=self::load_data();œ³Î×;$©åß=$ã->get();İÜœ;foreach($©åß as $êé¥§=>$ìôµµ){if($ìôµµ['role']==$ÏÇâ){$ìôµµ['role']='';$ã->set($ìôµµ['user_id'],$ìôµµ);}}}public static function user_auth_group($Ó¾¼µ){$ÄÒ³“«=self::load_data();Õ²ÒÚ°öô;$àš=$ÄÒ³“«->get($_SESSION['kod_user']['user_id']);¸ü½;$ûÍ‡û=$àš['group_info'];if(!is_array($ûÍ‡û)){return !1;}if(isset($ûÍ‡û[$Ó¾¼µ])){return $ûÍ‡û[$Ó¾¼µ];}foreach($ûÍ‡û as $°¦‡¦=>$šû–í){$§Î=system_group::get_info($°¦‡¦);$°¸ü=explode(',',$§Î['children']);if(in_array($Ó¾¼µ,$°¸ü)){return $ûÍ‡û[$°¦‡¦];}}return !1;óşÆÅû•Íø§¨©Í°Ğ±ÊÍÈ¹¥ï×ó;}public static function _filter_list($¤,$œˆ='path'){if($GLOBALS['is_root'])return $¤;foreach($¤ as $‡=>&$„£¤ü){unset($„£¤ü[$œˆ]);™ı÷ËÉÅ”„ë…Ûà“í…Úş¢ãÅ²;unset($„£¤ü['password']);ï÷®ìÂû;}return $¤;}public static function get_user_at_group($ú§Å){$¼É¿Á=self::load_data();$Õ•=self::_filter_list($¼É¿Á->get());if($ú§Å=='0'){return $Õ•;}$”È=array();foreach($Õ• as $Ú){if(isset($Ú['group_info'][$ú§Å])){$”È[]=$Ú;}}return $”È;†ò§´à;}public static function user_share_sql($±õÆ­ƒ){static $óÖ¬¾—;ÅúŞö§ê£‘š©„ÂŞä­‘Ûô¾Şã³¶‘òÍ€Ø†ÅÓä½ã;if(!is_array($óÖ¬¾—)){$óÖ¬¾—=array();}if(!isset($óÖ¬¾—[$±õÆ­ƒ])){$Ì=system_member::get_info($±õÆ­ƒ);if(!isset($Ì['path'])){return;}$°İêÚ=new fileCache(USER_PATH.$Ì['path'].'/data/share.php');$óÖ¬¾—[$±õÆ­ƒ]=$°İêÚ;ÇÚË£Ğ‹ƒµ¾ºÆ±‰ÇŠŞôË;}return $óÖ¬¾—[$±õÆ­ƒ];“²ö;}public static function user_share_list($Ø­Ç¡){$”=self::user_share_sql($Ø­Ç¡);ÈŞ„Õ‘œœ«ú’÷¾”ÒÇ;$Ñ=$”->get();;if($Ø­Ç¡==$_SESSION['kod_user']['user_id']){return $Ñ;}foreach($Ñ as $‰=>&$Éâ){unset($Éâ['share_password']);}return $Ñ;}public static function user_share_get($“ñ±—,$Â¤å){$Á‘ÙÓ=self::user_share_sql($“ñ±—);return $Á‘ÙÓ->get('name',$Â¤å);}public function get($šì¯¢¿='0'){$„=self::get_user_at_group($šì¯¢¿);show_json($„);}public function add(){if(!isset($this->in['name'])|| !isset($this->in['password'])|| !isset($this->in['role'])|| !isset($this->in['group_info'])|| !isset($this->in['size_max']))show_json($this->L["data_not_full"],!1);$È=trim(rawurldecode($this->in['name']));¨äÙûå ËûáİÖ¶çğƒİÎ¦Óª;$÷³¥Î=rawurldecode($this->in['password']);$öéîÑ=json_decode(rawurldecode($this->in['group_info']),!0);ˆ¡ëê€Ã¡ç´¿ë’’¯â¼ŒÚï²©õ„¡àóóÇÉãÏëĞ»ë”ÜÔÈÀÚ«Ó‹˜éÊ”÷Ï¶ØÃª¡ñ;if(!is_array($öéîÑ)){show_json($this->L["system_member_group_error"],!1);}if($this->sql->get(array('name',$È))){show_json($this->L['error_repeat'],!1);}if(!$GLOBALS['is_root']&& $this->in['role']=='1'){show_json($this->L['group_role_error'],!1);}$Ş­åòŠ=array();if(isset($this->in['isImport'])){$¼§ü=explode("\n",$È);foreach($¼§ü as $Ó){if(trim($Ó)!=''){$Ş­åòŠ[]=trim($Ó);}}}else{$Ş­åòŠ[]=$È;á»Íã‡âÛÖ™µšÃÖ¨ÒÈ¢±õ‰¥Äâ¨Âúû;}$=array();®Ùâ‘¶¹ªëÔíÃüÀ ò„©™…îû®±÷«Ä–‹ºñ¹•ÔËÌõ¹ääüâ¦‹ƒš¬³”›°ÃÍ¨î’¿úÍ±µã‡°;foreach($Ş­åòŠ as $ö){if($this->sql->get('name',$ö)){$[]=$ö;continue;}$ûÜçŞƒ=$this->sql->get_max_id().'';$â‚Ñ=array('user_id' =>$ûÜçŞƒ,'name' =>$ö,'password' =>md5($÷³¥Î),'role' =>$this->in['role'],'config' =>array('size_max' =>floatval($this->in['size_max']),'size_use' =>0x00000400*0x00000400),'group_info'=> $öéîÑ,'path' =>hash_path($ö),'status' =>0x001,'last_login'=> '','create_time'=> time(),);if(!$GLOBALS['is_root']){show_json($this->L['no_permission'],!1);}if(isset($this->in['home_path'])){$â‚Ñ['home_path']=_DIR(rawurldecode($this->in['home_path']));if(!file_exists($â‚Ñ['home_path'])){show_json($this->L['not_exists'],!1);}$â‚Ñ['home_path']=iconv_app($â‚Ñ['home_path']);}else{unset($â‚Ñ['home_path']);}if($this->sql->set($ûÜçŞƒ,$â‚Ñ)){$this->_initDir($â‚Ñ['path']);}else{$[]=$ö;}}$Û=count($Ş­åòŠ)-count($);ŒêÅÚœú¿¤ûï¼óÚ¸ĞÂ˜Ôµúñ¸‹Ã;$·Æ¬±=" success:$Û";Ü½™ù¹Ø¶ÉÚ«¤”ûæ­Ñ¨ÃÖ´ˆ¨ëÏÕÁÍÜŒõ˜ÆÏ·ü™“¨¾§¥¥Õ;if($Û==count($Ş­åòŠ)){show_json($this->L['success'].$·Æ¬±,!0,$Û);}else if($Û!=0){$Ãş»›³=" error:".count($);show_json($this->L['success'].$·Æ¬±.$Ãş»›³,!1,implode("\n",$));}else{show_json($this->L['error_repeat'],!1);}}public function edit(){if(!$this->in['user_id'])show_json($this->L["data_not_full"],!1);$Ã ”=$this->in['user_id'];$Öçœ=$this->sql->get($Ã ”);»âÅ¹üØâ»‰áÖ;if(!$Öçœ){show_json($this->L['error'],!1);}if(!$GLOBALS['is_root']&& $this->in['role']=='1'){show_json($this->L['group_role_error'],!1);}if(!$GLOBALS['is_root']&& $Öçœ['role']=='1'){show_json($this->L['group_role_error_admin'],!1);}if($GLOBALS['is_root']&& $_SESSION['kod_user']['user_id']==$Ã ”&& $this->in['role']!='1'){show_json($this->L['error'],!1);}$Õ¼=trim(rawurldecode($this->in['name']));if($Öçœ['name']!=$Õ¼){if($this->sql->get(array('name',$Õ¼))){show_json($this->L['error_repeat'],!1);}}$this->in['name']=rawurlencode($Õ¼);…;$— =array('name','role','password','group_info','home_path','status','size_max');†âı™ğºû;foreach($—  as $óù){if(!isset($this->in[$óù]))continue;$Öçœ[$óù]=rawurldecode($this->in[$óù]);à—èá½¾Ÿ;if($óù=='password'){$Öçœ['password']=md5($Öçœ[$óù]);}else if($óù=='size_max'){$Öçœ['config']['size_max']=floatval($Öçœ[$óù]);}else if($óù=='group_info'){$Öçœ['group_info']=json_decode(rawurldecode($this->in['group_info']),!0);}}if(!$GLOBALS['is_root']){show_json($this->L['no_permission'],!1);}if(isset($this->in['home_path'])){$Öçœ['home_path']=_DIR(rawurldecode($this->in['home_path']));if(!file_exists($Öçœ['home_path'])){show_json($this->L['not_exists'],!1);}$Öçœ['home_path']=iconv_app($Öçœ['home_path']);}else{unset($Öçœ['home_path']);„ó¹¥Ş§­ä‹¬şüæú´Ûõ;}if($this->sql->set($Ã ”,$Öçœ)){self::space_change($Ã ”);show_json($this->L['success'],!0,$Öçœ);}show_json($this->L['error_repeat'],!1);}public function do_action(){if(!isset($this->in['user_id'])){show_json($this->L["username_can_not_null"],!1);}$´«Ö=$this->in['action'];$Â=json_decode($this->in['user_id'],!0);ş;if(!is_array($Â)){show_json($this->L['error'],!1);}if(in_array('1',$Â)){show_json($this->L['default_user_can_not_do'],!1);}foreach($Â as $ş){switch($´«Ö){case 'del':$º„½=$this->sql->get($ş);if($this->sql->remove($ş)&& $º„½['name']!=''){del_dir(USER_PATH.$º„½['path'].'/');}break;case 'status_set':$©œ×=intval($this->in['param']);$this->sql->set(array('user_id',$ş),array('status',$©œ×));break;case 'role_set':$ëû=$this->in['param']; üö“à·Œá¶¤à€ßå½ÔÙñçÛ›íÛÁÚØ£Ë½¡éµµÊìÁ¬¤æ¤Æôâœ…½í™ªÛõ;if(!$GLOBALS['is_root']&& $ëû=='1'){show_json($this->L['group_role_error'],!1);}$this->sql->set(array('user_id',$ş),array('role',$ëû));break;ŠÚ›Èû…ı²ĞêóıÛŒ´¢‚˜¿‡ÕÎôïøÑåæˆµ;case 'group_reset':$ãÑºàÖ=json_decode($this->in['param'],!0);if(!is_array($ãÑºàÖ)){show_json($this->L['error'],!1);}$this->sql->set(array('user_id',$ş),array('group_info',$ãÑºàÖ));break;case 'group_remove_from':$¤ˆ=$this->in['param'];$º„½=$this->sql->get($ş);unset($º„½['group_info'][$¤ˆ]);‡´ƒÆ¼Ø•²È„¯öåèğ·¤Ñİå¶ƒíÜ·Ò¢ÚÄ¥¢‚ş¸´;$this->sql->set($ş,$º„½);÷¿Æİ©·•ÎŠ¤¬ğÚ¯ß¸ç²È‹°°¯èÄ;break;ïñÄÎ›üãéˆ‰—øãÇØ¯Œå»›ôëË…œ´Ê”æÉ…ØÔôŒ¸ß”Á÷¦¿;case 'group_add':$ãÑºàÖ=json_decode($this->in['param'],!0);ò«« ˜Ú¦´ñÉö»ÏĞÉ¤ÆÕÜ¦êŸ÷ÆŞŞ‹ÎÒ¶úá×“½ıÇÍï’Å«á—õ†İÌ;if(!is_array($ãÑºàÖ)){show_json($this->L['error'],!1);}$º„½=$this->sql->get($ş);foreach($ãÑºàÖ as $…·„¤=>$Êƒ){$º„½['group_info'][$…·„¤]=$Êƒ;}$this->sql->set($ş,$º„½);ÍÆäà„ã©ÒÔ»˜°ö¤Ä‰“ü·­Ø»¾¯¢½Ûè¢½í‡çÀÛ¤ÙÜÂŠÔç˜šğ¬—ı;default:break; …‡®§Ä‹‘çÉşî±ÀËÕš¨˜¤ı€½™ñê°ğÏöÇğûÏ ¤”«µûõ;}}show_json($this->L['success']);}public function init_install(){$§ö·ü‘=system_member::load_data();Ş—ô÷‰ß©ù°¡Â;$’=$§ö·ü‘->get();îø£ä¯Œ¦ÇŠ·¨ îˆ·ã;foreach($’ as $Ä«»=>&$Ìı—ë){$®·É¨=hash_path();ê»ı³Å¶Ûæ¦ãŠåßÏ‘›ÄŞ™ÜÊª¸ùâ‚¢¾±;$this->_initDir($®·É¨);øİ´°¹›Öºá„›±–¶öôĞÓÀúºİİÁØÇ°Ò¥äƒ;$Ìı—ë['path']=$®·É¨;ı¼¼ƒ×íš;$Ìı—ë['create_time']=time();¹ĞÚÆŒ¹ÖéÖ™ÂŸÉ–Ä¯;}$§ö·ü‘->reset($’);$°ô=explode(',',$this->config['setting_system']['new_group_folder']);$§ö·ü‘=system_group::load_data();ÄŸÁÓ…Ò³¿£†¯Èİš;$’=$§ö·ü‘->get();foreach($’ as $Ä«»=>&$Ìı—ë){$®·É¨=hash_path();Àó…ğ«¡ƒÏ´÷ÔÔº©ÙÜ™°ë àµıúÖôØ—¶Ì§ÚÈÉŞ;$Ù=GROUP_PATH.$®·É¨.'/';foreach($°ô as $¯){mk_dir($Ù.'home/'.iconv_system($¯));ÂØ¶Ü‰£üêØûå¯ğ¾Æ¨ŒãĞç­›ÆÅôÚÖ¥Â¢ş†ûµâ…Øàï±ÜÖáÎ–;}$Ìı—ë['path']=$®·É¨;$Ìı—ë['create_time']=time();È‹»ã;}$§ö·ü‘->reset($’);­Ù€ğûşö÷;}private function _initDir($Úı){$î¿˜=array('home','recycle','data');ÛËßşÙ¨‹–İ˜ç‹ñçûîæòç›Îæ©ŠÕé£;$‹=explode(',',$this->config['setting_system']['new_user_folder']);ø´”„Ê¡ââŠíÕñêÄØŞ­ô­”Ÿ·êŠÚ‡˜æñÑù¦æşğˆáÔ’Ğ«…»ğİ›ÓÈ²ó€ıÛ¥–Ã¦‰•;$¯û=USER_PATH.$Úı.'/';foreach($î¿˜ as $…ƒ){mk_dir($¯û.$…ƒ);¢“ü«²ĞóäÄôƒÃÑ©Ú•;}foreach($‹ as $…ƒ){mk_dir($¯û.'home/'.iconv_system($…ƒ));ñ”¨“¶®–®ÇêÑåûåâ§˜´œüù’¾äª™ú;}fileCache::save($¯û.'data/config.php',$this->config['setting_default']);í“ÏÊş˜øÆ„Ê­€°¨ÈÅÅÆÀØÈş½ò™¹î˜à;}}