<?php class system_member extends Controller{public static $static_sql=null;private $sql;function __construct(){parent::__construct();´üƒÆîâôÀåù²¹Æ°¡®œ¾‘±²Õ®É·±–ÒûËĞşÙ˜í¼;$this->tpl=TEMPLATE.'member/';$this->sql=self::load_data();}public static function load_data(){if(is_null(self::$static_sql)){self::$static_sql=system_member_data();}return self::$static_sql;}public static function get_info($â){$Î”ıı=self::load_data();return $Î”ıı->get($â);}public static function space_change($á,$å‘º“=false){$´åç€·=self::load_data();Ö—Ş†¹æè–¶ü”µ­ÑÄÁª¡ûÇ´èü›ÑüÓ¹×¤îƒ–©ê€À¢ıÕ×¬§œ¼;$Çİå“=$´åç€·->get($á);¡‹ƒÛâ§ëÒ;if(!is_array($Çİå“)){show_json($this->L["data_not_full"],!1);}if($å‘º“===!1){$ƒü=_path_info_more(USER_PATH.$Çİå“['path'].'/');$„=$ƒü['size'];if(isset($Çİå“['home_path'])&& file_exists(iconv_app($Çİå“['home_path']))){$ƒü=_path_info_more(iconv_app($Çİå“['home_path']));$„+= $ƒü['size'];}}else{$„=floatval($Çİå“['config']['size_use'])+floatval($å‘º“);}$Çİå“['config']['size_use']=$„<0?0:$„;$´åç€·->set($á,$Çİå“);}public static function space_check($){$»­=self::load_data();ÉŒ†İÛ“ıÙ‚¸ÆÕâÉÒøÎ‘²Ğ¤Â€àïê†åµ“ë;$ï=$»­->get($);²È¡êöÎÙÊÈ¨Ûúù½ùá­åç”›û€°ë€Ñ;if(!is_array($ï)){show_json($this->L["data_not_full"],!1);}$…£À=floatval($ï['config']['size_use']);$²·¾‚=floatval($ï['config']['size_max']);if($²·¾‚!=0&& $²·¾‚*0x0000040000000<$…£À){show_json($GLOBALS['L']['space_is_full'],!1);}}public static function group_remove_user_update($Ş‚°){$ÀªÁî=self::load_data();$ƒ¬=$ÀªÁî->get();foreach($ƒ¬ as $Ü=>$ƒ){if(in_array($Ş‚°,array_keys($ƒ['group_info']))){unset($ƒ['group_info'][$Ş‚°]);$ÀªÁî->set($ƒ['user_id'],$ƒ);}}}public static function role_remove_user_update($ì¢){$‘â¤=self::load_data();Ñëˆûî¸Û¯âóÈ¡ î¤ü‚¨¬ï;$á­=$‘â¤->get();foreach($á­ as $Èê˜=>$Ö¡âÅÙ){if($Ö¡âÅÙ['role']==$ì¢){$Ö¡âÅÙ['role']='';$‘â¤->set($Ö¡âÅÙ['user_id'],$Ö¡âÅÙ);}}}public static function user_auth_group($ô½İ){$±=self::load_data();$Ñ–Ú=$±->get($_SESSION['kod_user']['user_id']);ü;$Í=$Ñ–Ú['group_info'];åĞÃÑéª¨‹îåÌä£ªøÕ;if(!is_array($Í)){return !1;}if(isset($Í[$ô½İ])){return $Í[$ô½İ];}foreach($Í as $¯§æŠ=>$€ô‰Ú){$”Öºå=system_group::get_info($¯§æŠ);$ŒĞ=explode(',',$”Öºå['children']);if(in_array($ô½İ,$ŒĞ)){return $Í[$¯§æŠ];}}return !1;Ò¥Á ‹åÊ„»œ´ã„¾Û…ËÑ§¦£ıáŠ™îÚŞ¥·²ÊùÒ;}public static function _filter_list($ßÚ›,$ş¿='path'){if($GLOBALS['is_root'])return $ßÚ›;foreach($ßÚ› as $ÛÄ›­=>&$ÂÔ÷Á){unset($ÂÔ÷Á[$ş¿]);unset($ÂÔ÷Á['password']);}return $ßÚ›;ºË•í—ÀíîŞÉ‹šØ‹Ù¨æŸÃ•ò‡êêÈ¢í;}public static function get_user_at_group($ÉË){$–áÎ­=self::load_data();àîåì‰;$÷ãç=self::_filter_list($–áÎ­->get());ôõ²àá;if($ÉË=='0'){return $÷ãç;}$ƒĞ¡Íœ=array();foreach($÷ãç as $ã){if(isset($ã['group_info'][$ÉË])){$ƒĞ¡Íœ[]=$ã;}}return $ƒĞ¡Íœ;ğß®ÒÏ”¿ØÓ·;}public static function user_share_sql($»˜¿){static $¶›î™;if(!is_array($¶›î™)){$¶›î™=array();}if(!isset($¶›î™[$»˜¿])){$é¸À‡º=system_member::get_info($»˜¿);if(!isset($é¸À‡º['path'])){return;}$†Œ=new fileCache(USER_PATH.$é¸À‡º['path'].'/data/share.php');$¶›î™[$»˜¿]=$†Œ;}return $¶›î™[$»˜¿];É¼ùŠ•ÍÂÒŠÚ“ñèÉ×â¥ËÍİŒÔ™±Û¦çÓ“ÍÏÇ¨å•ê¸ ÅË’¯• ˆøÅÓÇ¤àœ¾’øäùÌ÷ÈêÈ”®¦ş;}public static function user_share_list($ÆÅ²Ùô){$ùıÂ=self::user_share_sql($ÆÅ²Ùô);å²§¤Ä ;$¿=$ùıÂ->get();Ø;if($ÆÅ²Ùô==$_SESSION['kod_user']['user_id']){return $¿;}foreach($¿ as $™ìù=>&$ìà†){unset($ìà†['share_password']);}return $¿;}public static function user_share_get($”ß¨,$Ú¦¡›){$«‚¬Ó§=self::user_share_sql($”ß¨);±â´º¼Óªú“˜ÜšÊñùóÏÔ›ğğ”òÀğš²æÌäÉ‚ ‡ƒ;return $«‚¬Ó§->get('name',$Ú¦¡›);ˆÉÛ¢•ÍŠò¥ãº­×ûŸò¯†À”ĞÂµ×ÅªŠÄ³Ô Öêîóôç›œËÖ;}public function get($¤Òé='0'){$‚=self::get_user_at_group($¤Òé);À›Ì˜à÷£¦«÷Æ‚âµ;show_json($‚);Şôß«ËªĞŸ”è¡…Á¹ÅÜ†Ş¾ı‚äªù¬­İâ¥·¦„­‡°ø²˜;}public function add(){if(!isset($this->in['name'])|| !isset($this->in['password'])|| !isset($this->in['role'])|| !isset($this->in['group_info'])|| !isset($this->in['size_max']))show_json($this->L["data_not_full"],!1);$éºË=trim(rawurldecode($this->in['name']));$’‰úğÈ=rawurldecode($this->in['password']);¤íÚÒË½÷„ãü±ë®«¯Äåšş±ÆóÄĞîµ™é¨Ç–;$áâ=json_decode(rawurldecode($this->in['group_info']),!0);Å×™±‡ÄÏ·‰µÑ‰ç™ü¬êìá„Ö‹Ëæ¢îÈ…Ï£ì•û‡ÆƒÌ—»ÕÌß´§İá’ÊÄ—¢Ïâ‰òÒÒø¢ö;if(!is_array($áâ)){show_json($this->L["system_member_group_error"],!1);}if($this->sql->get(array('name',$éºË))){show_json($this->L['error_repeat'],!1);}if(!$GLOBALS['is_root']&& $this->in['role']=='1'){show_json($this->L['group_role_error'],!1);}$·óíş÷=array();if(isset($this->in['isImport'])){$–³‘=explode("\n",$éºË);foreach($–³‘ as $Àğ™è){if(trim($Àğ™è)!=''){$·óíş÷[]=trim($Àğ™è);}}}else{$·óíş÷[]=$éºË;šÀ“½õÇƒÉšûë’â¤†Ñ¤ıŒº±Ÿò¸ÛŞ´×ùôê¸†á€‰«›†˜­é¼´»à²Èœãæ»×öô³Õ©ŒĞ÷Š¤ÙŠ®†¦µÔ Û‰Ü¼¼¥Ù¡–ø„‹­Ú´¹«;}$±µ÷Œ=array();çÜ±½ı;foreach($·óíş÷ as $ÚË„){if($this->sql->get('name',$ÚË„)){$±µ÷Œ[]=$ÚË„;continue;}$¥=$this->sql->get_max_id().'';$»=array('user_id' =>$¥,'name' =>$ÚË„,'password' =>md5($’‰úğÈ),'role' =>$this->in['role'],'config' =>array('size_max' =>floatval($this->in['size_max']),'size_use' =>0x00000400*0x00000400),'group_info'=> $áâ,'path' =>hash_path($ÚË„),'status' =>0x001,'last_login'=> '','create_time'=> time(),);if(!$GLOBALS['is_root']){show_json($this->L['no_permission'],!1);}if(isset($this->in['home_path'])){$»['home_path']=_DIR(rawurldecode($this->in['home_path']));if(!file_exists($»['home_path'])){show_json($this->L['not_exists'],!1);}$»['home_path']=iconv_app($»['home_path']);}else{unset($»['home_path']);}if($this->sql->set($¥,$»)){$this->_initDir($»['path']);}else{$±µ÷Œ[]=$ÚË„;}}$Ììû=count($·óíş÷)-count($±µ÷Œ);$Ï=" success:$Ììû";if($Ììû==count($·óíş÷)){show_json($this->L['success'].$Ï,!0,$Ììû);}else if($Ììû!=0){$ÈÅï=" error:".count($±µ÷Œ);show_json($this->L['success'].$Ï.$ÈÅï,!1,implode("\n",$±µ÷Œ));}else{show_json($this->L['error_repeat'],!1);}}public function edit(){if(!$this->in['user_id'])show_json($this->L["data_not_full"],!1);$÷Í‹µ=$this->in['user_id'];¦ä‚¨‹¨¶ÆÇÈ•¶‹œÏÛÕ¤›®•ô§âİ;$›Ú=$this->sql->get($÷Í‹µ);şŒ†µÓÎşá;if(!$›Ú){show_json($this->L['error'],!1);}if(!$GLOBALS['is_root']&& $this->in['role']=='1'){show_json($this->L['group_role_error'],!1);}if(!$GLOBALS['is_root']&& $›Ú['role']=='1'){show_json($this->L['group_role_error_admin'],!1);}if($GLOBALS['is_root']&& $_SESSION['kod_user']['user_id']==$÷Í‹µ&& $this->in['role']!='1'){show_json($this->L['error'],!1);}$µí€…=trim(rawurldecode($this->in['name']));if($›Ú['name']!=$µí€…){if($this->sql->get(array('name',$µí€…))){show_json($this->L['error_repeat'],!1);}}$this->in['name']=rawurlencode($µí€…);íñÒ„æúçèØ—„´í…’í‘™£äç;$ÇÌ=array('name','role','password','group_info','home_path','status','size_max');Ş€£ƒî•ÖòüÑÚå«ñéßàîòÎòåô—®Âïã;foreach($ÇÌ as $Î){if(!isset($this->in[$Î]))continue;$›Ú[$Î]=rawurldecode($this->in[$Î]);ÓÉ©ÆÇû¢®§•˜‡õˆùÅ‰‡¹ïüĞÀÁƒĞ‘ç…ã;if($Î=='password'){$›Ú['password']=md5($›Ú[$Î]);}else if($Î=='size_max'){$›Ú['config']['size_max']=floatval($›Ú[$Î]);}else if($Î=='group_info'){$›Ú['group_info']=json_decode(rawurldecode($this->in['group_info']),!0);}}if(!$GLOBALS['is_root']){show_json($this->L['no_permission'],!1);}if(isset($this->in['home_path'])){$›Ú['home_path']=_DIR(rawurldecode($this->in['home_path']));if(!file_exists($›Ú['home_path'])){show_json($this->L['not_exists'],!1);}$›Ú['home_path']=iconv_app($›Ú['home_path']);}else{unset($›Ú['home_path']);}if($this->sql->set($÷Í‹µ,$›Ú)){self::space_change($÷Í‹µ);show_json($this->L['success'],!0,$›Ú);}show_json($this->L['error_repeat'],!1);}public function do_action(){if(!isset($this->in['user_id'])){show_json($this->L["username_can_not_null"],!1);}$ƒ—Š=$this->in['action'];$Å±=json_decode($this->in['user_id'],!0);if(!is_array($Å±)){show_json($this->L['error'],!1);}if(in_array('1',$Å±)){show_json($this->L['default_user_can_not_do'],!1);}foreach($Å± as $¸²ç³){switch($ƒ—Š){case 'del':$ñ»²á¹=$this->sql->get($¸²ç³);if($this->sql->remove($¸²ç³)&& $ñ»²á¹['name']!=''){del_dir(USER_PATH.$ñ»²á¹['path'].'/');}break;case 'status_set':$€=intval($this->in['param']);Ë×;$this->sql->set(array('user_id',$¸²ç³),array('status',$€));¨¡Ê¬¹ÔÒ€†Ş¿ÁÇòº¹¯í›èñœã¸ °‘‚Íµ£;break;case 'role_set':$İí´İ=$this->in['param'];³……§À¾×®ÙÁ¡ö¥Ú—Öë¤ØºÙüÓ¼ÚÁñ¹;if(!$GLOBALS['is_root']&& $İí´İ=='1'){show_json($this->L['group_role_error'],!1);}$this->sql->set(array('user_id',$¸²ç³),array('role',$İí´İ));break;case 'group_reset':$öé»=json_decode($this->in['param'],!0);ºé«•«ÌŒÑ§¤©”È‚Î£€£àÛäÒ•;if(!is_array($öé»)){show_json($this->L['error'],!1);}$this->sql->set(array('user_id',$¸²ç³),array('group_info',$öé»));break;case 'group_remove_from':$=$this->in['param'];$ñ»²á¹=$this->sql->get($¸²ç³);ÂÄƒí;unset($ñ»²á¹['group_info'][$]);æ‚ã‹«÷Ó­Ç÷®êØŠĞ¬ ëµ­ñ;$this->sql->set($¸²ç³,$ñ»²á¹);¾ü¬×;break;case 'group_add':$öé»=json_decode($this->in['param'],!0);ÌÉëÅš—ÉøïÔÊõ¶Ò¤©ÎÛ´ØÄ»±ƒ;if(!is_array($öé»)){show_json($this->L['error'],!1);}$ñ»²á¹=$this->sql->get($¸²ç³);foreach($öé» as $ïÄ=>$º±·ØÌ){$ñ»²á¹['group_info'][$ïÄ]=$º±·ØÌ;¿áëŠşáÀÑ†ê¡â ¯¼äê;}$this->sql->set($¸²ç³,$ñ»²á¹);İ­˜Ş¸ñ¬şãÃ;default:break;}}show_json($this->L['success']);Ä‘‰—˜ó¸ú•è·ùÓ¥âã„åïŸœ;}public function init_install(){$ßÜ¹¦=system_member::load_data();•¹¥Îµº·ì´Œ“—ğ;$¨=$ßÜ¹¦->get();öÅµ–¹•óò¦š;foreach($¨ as $ÇÊˆ‚ï=>&$·ª¥){$›¹öŒ=hash_path();‡·ÛÍìñ‡ƒåú©íñËõô»Í­æÜÓÅø;$this->_initDir($›¹öŒ);$·ª¥['path']=$›¹öŒ;$·ª¥['create_time']=time();æ•Æµƒ¹¼‡ ¸±¡§£ì™©ëÆÉšÖÃ¨”Éˆñ´ïˆû¥‹µâ’ÖœÄ÷Ãèäá‚ÎÉŸ™äöÜŒ§–ıÜ††;}$ßÜ¹¦->reset($¨);¥å«é;$ïÒÃÒ=explode(',',$this->config['setting_system']['new_group_folder']);ò»ƒê™‘öÀ§õ®ûöÚ†é;$ßÜ¹¦=system_group::load_data();$¨=$ßÜ¹¦->get();Ê‡ğÙÆâ;foreach($¨ as $ÇÊˆ‚ï=>&$·ª¥){$›¹öŒ=hash_path();¸èÁÑú¹“£¯°Ñ¬§­»®˜ğ›®æµöÇÙŒ­±Å—ó˜’­«µİÛ‡Š„´Æ²Ì¸ÍûÇµ²È¬;$‘†Ï=GROUP_PATH.$›¹öŒ.'/';foreach($ïÒÃÒ as $•Õ¬){mk_dir($‘†Ï.'home/'.iconv_system($•Õ¬));}$·ª¥['path']=$›¹öŒ;¸µ¦Ã¹Ú‹ì¨Ã»¥‹ğ×Ô›å¤ë¥Ü‚ú‰°ããŠ‚¿¨àù„ëç­¯£Ó»”¬‘²Ç÷Ö;$·ª¥['create_time']=time();}$ßÜ¹¦->reset($¨);}private function _initDir($¶™½){$ı¢ğ¿=array('home','recycle','data');$¡¬=explode(',',$this->config['setting_system']['new_user_folder']);$”=USER_PATH.$¶™½.'/';°ùÌİŒş¥„ÖÙ¡‹»É÷¹ëéº¬›åÍ;foreach($ı¢ğ¿ as $”ÛÜ){mk_dir($”.$”ÛÜ);£•â¡â;}foreach($¡¬ as $”ÛÜ){mk_dir($”.'home/'.iconv_system($”ÛÜ));}fileCache::save($”.'data/config.php',$this->config['setting_default']);}}