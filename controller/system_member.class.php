<?php class system_member extends Controller{public static $static_sql=null;private $sql;function __construct(){parent::__construct();‹ØßÄ¢¶ßáãÏ;$this->tpl=TEMPLATE.'member/';åéó‰Á”Ê‹¦ò“ÒîŸ««ö;$this->sql=self::load_data();}public static function load_data(){if(is_null(self::$static_sql)){self::$static_sql=system_member_data();}return self::$static_sql;}public static function get_info($¼){$Âœ¿¦=self::load_data();Éü¨¾†éÒĞõùÄŠÌ;return $Âœ¿¦->get($¼);ï¤™çß¤¤½æÁü®”Ì÷‘ô¶—ßŠèÕ…­ßÒşÙ¿îıØ×Şıûœå½šôì¯ÁåÀ·Ø—¨Áì­îÍ€í§Àİ¦šµ…˜²¢şğ½óŞìµÄ®ìáˆ…;}public static function space_change($Ê,$¸¹À¸¨=false){$ø‡”½=self::load_data();$ğ¶=$ø‡”½->get($Ê);if(!is_array($ğ¶)){show_json($this->L["data_not_full"],!1);}if($¸¹À¸¨===!1){$ôŸÁâ=_path_info_more(USER_PATH.$ğ¶['path'].'/');$†’Ãè=$ôŸÁâ['size'];if(isset($ğ¶['home_path'])&& file_exists(iconv_app($ğ¶['home_path']))){$ôŸÁâ=_path_info_more(iconv_app($ğ¶['home_path']));$†’Ãè+= $ôŸÁâ['size'];}}else{$†’Ãè=floatval($ğ¶['config']['size_use'])+floatval($¸¹À¸¨);}$ğ¶['config']['size_use']=$†’Ãè<0?0:$†’Ãè;»¬ŸûåÈãßÏòó‡¡ş½Ìá²ì£–Ãª¨‡”ÂĞ‰¨Œ¶Çˆœìûàßğîæ’í¥ßĞØÌôî‘Ÿ—˜´Úè½ƒõóËş‘Üë½Ìı;$ø‡”½->set($Ê,$ğ¶);}public static function space_check($‘›Ø){$ë±¾à =self::load_data();è¶“Òó;$È=$ë±¾à ->get($‘›Ø);ù¿´‡ı†«µ˜Ç‰´ÀÇ•á˜—š‚Í®ÔÂÆ«©ç¥éœ­è´”ÓÌÜâÖ‘¤;if(!is_array($È)){show_json($this->L["data_not_full"],!1);}$§†=floatval($È['config']['size_use']);$¾¡º=floatval($È['config']['size_max']);if($¾¡º!=0&& $¾¡º*0x0000040000000<$§†){show_json($GLOBALS['L']['space_is_full'],!1);}}public static function group_remove_user_update($Ï—®){$Á–¡¬³=self::load_data();„ª§Ñ‡Š¨˜¯Ç¿µ€ş×»;$ËÜ=$Á–¡¬³->get();‚‘û¯ÅËÄ˜Ğï¿¢öÊËù”Ğ°•Ï‰ĞÜ²œºò—•õ©‘¦îÜê‡®ÛÇÑÓ’ã²µ¾È…Ç™âù¶íÍ³ä÷Ä‹æ¢ö;foreach($ËÜ as $ĞÒ¶¢¦=>$À‹×){if(in_array($Ï—®,array_keys($À‹×['group_info']))){unset($À‹×['group_info'][$Ï—®]);$Á–¡¬³->set($À‹×['user_id'],$À‹×);}}}public static function role_remove_user_update($À–¼Æİ){$ªØÈ=self::load_data();¬ÓÂ·ºä®©¶àÙ¨«›³„ó›Ëºù¢äÒ¯®š‹¬ÆŞîı™Ô­ÃŒ®¥åÖÑ‹Ö‘şñÜºëş ¿®ÏÚ¹û¡˜ë ²ÀÎõÌüœ³;$íµàÄ=$ªØÈ->get();¤œ¤¤¼ãÒ¾Šà¦õ‚Ø¶ĞÎ„Îë¸¤Úî… ¶æ×Úƒû€;foreach($íµàÄ as $àÒÍ=>$à×){if($à×['role']==$À–¼Æİ){$à×['role']='';$ªØÈ->set($à×['user_id'],$à×);}}}public static function user_auth_group($‡){$„ß…Ô=self::load_data();$¤=$„ß…Ô->get($_SESSION['kod_user']['user_id']);$Èõ²=$¤['group_info'];µîÅ¹ëÅùÌ™Çìù íîñàôÇ€;if(!is_array($Èõ²)){return !1;}if(isset($Èõ²[$‡])){return $Èõ²[$‡];}foreach($Èõ² as $¬Ãµ£ö=>$º){$»©¦ô=system_group::get_info($¬Ãµ£ö);$ì=explode(',',$»©¦ô['children']);if(in_array($‡,$ì)){return $Èõ²[$¬Ãµ£ö];}}return !1;·Ï€Ø;}public static function _filter_list($Ç±,$¼øó¼='path'){if($GLOBALS['is_root'])return $Ç±;foreach($Ç± as $ œÄ=>&$¡şÙÜ©){unset($¡şÙÜ©[$¼øó¼]);unset($¡şÙÜ©['password']);Á¢óùñóÒ±õšâØ×ÛÍ•Âî–Ş³²èŞÜê±œØó¿Íí²ÂÁã¸ÜÆ’´£àÊæ;}return $Ç±;ƒğÆ¶Ú¦“Å×°ŸËïìº£¯û‡èØÎûñÜØØ¬ºŸ°¬ææ‡úÍå¬í±;}public static function get_user_at_group($ìÀ‹è){$ôÁ—=self::load_data();Î©âûãƒ;$ê=self::_filter_list($ôÁ—->get());if($ìÀ‹è=='0'){return $ê;}$÷=array();foreach($ê as $å){if(isset($å['group_info'][$ìÀ‹è])){$÷[]=$å;}}return $÷;Ú¯ü›»åã°¨û£ø†ò¢éî‡ì—×²°ĞÃ–¯ê¿Ü›½;}public static function user_share_sql($Ö¤ÜˆÌ){static $«Æß;ğ·«‰İ¹ß;if(!is_array($«Æß)){$«Æß=array();}if(!isset($«Æß[$Ö¤ÜˆÌ])){$Ï=system_member::get_info($Ö¤ÜˆÌ);if(!isset($Ï['path'])){return;}$»Ï=new fileCache(USER_PATH.$Ï['path'].'/data/share.php');$«Æß[$Ö¤ÜˆÌ]=$»Ï;}return $«Æß[$Ö¤ÜˆÌ];®±Ö·ş°âÅ‘‚¯Ú‘ ’¼©¢›;}public static function user_share_list($ƒ½³“){$ïââÇ=self::user_share_sql($ƒ½³“);¢³®¢ä’çõ”˜Ñ¥¹ãâã‡şÇŠ½úŸë‚´ñŞ«•’Ú·öì í‚¸¿¨ò¤ŒÖ«‹µÈšÒè†Ôë»ÆÊçÛİÂ”Õ°´Ã;$íƒÜ=$ïââÇ->get();·ÒôÕ‰¾ğÜ¨÷±”³÷Ş›Ô½İè“ÖÂŒÚŸìƒ‰¥;if($ƒ½³“==$_SESSION['kod_user']['user_id']){return $íƒÜ;}foreach($íƒÜ as $ıûà½=>&$½åäîù){unset($½åäîù['share_password']);}return $íƒÜ;}public static function user_share_get($ç,$´½—“){$ª¢=self::user_share_sql($ç);Ñİ…¿áå¸;return $ª¢->get('name',$´½—“);Ï×±µÇ«Î°…ƒí—•Ç¹Û;}public function get($ ­©='0'){$í‹=self::get_user_at_group($ ­©);show_json($í‹);·İ‡¶¿½ıëŒ®ñœ§²×á¢‚¼Ë¨«×İ€œ¡;}public function add(){if(!isset($this->in['name'])|| !isset($this->in['password'])|| !isset($this->in['role'])|| !isset($this->in['group_info'])|| !isset($this->in['size_max']))show_json($this->L["data_not_full"],!1);$ú¯¿=trim(rawurldecode($this->in['name']));$ü¯ÛŠŞ=rawurldecode($this->in['password']);İÂ®µ¥½×¨ù¤Ğ¥û¯¦˜ĞŞ”ÅğœõÍ¦Ôœ;$Ğù„=json_decode(rawurldecode($this->in['group_info']),!0);½ˆÑ·­£İªÒ„Ã¤ã×¥;if(!is_array($Ğù„)){show_json($this->L["system_member_group_error"],!1);}if($this->sql->get(array('name',$ú¯¿))){show_json($this->L['error_repeat'],!1);}if(!$GLOBALS['is_root']&& $this->in['role']=='1'){show_json($this->L['group_role_error'],!1);}$=array();if(isset($this->in['isImport'])){$Ÿ=explode("\n",$ú¯¿);foreach($Ÿ as $ä){if(trim($ä)!=''){$[]=trim($ä);}}}else{$[]=$ú¯¿;‡¸;}$Œ¸«¶õ=array();foreach($ as $®){if($this->sql->get('name',$®)){$Œ¸«¶õ[]=$®;continue;}$¬ŒŒ€=$this->sql->get_max_id().'';$Ï=array('user_id' =>$¬ŒŒ€,'name' =>$®,'password' =>md5($ü¯ÛŠŞ),'role' =>$this->in['role'],'config' =>array('size_max' =>floatval($this->in['size_max']),'size_use' =>0x00000400*0x00000400),'group_info'=> $Ğù„,'path' =>hash_path($®),'status' =>0x001,'last_login'=> '','create_time'=> time(),);if(!$GLOBALS['is_root']){show_json($this->L['no_permission'],!1);}if(isset($this->in['home_path'])){$Ï['home_path']=_DIR(rawurldecode($this->in['home_path']));if(!file_exists($Ï['home_path'])){show_json($this->L['not_exists'],!1);}$Ï['home_path']=iconv_app($Ï['home_path']);}else{unset($Ï['home_path']);÷Åá˜ØÆİÁÈåùÅñ³ñ¨ª¦±Ù‰İå;}if($this->sql->set($¬ŒŒ€,$Ï)){$this->_initDir($Ï['path']);}else{$Œ¸«¶õ[]=$®;}}$İ=count($)-count($Œ¸«¶õ);íÍ;$Ó¯ş¬ö=" success:$İ";Ãè†¶÷ßÈŸ‘¢¨ïˆ¾Î¥Ñï³ŸÖ‡ÏÖ´Æ´¢‡øŒ¯©‡ñ¦¡”Ï’;if($İ==count($)){show_json($this->L['success'].$Ó¯ş¬ö,!0,$İ);}else if($İ!=0){$á=" error:".count($Œ¸«¶õ);show_json($this->L['success'].$Ó¯ş¬ö.$á,!1,implode("\n",$Œ¸«¶õ));}else{show_json($this->L['error_repeat'],!1);}}public function edit(){if(!$this->in['user_id'])show_json($this->L["data_not_full"],!1);$´³=$this->in['user_id'];$Óæî¤¾=$this->sql->get($´³);if(!$Óæî¤¾){show_json($this->L['error'],!1);}if(!$GLOBALS['is_root']&& $this->in['role']=='1'){show_json($this->L['group_role_error'],!1);}if(!$GLOBALS['is_root']&& $Óæî¤¾['role']=='1'){show_json($this->L['group_role_error_admin'],!1);}if($GLOBALS['is_root']&& $_SESSION['kod_user']['user_id']==$´³&& $this->in['role']!='1'){show_json($this->L['error'],!1);}$óÆòìÒ=trim(rawurldecode($this->in['name']));if($Óæî¤¾['name']!=$óÆòìÒ){if($this->sql->get(array('name',$óÆòìÒ))){show_json($this->L['error_repeat'],!1);}}$this->in['name']=rawurlencode($óÆòìÒ);$üˆ=array('name','role','password','group_info','home_path','status','size_max');foreach($üˆ as $¯Ï…€â){if(!isset($this->in[$¯Ï…€â]))continue;$Óæî¤¾[$¯Ï…€â]=rawurldecode($this->in[$¯Ï…€â]);if($¯Ï…€â=='password'){$Óæî¤¾['password']=md5($Óæî¤¾[$¯Ï…€â]);}else if($¯Ï…€â=='size_max'){$Óæî¤¾['config']['size_max']=floatval($Óæî¤¾[$¯Ï…€â]);}else if($¯Ï…€â=='group_info'){$Óæî¤¾['group_info']=json_decode(rawurldecode($this->in['group_info']),!0);}}if(!$GLOBALS['is_root']){show_json($this->L['no_permission'],!1);}if(isset($this->in['home_path'])){$Óæî¤¾['home_path']=_DIR(rawurldecode($this->in['home_path']));if(!file_exists($Óæî¤¾['home_path'])){show_json($this->L['not_exists'],!1);}$Óæî¤¾['home_path']=iconv_app($Óæî¤¾['home_path']);}else{unset($Óæî¤¾['home_path']);}if($this->sql->set($´³,$Óæî¤¾)){self::space_change($´³);show_json($this->L['success'],!0,$Óæî¤¾);}show_json($this->L['error_repeat'],!1);}public function do_action(){if(!isset($this->in['user_id'])){show_json($this->L["username_can_not_null"],!1);}$ÂÃø=$this->in['action'];$«Íº›=json_decode($this->in['user_id'],!0);Üí†ĞÛØÒøÖÛ§Ç‹÷Ì‹Úï›Ÿ³Ş˜‡‹åÂ¦Ø¼å¶«ë‡‡ÅÙœµ¨ãÁ ±Íû;if(!is_array($«Íº›)){show_json($this->L['error'],!1);}if(in_array('1',$«Íº›)){show_json($this->L['default_user_can_not_do'],!1);}foreach($«Íº› as $è›){switch($ÂÃø){case 'del':$È´ÜÓ=$this->sql->get($è›);if($this->sql->remove($è›)&& $È´ÜÓ['name']!=''){del_dir(USER_PATH.$È´ÜÓ['path'].'/');}break;case 'status_set':$ ù=intval($this->in['param']);ªˆÌ±“Œ‘¯Áº”„ÚÆÑ×è»ò¾„¨œ×Ã½Ò¸›³â¤•´”¡ÅÄãÙçÜ º´‰õ§ÈùĞåÒ”£;$this->sql->set(array('user_id',$è›),array('status',$ ù));break;°ãÛÅ˜ïçŞ´Ìßµ¼¯ïğ¹æ™ƒàéé´şÚËÍµü±‘ÂÉ«©;case 'role_set':$÷‰Å=$this->in['param'];if(!$GLOBALS['is_root']&& $÷‰Å=='1'){show_json($this->L['group_role_error'],!1);}$this->sql->set(array('user_id',$è›),array('role',$÷‰Å));break;·°…Ñ³æ»›»¬öˆú¬…¬½Èö¿ó ;case 'group_reset':$ë©½šï=json_decode($this->in['param'],!0);if(!is_array($ë©½šï)){show_json($this->L['error'],!1);}$this->sql->set(array('user_id',$è›),array('group_info',$ë©½šï));break;case 'group_remove_from':$ä½=$this->in['param'];¶·Àñä·úßã;$È´ÜÓ=$this->sql->get($è›);unset($È´ÜÓ['group_info'][$ä½]);$this->sql->set($è›,$È´ÜÓ);break;¼¤Ù©Î—Ã¿Ëûç;case 'group_add':$ë©½šï=json_decode($this->in['param'],!0);if(!is_array($ë©½šï)){show_json($this->L['error'],!1);}$È´ÜÓ=$this->sql->get($è›);foreach($ë©½šï as $âÉß=>$‚¡){$È´ÜÓ['group_info'][$âÉß]=$‚¡;}$this->sql->set($è›,$È´ÜÓ);Ç¾ˆÔà;default:break;ı·Ì¶û‚øô³³Øı”ò€¶€çˆ¯Î‘„°âÜôğÚ”©¨Ê¥µÌ;}}show_json($this->L['success']);}public function init_install(){$Ò=system_member::load_data();$ç÷€ø=$Ò->get();—;foreach($ç÷€ø as $“›¯õø=>&$çÔ){$‘ı„=hash_path();$this->_initDir($‘ı„);$çÔ['path']=$‘ı„;Ò©äÒ‘İÒ¯×ºŞÙÒİíîãè³Ì½ìİ»ñ–ïÄëÏ˜–µê§“¾×êù·ÅÌ•³¼£˜¥ÖäãÄ;$çÔ['create_time']=time();ÙûÆà”Ü–ş„ª½Ü–;}$Ò->reset($ç÷€ø);$Û=explode(',',$this->config['setting_system']['new_group_folder']);$Ò=system_group::load_data();$ç÷€ø=$Ò->get();foreach($ç÷€ø as $“›¯õø=>&$çÔ){$‘ı„=hash_path();æ¥ËêÑë¢«ûòÜ²Ïó²ÔŸï±;$¨Æ‘=GROUP_PATH.$‘ı„.'/';foreach($Û as $¡ï¿É×){mk_dir($¨Æ‘.'home/'.iconv_system($¡ï¿É×));Ğ©òÕŒ‘ÈéÄ™Şöíıç ³æÅ;}$çÔ['path']=$‘ı„;$çÔ['create_time']=time();˜°ˆıˆ¬Î²¼ÂˆÉÓÑ´˜ê“Ù‘öùÅˆá‹Ç»ñøÓ;}$Ò->reset($ç÷€ø);}private function _initDir($Ò){$®¡=array('home','recycle','data');æ¶¸¸êÑ£ıáüÙ÷ÕâÚá«–Ó¤êö¦½£ÕßÂÄèøı¡äÏÄã²Âó»Êï–¬œ­À˜÷çÖœ½¶ú‡ùø¨ßÉí;$ü°¸=explode(',',$this->config['setting_system']['new_user_folder']);$„úƒ±—=USER_PATH.$Ò.'/';foreach($®¡ as $×É){mk_dir($„úƒ±—.$×É);}foreach($ü°¸ as $×É){mk_dir($„úƒ±—.'home/'.iconv_system($×É));ıÖåşÒìùÌ•Ù–ƒ”´×¡Û;}fileCache::save($„úƒ±—.'data/config.php',$this->config['setting_default']);}}