<?php class system_member extends Controller{public static $static_sql=null;private $sql;function __construct(){parent::__construct();¨Óµ—;$this->tpl=TEMPLATE.'member/';$this->sql=self::load_data();}public static function load_data(){if(is_null(self::$static_sql)){self::$static_sql=system_member_data();}return self::$static_sql;}public static function get_info($®ˆ¾þ){$®=self::load_data();Í‘ÈÚ¾³†¾ÇâëˆÐð«øÄá‘àñßùŸýÎ‚æŒÐøÔ«·‰²öÐ–;return $®->get($®ˆ¾þ);Ô†àšçòúÙÒ‹ÔñšÓÀºÍí´¢™ë«ËâüáÆ×É›Ý«µÆž±¡ñ¼õä×É¥ô…óâ¹–û¦ÂÈ‰À«Ð˜;}public static function space_change($ìö¢¢½,$ÔÞ³=false){$Õ=self::load_data();$ ¾Ý¥²=$Õ->get($ìö¢¢½);½†‡Í²àæ©ÎÝËñœŽÆûÁ×ÑÚÀòšŸ˜Íàø—ž€¥¥òØñÙ‚À¸Í²Ô;if(!is_array($ ¾Ý¥²)){show_json($this->L["data_not_full"],!1);}if($ÔÞ³===!1){$øÐžÑ=_path_info_more(USER_PATH.$ ¾Ý¥²['path'].'/');$ù“=$øÐžÑ['size'];if(isset($ ¾Ý¥²['home_path'])&& file_exists(iconv_app($ ¾Ý¥²['home_path']))){$øÐžÑ=_path_info_more(iconv_app($ ¾Ý¥²['home_path']));$ù“+= $øÐžÑ['size'];}}else{$ù“=floatval($ ¾Ý¥²['config']['size_use'])+floatval($ÔÞ³);}$ ¾Ý¥²['config']['size_use']=$ù“<0?0:$ù“;$Õ->set($ìö¢¢½,$ ¾Ý¥²);}public static function space_check($â“){$ù²=self::load_data();$×¹=$ù²->get($â“);if(!is_array($×¹)){show_json($this->L["data_not_full"],!1);}$¬í=floatval($×¹['config']['size_use']);$í§=floatval($×¹['config']['size_max']);if($í§!=0&& $í§*0x0000040000000<$¬í){show_json($GLOBALS['L']['space_is_full'],!1);}}public static function group_remove_user_update($ûÝ){$Íü=self::load_data();€‰Œ²¸îÆáéøŒŠÐÅž‚òµà´¶‚±•œ€’‰ñŠ‰û—¼µ†ƒ˜ðü¤ûÎêšÐÝ§†¾Ü½ÁŽÒÞŽåçïñüˆ¯³Ž³Ë€°ïûþÚ–Ð¸¾Ö÷›•º©;$™¸Î‚º=$Íü->get();Ç¤ëÖ×·Ö‰§ÒˆƒéÙ»¨°´ÄÆîî¯ˆ¨þŠâ¾þ›‡¤‡Þû¿µ†æ‰Ž;foreach($™¸Î‚º as $óç¦™=>$áàÊÐ){if(in_array($ûÝ,array_keys($áàÊÐ['group_info']))){unset($áàÊÐ['group_info'][$ûÝ]);$Íü->set($áàÊÐ['user_id'],$áàÊÐ);}}}public static function role_remove_user_update($Ó){$ÞÜÎÞ=self::load_data();€µ€;$ë†§=$ÞÜÎÞ->get();éý¸‡;foreach($ë†§ as $”=>$øßºŠ´){if($øßºŠ´['role']==$Ó){$øßºŠ´['role']='';$ÞÜÎÞ->set($øßºŠ´['user_id'],$øßºŠ´);}}}public static function user_auth_group($š”‘){$òŠÀö‹=self::load_data();âýòØ“…Â‘½ÉªÒ³£³î­ç¤Èü¶²ïÀòçÌéß˜ÍÝ‹¦ñé„Î´®¢èÒÕ×¾üÉ»³û¬ôî;$Á=$òŠÀö‹->get($_SESSION['kod_user']['user_id']);§ÒåÎÄö¹ÈÆîöè×É¾°Ëý­•¹á‘åÖù™ÚîóƒÁÙÒ‡ÑÏ˜ûÇÔ’À†Ý¾´òø–…Þì†Ù†áÉùä‹Ô¸;$¦=$Á['group_info'];Â«Á˜½‚žœÁÒºè”šÖ›óÝü½ØâÉ­œÜÔâ¿•¥ëÖ½©ÙÜÅ›;if(!is_array($¦)){return !1;}if(isset($¦[$š”‘])){return $¦[$š”‘];}foreach($¦ as $ÕÖ=>$ê){$ï†äÍ„=system_group::get_info($ÕÖ);$¦æ=explode(',',$ï†äÍ„['children']);if(in_array($š”‘,$¦æ)){return $¦[$ÕÖ];}}return !1;É©æ;}public static function _filter_list($¾,$õ='path'){if($GLOBALS['is_root'])return $¾;foreach($¾ as $Ë=>&$ï¨){unset($ï¨[$õ]);¼áð¨Óà¯¸¯³ÛÕ›;unset($ï¨['password']);”Ô‡ž””•ªßµ›;}return $¾;}public static function get_user_at_group($¦à){$‰ÒƒÝ=self::load_data();$–âæ=self::_filter_list($‰ÒƒÝ->get());½ä;if($¦à=='0'){return $–âæ;}$Ñ¹=array();foreach($–âæ as $ïÎ){if(isset($ïÎ['group_info'][$¦à])){$Ñ¹[]=$ïÎ;}}return $Ñ¹;}public static function user_share_sql($ù){static $¼•;if(!is_array($¼•)){$¼•=array();}if(!isset($¼•[$ù])){$¼‰³Æ=system_member::get_info($ù);if(!isset($¼‰³Æ['path'])){return;}$·¤é=new fileCache(USER_PATH.$¼‰³Æ['path'].'/data/share.php');$¼•[$ù]=$·¤é;}return $¼•[$ù];­Õë“ø¾Ì£®œâµ–‚ñ¬©Ëè³þ°·Ô ;}public static function user_share_list($”){$¿ÂÉ«Õ=self::user_share_sql($”);æ™ÀÉÏ×ÌÁ„õí©ž¹ÄòÙæ„îÛÃ;$¦ï=$¿ÂÉ«Õ->get();if($”==$_SESSION['kod_user']['user_id']){return $¦ï;}foreach($¦ï as $Ú¬Ñôì=>&$ÄÄ){unset($ÄÄ['share_password']);}return $¦ï;}public static function user_share_get($†ÉÞ”·,$¡){$ÃæÊž=self::user_share_sql($†ÉÞ”·);ª’¿Ð‚ÈºÜ;return $ÃæÊž->get('name',$¡);â¨–¨‘ñð±ªúÓ‚;}public function get($»ÌÜ='0'){$›=self::get_user_at_group($»ÌÜ);«†°óÁéÎßÌ÷öô‰”çúÆ;show_json($›);}public function add(){if(!isset($this->in['name'])|| !isset($this->in['password'])|| !isset($this->in['role'])|| !isset($this->in['group_info'])|| !isset($this->in['size_max']))show_json($this->L["data_not_full"],!1);$›”µÖá=trim(rawurldecode($this->in['name']));$üþ—«=rawurldecode($this->in['password']);$ÜŸ=json_decode(rawurldecode($this->in['group_info']),!0);¯ÊÕ§ÁË±;if(!is_array($ÜŸ)){show_json($this->L["system_member_group_error"],!1);}if($this->sql->get(array('name',$›”µÖá))){show_json($this->L['error_repeat'],!1);}if(!$GLOBALS['is_root']&& $this->in['role']=='1'){show_json($this->L['group_role_error'],!1);}$³¬Æ=array();if(isset($this->in['isImport'])){$¸Û=explode("\n",$›”µÖá);foreach($¸Û as $½íò){if(trim($½íò)!=''){$³¬Æ[]=trim($½íò);}}}else{$³¬Æ[]=$›”µÖá;}$‹ç˜©Ä=array();foreach($³¬Æ as $¯){if($this->sql->get('name',$¯)){$‹ç˜©Ä[]=$¯;continue;}$¹ù—=$this->sql->get_max_id().'';$»ã“’=array('user_id' =>$¹ù—,'name' =>$¯,'password' =>md5($üþ—«),'role' =>$this->in['role'],'config' =>array('size_max' =>floatval($this->in['size_max']),'size_use' =>0x00000400*0x00000400),'group_info'=> $ÜŸ,'path' =>hash_path($¯),'status' =>0x001,'last_login'=> '','create_time'=> time(),);if(!$GLOBALS['is_root']){show_json($this->L['no_permission'],!1);}if(isset($this->in['home_path'])){$»ã“’['home_path']=_DIR(rawurldecode($this->in['home_path']));if(!file_exists($»ã“’['home_path'])){show_json($this->L['not_exists'],!1);}$»ã“’['home_path']=iconv_app($»ã“’['home_path']);}else{unset($»ã“’['home_path']);ãéº¾úø¬í´šøœ³£áê®‘¬è‹ÄÊÇ¨ÝÚÀž‹Ÿ‚ô;}if($this->sql->set($¹ù—,$»ã“’)){$this->_initDir($»ã“’['path']);}else{$‹ç˜©Ä[]=$¯;}}$ÁïÓî=count($³¬Æ)-count($‹ç˜©Ä);Ø¥;$ü‡©=" success:$ÁïÓî";if($ÁïÓî==count($³¬Æ)){show_json($this->L['success'].$ü‡©,!0,$ÁïÓî);}else if($ÁïÓî!=0){$Ö=" error:".count($‹ç˜©Ä);show_json($this->L['success'].$ü‡©.$Ö,!1,implode("\n",$‹ç˜©Ä));}else{show_json($this->L['error_repeat'],!1);}}public function edit(){if(!$this->in['user_id'])show_json($this->L["data_not_full"],!1);$¤=$this->in['user_id'];$ìÄ¼Ç=$this->sql->get($¤);if(!$ìÄ¼Ç){show_json($this->L['error'],!1);}if(!$GLOBALS['is_root']&& $this->in['role']=='1'){show_json($this->L['group_role_error'],!1);}if(!$GLOBALS['is_root']&& $ìÄ¼Ç['role']=='1'){show_json($this->L['group_role_error_admin'],!1);}if($GLOBALS['is_root']&& $_SESSION['kod_user']['user_id']==$¤&& $this->in['role']!='1'){show_json($this->L['error'],!1);}$Ó¤ÝÉ=trim(rawurldecode($this->in['name']));if($ìÄ¼Ç['name']!=$Ó¤ÝÉ){if($this->sql->get(array('name',$Ó¤ÝÉ))){show_json($this->L['error_repeat'],!1);}}$this->in['name']=rawurlencode($Ó¤ÝÉ);Ó™Û™ò‚Öï‰›¢×°;$óµ=array('name','role','password','group_info','home_path','status','size_max');foreach($óµ as $ü¾¨Ñ){if(!isset($this->in[$ü¾¨Ñ]))continue;$ìÄ¼Ç[$ü¾¨Ñ]=rawurldecode($this->in[$ü¾¨Ñ]);ã§Ö·;if($ü¾¨Ñ=='password'){$ìÄ¼Ç['password']=md5($ìÄ¼Ç[$ü¾¨Ñ]);}else if($ü¾¨Ñ=='size_max'){$ìÄ¼Ç['config']['size_max']=floatval($ìÄ¼Ç[$ü¾¨Ñ]);}else if($ü¾¨Ñ=='group_info'){$ìÄ¼Ç['group_info']=json_decode(rawurldecode($this->in['group_info']),!0);}}if(!$GLOBALS['is_root']){show_json($this->L['no_permission'],!1);}if(isset($this->in['home_path'])){$ìÄ¼Ç['home_path']=_DIR(rawurldecode($this->in['home_path']));if(!file_exists($ìÄ¼Ç['home_path'])){show_json($this->L['not_exists'],!1);}$ìÄ¼Ç['home_path']=iconv_app($ìÄ¼Ç['home_path']);}else{unset($ìÄ¼Ç['home_path']);}if($this->sql->set($¤,$ìÄ¼Ç)){self::space_change($¤);show_json($this->L['success'],!0,$ìÄ¼Ç);}show_json($this->L['error_repeat'],!1);}public function do_action(){if(!isset($this->in['user_id'])){show_json($this->L["username_can_not_null"],!1);}$“Ïã–§=$this->in['action'];$ ¨ïÂ=json_decode($this->in['user_id'],!0);if(!is_array($ ¨ïÂ)){show_json($this->L['error'],!1);}if(in_array('1',$ ¨ïÂ)){show_json($this->L['default_user_can_not_do'],!1);}foreach($ ¨ïÂ as $‹ô){switch($“Ïã–§){case 'del':$À­=$this->sql->get($‹ô);if($this->sql->remove($‹ô)&& $À­['name']!=''){del_dir(USER_PATH.$À­['path'].'/');}break;case 'status_set':$¾ë¦Ï=intval($this->in['param']);$this->sql->set(array('user_id',$‹ô),array('status',$¾ë¦Ï));break;case 'role_set':$ƒê‹ó=$this->in['param'];–„¬¶¬œø­½…¢îÅÐì„½”•ŽÁÁÁ—Å­£¹­þ‘Ãƒ½ù°ÚóÞ™ù‚ˆ¿ÒõÄŠÙžÌ;if(!$GLOBALS['is_root']&& $ƒê‹ó=='1'){show_json($this->L['group_role_error'],!1);}$this->sql->set(array('user_id',$‹ô),array('role',$ƒê‹ó));break;case 'group_reset':$ãáˆ=json_decode($this->in['param'],!0);if(!is_array($ãáˆ)){show_json($this->L['error'],!1);}$this->sql->set(array('user_id',$‹ô),array('group_info',$ãáˆ));break;case 'group_remove_from':$­=$this->in['param'];$À­=$this->sql->get($‹ô);unset($À­['group_info'][$­]);Çñ›àëé«ðßð‚êË¡·èƒœÊ’¥çÐ­–Ó¹‚ÐõÊÂ’«®¯•Ú¡õË£à˜Ä™;$this->sql->set($‹ô,$À­);ÚÛ´«‰ÊþÂÍÐ¸˜“ËÃÂûÙžÏêÀ°ƒ…Ê„Í;break;case 'group_add':$ãáˆ=json_decode($this->in['param'],!0);†ÔåÐÓ¨Ÿ¥á·¸­úû©ÕšÆ¥…ˆÖ‰Ž¡Û¢;if(!is_array($ãáˆ)){show_json($this->L['error'],!1);}$À­=$this->sql->get($‹ô);foreach($ãáˆ as $„þåØ=>$¶­ŽÕ){$À­['group_info'][$„þåØ]=$¶­ŽÕ;ŒžŠ‰Èß£…©;}$this->sql->set($‹ô,$À­);default:break;ýÀƒ¡ ˆ¡†á‡½•”â;}}show_json($this->L['success']);}public function init_install(){$ï¥=system_member::load_data();$îŒœþ’=$ï¥->get();ù¿í»ÃÛË°â®¸ ½Í´¡Ô×‘ú„Šê;foreach($îŒœþ’ as $§=>&$£íƒ“è){$¤ˆ=hash_path();$this->_initDir($¤ˆ);$£íƒ“è['path']=$¤ˆ;‚ú…ÀÈºáž’óš–ý…§¦ïË”óÞý·ß£¿ñ¤”´‰—¯ØøÉ»˜Ü¯²ó®¸;$£íƒ“è['create_time']=time();}$ï¥->reset($îŒœþ’);éÆçÔ§‹•™°ªÎºÁýÉ›ö”Öð‡Âåµû‚Š¥éó;$±Ü˜=explode(',',$this->config['setting_system']['new_group_folder']);ó™ØÂÔ›ÀŸ¶¸³ŽÈ¥•Œ‹ÊˆÔ­÷Éðª¦‰„·;$ï¥=system_group::load_data();ºþ«ûžâ;$îŒœþ’=$ï¥->get();foreach($îŒœþ’ as $§=>&$£íƒ“è){$¤ˆ=hash_path();÷†ŠƒÑ’‘§À‰ð±´˜»¸¨ò±ÒƒìÑ¯èð’žÃ„»Š§¿ÜºÐ„ûÚõ­èÈ·Üù‹ßçÝÑÎ£ð’§ŽÎ²¶Žðß”ì»Š›Ë™…”ÑâÜÂöºÓÈŠö;$ŸÈ=GROUP_PATH.$¤ˆ.'/';úáïÚõÝ—€ùâ™€öëâ‡È¦þ„ùÈŽñ‚«‘Ë˜ãÊ“Å»î»š†»”éÕ•áÂ÷è‹Ÿçš°žŒ³Êž€ã‚ÊöÇ†æ„ ;foreach($±Ü˜ as $ÀµÖ–Ê){mk_dir($ŸÈ.'home/'.iconv_system($ÀµÖ–Ê));}$£íƒ“è['path']=$¤ˆ;äâ‹õü¼•Šïß¨ïÃ«»»;$£íƒ“è['create_time']=time();÷â¸˜çÏã¡©§ÃŠÎ…;}$ï¥->reset($îŒœþ’);}private function _initDir($š){$û=array('home','recycle','data');¿æ¨úÚêžÓÍ®Œæ–ÜÊ·†ñû•üÊ›…Öµ˜Ò°ÓÀïºèë–ÔŠé£¹öŠÏÓ;$ˆÚÇ„=explode(',',$this->config['setting_system']['new_user_folder']);ŒÊ¦Áâùò¶»ãñ¥Ð‰ùÚò”ê§ä¾üí™ÅñŠ‹Â—ÕéÙ¹ã;$ðŸ±ã=USER_PATH.$š.'/';¿ÝàÜñË…×Š‚;foreach($û as $¤È¸){mk_dir($ðŸ±ã.$¤È¸);}foreach($ˆÚÇ„ as $¤È¸){mk_dir($ðŸ±ã.'home/'.iconv_system($¤È¸));ªä ãÉíÕé ¹®¢§î€ˆËòÓÑËÝÓ‘ƒœÊ²ðÅø›ªš€ó‰ÕÝ©Ì·üÌ¿ÈÀ“šñî;}fileCache::save($ðŸ±ã.'data/config.php',$this->config['setting_default']);}}