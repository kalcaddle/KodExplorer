<?php class system_group extends Controller{public static $static_sql=null;private $sql;function __construct(){parent::__construct();$this->sql=self::load_data();$this->_init();€¿µ¸ñ®ôĞöéÌ³Ø§Åî„ÙçŒ¹…ÕÅÄ„áÜ€¹Å€ùú¹ëª®¼¡™ŠÕò±œá¶õÊÃ¯Ïšõ•×ñ;}public static function load_data(){if(is_null(self::$static_sql)){self::$static_sql=system_group_data();}return self::$static_sql;}public static function get_info($·){$³=self::load_data();ˆ¶€¡ÀÕ”òñö©çÂì˜“‡¨¦çšÅùÒä‡‡¾åÆ·åè÷»ıë­ô––¸„¯ËŒ¾ó²¦÷¡áİ¨éªÏäáµÍÚñËÇŸ;return $³->get($·);ùáåÆí¤»¡ÊÊšë­÷•—–Àçú£Èş•Æ¯×¤åÒ‡;}public static function space_change($™ôğ,$–¼ °=false){$Î©=self::load_data();$¿€Î»¤=$Î©->get($™ôğ);ûšê¬;if(!is_array($¿€Î»¤)){show_json($this->L["data_not_full"],!1);}if($–¼ °===!1){$’Å—Ş=_path_info_more(GROUP_PATH.$¿€Î»¤['path'].'/');$ŒĞµ£=$’Å—Ş['size'];if(isset($¿€Î»¤['home_path'])&& file_exists(iconv_app($¿€Î»¤['home_path']))){$’Å—Ş=_path_info_more(iconv_app($¿€Î»¤['home_path']));$ŒĞµ£+= $’Å—Ş['size'];}}else{$ŒĞµ£=floatval($¿€Î»¤['config']['size_use'])+floatval($–¼ °);}$¿€Î»¤['config']['size_use']=$ŒĞµ£<0?0:$ŒĞµ£;¦ş÷¿÷ÜúÉ€ÀÅ›«ñ»…ÔÒä´ß¶ê„ÄÂÙü;$Î©->set($™ôğ,$¿€Î»¤);ö˜íÓ“‹”Ëã¯÷Ö½³Ü“‡ÂÇçø³ë¾õÅ»ßŸ°Ö¸ªÌ©Èàõ­í„Î¡àá©¤ª‘İıÛÔÃ—´ãÈ‹œæ¶è;}public static function space_check($ş){$‡¬Û=self::load_data();—“Á·¸ÒÔ–Ğ±ê•ÉŸø;$«=$‡¬Û->get($ş);if(!is_array($«)){show_json($this->L["data_not_full"],!1);}$á€‹áÊ=floatval($«['config']['size_use']);$=floatval($«['config']['size_max']);if($!=0&& $*0x0000040000000<$á€‹áÊ){show_json($GLOBALS['L']['space_is_full'],!1);}}private function _init(){if(count($this->sql->get())>0)return;$À=array('1' =>array('group_id' =>'1','name' =>'root','parent_id' =>'','children' =>'','config' =>array('size_max' =>floatval(1.5),'size_use' =>floatval(0x00000400*0x00000400)),'path' =>hash_path(),'create_time'=> time(),));Şá‹—´à®†’š›Üº•îå«èÈ«ôª;$this->sql->reset($À);‘ùî±ÍÎ”;}public static function _filter_list($æÉº•,$Ì°ë©='path'){if($GLOBALS['is_root'])return $æÉº•;foreach($æÉº• as $™Ñ­ƒ=>&$Ø÷){unset($Ø÷[$Ì°ë©]);ş;}return $æÉº•;ÜÅÇ«Ù¡’¤Û¨ó©ØàÒÄáì—ï²;}public function get(){$èø¹ê÷=self::_filter_list($this->sql->get());show_json($èø¹ê÷,!0);Ãº®;}public function add(){if(!isset($this->in['name'])|| !isset($this->in['parent_id'])|| !isset($this->in['size_max']))show_json($this->L["data_not_full"],!1);$ÛÁ=$this->sql->get_max_id().'';¶àÃ—´‰ù¢ Š’ÓóûÌ­æÄÓä·×©ñ‡ÇÎÈŠ†³ÁçöÙ€Ó¿¡ŞÒ;$ÒÎÁ€µ=array('group_id' =>$ÛÁ,'name' =>rawurldecode($this->in['name']),'parent_id' =>$this->in['parent_id'],'children' =>'','config' =>array('size_max' =>floatval($this->in['size_max']),'size_use' =>floatval(0x00000400*0x00000400)),'path' =>hash_path($this->in['name']),'create_time'=> time(),);if(isset($this->in['home_path'])){$ÒÎÁ€µ['home_path']=_DIR(rawurldecode($this->in['home_path']));if(!file_exists($ÒÎÁ€µ['home_path'])){show_json($this->L['not_exists'],!1);}$ÒÎÁ€µ['home_path']=iconv_app($ÒÎÁ€µ['home_path']);}else{unset($ÒÎÁ€µ['home_path']);­Ä±µŒ€ş—‡²Øïª²;}$this->_parent_child_change($ÒÎÁ€µ,!0);if($this->sql->set($ÛÁ,$ÒÎÁ€µ)){$this->_initDir($ÒÎÁ€µ['path']);show_json($this->L['success']);}show_json($this->L['error'],!1);}public function edit(){if(!$this->in['group_id'])show_json($this->L["data_not_full"],!1);$Í=$this->sql->get($this->in['group_id']);Â¹î„º¥‹ÁÊ½†ûò“üò«„¥„ó;if(!is_array($Í)){show_json($this->L['not_exists'],!1);}if(isset($this->in['name'])){$Í['name']=rawurldecode($this->in['name']);}if(isset($this->in['size_max'])){$Í['config']['size_max']=floatval($this->in['size_max']);}if(isset($this->in['parent_id'])&& $Í['parent_id']!='' && $this->in['parent_id']!=$Í['parent_id']){$·û¿=explode(',',$Í['children']);if(in_array($this->in['parent_id'],$·û¿)){show_json($this->L['current_has_parent'],!1);}self::space_change($this->in['group_id']);$this->_parent_child_change($Í,!1);ïŒàßœ†œ¬ÇæêÎãŞâàÑ;$Í['parent_id']=$this->in['parent_id'];ÙÇËÚÄ‹«²œš“û«¯;$this->_parent_child_change($Í,!0);}if(isset($this->in['home_path'])){$Í['home_path']=_DIR(rawurldecode($this->in['home_path']));if(!file_exists($Í['home_path'])){show_json($this->L['not_exists'],!1);}$Í['home_path']=iconv_app($Í['home_path']);}else{unset($Í['home_path']);¯Ç›“¦şôøÙï¡³¸íıø»Œ¬×¦¿ÔÑï×šÌ¤É•¿İ»¾Ò´Ì­¥îáŞÜ;}if($Í!=$this->sql->get($this->in['group_id'])){$this->sql->set($this->in['group_id'],$Í);}show_json($this->L['success']);}public function del(){if(!isset($this->in['group_id']))show_json($this->L["data_not_full"],!1);if(strlen($this->in['group_id'])<=0x001)show_json($this->L['default_user_can_not_do'],!1);$ÜÖ­éƒ=$this->sql->get($this->in['group_id']);$this->_parent_child_change($ÜÖ­éƒ,!1);$this->sql->set(array('parent_id',$ÜÖ­éƒ["group_id"]),array('parent_id','1'));³²ıÖÇ––¦ÒÕø‡¢§­‘‰îúéÅ©ÔÈ¯åŒŠÉÀ½ÇÁ”×«¶ª‚°²¤×à¶àí¥ÜØê†­´¶;system_member::group_remove_user_update($ÜÖ­éƒ["group_id"]);$this->sql->remove($this->in['group_id']);‚ı¥Ã“µœ¿ìÆÁùåõÚÖÈÂ´¢®»Ïãñã¥³Á¨±æìÄ‰„‹Ğ;if(strlen($ÜÖ­éƒ['path'])!=0){del_dir(GROUP_PATH.$ÜÖ­éƒ['path'].'/');show_json($this->L['success']);}show_json($this->L['error'],!1);}private function _parent_child_change($¨Ê¬,$¦É){if(!is_array($¨Ê¬)){show_json($this->L['not_exists'],!1);}if($¨Ê¬['parent_id']==0x001){return;}$ï«’¼=$¨Ê¬['group_id'];$â ÙÇÅ=explode(',',$¨Ê¬['children']);if($â ÙÇÅ[0]==''){unset($â ÙÇÅ[0]);}$â ÙÇÅ[]=$¨Ê¬['group_id'];while(strlen($¨Ê¬['group_id'])>0x0002){$¨Ê¬=$this->sql->get($¨Ê¬['parent_id']);if(!is_array($¨Ê¬)){show_json($this->L['not_exists'],!1);}$¿ğÛ…=explode(',',$¨Ê¬['children']);if($¿ğÛ…[0]==''){unset($¿ğÛ…[0]);}if($¦É){foreach($â ÙÇÅ as $Šš¶Ğ=>$‚ıâ){$¿ğÛ…[]=$‚ıâ;}}else{foreach($¿ğÛ… as $Šš¶Ğ=>$‚ıâ){if(in_array($‚ıâ,$â ÙÇÅ))unset($¿ğÛ…[$Šš¶Ğ]);}}$ÇÙ=implode(',',$¿ğÛ…);if($ÇÙ!=$¨Ê¬['children']){$¨Ê¬['children']=$ÇÙ;$this->sql->set($¨Ê¬['group_id'],$¨Ê¬);}}}private function _initDir($†«’í){$²=array('home','data');Öàç–ÒÃœá©¦üàöÀâô¤Œ½ı¥“…Ñ¦óàÙ¼¸Ó”š»ªì€ÆÏªíÌ‹äíÙ²ù˜± ¬·ñÒ«Ó­çŒû§½§•½î;$èÜ²ó=$this->config['setting_system']['new_group_folder'];œóİµ¦ıáİïµ‰ÃâñĞãîø¡—ß†óÈã§½¦è Ãİşø„üÚáíë²ó;$„×Ìü=explode(',',$èÜ²ó);Øê€¢Î¨ßõ;$†«’í=GROUP_PATH.$†«’í.'/';mk_dir($†«’í);foreach($² as $ï€³){mk_dir($†«’í.$ï€³);ÖìŸÃŸ”¡£ëî¡å;}foreach($„×Ìü as $ï€³){mk_dir($†«’í.'home/'.iconv_system($ï€³));¿®á×Á…éÃ¾ÙÄñÎÂ¦¯¡éÏ;}}}