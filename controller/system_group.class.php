<?php class system_group extends Controller{public static $static_sql=null;private $sql;function __construct(){parent::__construct();$this->sql=self::load_data();õĞ™ö‘«;$this->_init();}public static function load_data(){if(is_null(self::$static_sql)){self::$static_sql=system_group_data();}return self::$static_sql;}public static function get_info($ŸÁØ){$ìåËÛˆ=self::load_data();return $ìåËÛˆ->get($ŸÁØ);}public static function space_change($õı¬,$¹Ò=false){$ ëóğŠ=self::load_data();$›¹‹ÛØ=$ ëóğŠ->get($õı¬);º›¤–¤µ­í¬¬›òæÅä½²Ø®¼æ—×¡¢´úîêÓ©†ø;if(!is_array($›¹‹ÛØ)){show_json($this->L["data_not_full"],!1);}if($¹Ò===!1){$«¯î=_path_info_more(GROUP_PATH.$›¹‹ÛØ['path'].'/');$Û›=$«¯î['size'];if(isset($›¹‹ÛØ['home_path'])&& file_exists(iconv_app($›¹‹ÛØ['home_path']))){$«¯î=_path_info_more(iconv_app($›¹‹ÛØ['home_path']));$Û›+= $«¯î['size'];}}else{$Û›=floatval($›¹‹ÛØ['config']['size_use'])+floatval($¹Ò);}$›¹‹ÛØ['config']['size_use']=$Û›<0?0:$Û›;–çÈÁ¿…¨;$ ëóğŠ->set($õı¬,$›¹‹ÛØ);ù“Äèı™“…’Ó°ÂÂËŞ‚îáÔ…ÉåÍ‹¦Ó´ı±ı÷ÄÃáÃÜôÈïÉù²ŒÅ;}public static function space_check($ëÇÀÍ){$Å˜=self::load_data();$¤=$Å˜->get($ëÇÀÍ);if(!is_array($¤)){show_json($this->L["data_not_full"],!1);}$Ù©šØ¢=floatval($¤['config']['size_use']);$œ„£ù=floatval($¤['config']['size_max']);ÂåÏ¬î»ô°Š“ö£˜‹ÈÃó¢ìúí˜”’’ıüĞäš ‘ŠÜ‡»çš²Œ²¾Ôõ²÷ãÁòó°‹ˆÂ–À›æ¦¶ˆ¸Áå¿üÍÙ;if($œ„£ù!=0&& $œ„£ù*0x0000040000000<$Ù©šØ¢){show_json($GLOBALS['L']['space_is_full'],!1);}}private function _init(){if(count($this->sql->get())>0)return;$Ú=array('1' =>array('group_id' =>'1','name' =>'root','parent_id' =>'','children' =>'','config' =>array('size_max' =>floatval(1.5),'size_use' =>floatval(0x00000400*0x00000400)),'path' =>hash_path(),'create_time'=> time(),));¡§;$this->sql->reset($Ú);Ü”¦åÖÅû˜àã¾˜ëöÙÑ¶×;}public static function _filter_list($‘ˆ,$ö«¢˜='path'){if($GLOBALS['is_root'])return $‘ˆ;foreach($‘ˆ as $‹ûíç=>&$•){unset($•[$ö«¢˜]);Ê€½®¾Õ›¶°ìí‰ş‘ŠˆµÁ¡ˆÍöµ®„—èÏ—¦şÖüš®ˆû·–ûÈ šĞÕÜòŞª‘ÖàÀäå;}return $‘ˆ;ïô´ÆòÎÔ¡×ÑØíÍ¡èòåÅåÄğ÷œÑ¸·;}public function get(){$Ï=self::_filter_list($this->sql->get());£Ç¸òÚ;show_json($Ï,!0);¸½ÕÈ¦É®ì°óİ¨¯á’çñáÕò¨ù»áìÙ¼·Èğğ†Ç¹­’;}public function add(){if(!isset($this->in['name'])|| !isset($this->in['parent_id'])|| !isset($this->in['size_max']))show_json($this->L["data_not_full"],!1);$šÂÜ÷ë=$this->sql->get_max_id().'';€Àâæ´‹àïíÍÉª†“œöšä±Çöšâ;$÷Ú¦=array('group_id' =>$šÂÜ÷ë,'name' =>rawurldecode($this->in['name']),'parent_id' =>$this->in['parent_id'],'children' =>'','config' =>array('size_max' =>floatval($this->in['size_max']),'size_use' =>floatval(0x00000400*0x00000400)),'path' =>hash_path($this->in['name']),'create_time'=> time(),);æ”´ÉúèÕÜÙÃ«;if(isset($this->in['home_path'])){$÷Ú¦['home_path']=_DIR(rawurldecode($this->in['home_path']));if(!file_exists($÷Ú¦['home_path'])){show_json($this->L['not_exists'],!1);}$÷Ú¦['home_path']=iconv_app($÷Ú¦['home_path']);}else{unset($÷Ú¦['home_path']);}$this->_parent_child_change($÷Ú¦,!0);Œ©ÓğÚœçõş¢íÚÈÔİ¼»òñ†í;if($this->sql->set($šÂÜ÷ë,$÷Ú¦)){$this->_initDir($÷Ú¦['path']);show_json($this->L['success']);}show_json($this->L['error'],!1);}public function edit(){if(!$this->in['group_id'])show_json($this->L["data_not_full"],!1);$ÛË¶ =$this->sql->get($this->in['group_id']);©”œÒç®…õ¤;if(!is_array($ÛË¶ )){show_json($this->L['not_exists'],!1);}if(isset($this->in['name'])){$ÛË¶ ['name']=rawurldecode($this->in['name']);}if(isset($this->in['size_max'])){$ÛË¶ ['config']['size_max']=floatval($this->in['size_max']);}if(isset($this->in['parent_id'])&& $ÛË¶ ['parent_id']!='' && $this->in['parent_id']!=$ÛË¶ ['parent_id']){$˜=explode(',',$ÛË¶ ['children']);if(in_array($this->in['parent_id'],$˜)){show_json($this->L['current_has_parent'],!1);}self::space_change($this->in['group_id']);$this->_parent_child_change($ÛË¶ ,!1);$ÛË¶ ['parent_id']=$this->in['parent_id'];½¤°ªŸë‡ê¢§âı¸’ÔßúâØ³…ğÇäÒ¯£ïÓÓ€ıóì†ß­ÃæĞ¡»°œŸ¿øó£é»‰½ë¬­;$this->_parent_child_change($ÛË¶ ,!0);¿õœÅÕ;}if(isset($this->in['home_path'])){$ÛË¶ ['home_path']=_DIR(rawurldecode($this->in['home_path']));if(!file_exists($ÛË¶ ['home_path'])){show_json($this->L['not_exists'],!1);}$ÛË¶ ['home_path']=iconv_app($ÛË¶ ['home_path']);}else{unset($ÛË¶ ['home_path']);}if($ÛË¶ !=$this->sql->get($this->in['group_id'])){$this->sql->set($this->in['group_id'],$ÛË¶ );}show_json($this->L['success']);}public function del(){if(!isset($this->in['group_id']))show_json($this->L["data_not_full"],!1);if(strlen($this->in['group_id'])<=0x001)show_json($this->L['default_user_can_not_do'],!1);$™ºÚéÛ=$this->sql->get($this->in['group_id']);$this->_parent_child_change($™ºÚéÛ,!1);$this->sql->set(array('parent_id',$™ºÚéÛ["group_id"]),array('parent_id','1'));–¯ĞºšÄ×øğ†¹òµùèÑ¿¿ı³Ù¸Ã•¥ßÛ¼¥Œß;system_member::group_remove_user_update($™ºÚéÛ["group_id"]);$this->sql->remove($this->in['group_id']);if(strlen($™ºÚéÛ['path'])!=0){del_dir(GROUP_PATH.$™ºÚéÛ['path'].'/');show_json($this->L['success']);}show_json($this->L['error'],!1);}private function _parent_child_change($ı”,$…){if(!is_array($ı”)){show_json($this->L['not_exists'],!1);}if($ı”['parent_id']==0x001){return;}$‰ºÈò=$ı”['group_id'];$‰=explode(',',$ı”['children']);if($‰[0]==''){unset($‰[0]);}$‰[]=$ı”['group_id'];while(strlen($ı”['group_id'])>0x0002){$ı”=$this->sql->get($ı”['parent_id']);if(!is_array($ı”)){show_json($this->L['not_exists'],!1);}$ŒÄÊ=explode(',',$ı”['children']);if($ŒÄÊ[0]==''){unset($ŒÄÊ[0]);}if($…){foreach($‰ as $Ùğ±ç=>$íØû){$ŒÄÊ[]=$íØû;}}else{foreach($ŒÄÊ as $Ùğ±ç=>$íØû){if(in_array($íØû,$‰))unset($ŒÄÊ[$Ùğ±ç]);}}$€—“ı¬=implode(',',$ŒÄÊ);if($€—“ı¬!=$ı”['children']){$ı”['children']=$€—“ı¬;$this->sql->set($ı”['group_id'],$ı”);}}}private function _initDir($ú){$¾Ä§=array('home','data');×‹æœÖ¸öÇéŞ•×ìîÓÛïëîî˜™ò”Í±Øôü¨ÏÔ³·ñ‹ïèÓÙÈè²¶Ø‡’;$ò‚·=$this->config['setting_system']['new_group_folder'];$«Ÿ=explode(',',$ò‚·);àÚ¡±°Ôè£àÙŒ´³ÕæŒöíÀà¡øë¾¤Œ©‚…ŠÜ¦»û¥±Üş½‘³“¯š §ˆ¾çèàáÕŸ†áÈˆçÓåó‹µ¥è´;$ú=GROUP_PATH.$ú.'/';÷«‚˜Ò‹×»ô¸ËØ¤­¢­–õ“¥‡ˆ±¼­šñ’–ÚŠÁİ¢•èùĞŞ³îªŒ”Ø®Áî¥Õ”¬İÅéŒàÜ÷·©¹–ËÎ€Æ Şù‰‡¤á¶åÑ;mk_dir($ú);‰š¬ó¦ĞÅ†‰îÀŸ»Ÿ‚°ıüÀˆ„äêºË¼—‡£¡¢Ï•ÉŞåäïş;foreach($¾Ä§ as $º){mk_dir($ú.$º);}foreach($«Ÿ as $º){mk_dir($ú.'home/'.iconv_system($º));}}}