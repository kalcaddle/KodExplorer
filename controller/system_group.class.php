<?php class system_group extends Controller{public static $static_sql=null;private $sql;function __construct(){parent::__construct();$this->sql=self::load_data();Êó†ŞŒË¯¦Œ˜ışı×ôÀ¨±œşÆ–úÎˆ÷ªÒùØØ«¤‰ºË•ÓÉ•Ò¡Š“Ê©¤ûÅ¤ÂÛ ’ã˜½·“Ü‘ëˆµôÃ;$this->_init();}public static function load_data(){if(is_null(self::$static_sql)){self::$static_sql=system_group_data();}return self::$static_sql;}public static function get_info($˜){$ êì=self::load_data();return $ êì->get($˜);£´šÇööçŠÚÇ“”¤¤­ÚõğÜŠ¨¢ô–ÌôÎ¡˜ƒ;}public static function space_change($àú³,$…Ê=false){$¢ßğÆ=self::load_data();×ıÙš§û½;$…ë=$¢ßğÆ->get($àú³);if(!is_array($…ë)){show_json($this->L["data_not_full"],!1);}if($…Ê===!1){$¨=_path_info_more(GROUP_PATH.$…ë['path'].'/');$ŒÛÈ‘ê=$¨['size'];if(isset($…ë['home_path'])&& file_exists(iconv_app($…ë['home_path']))){$¨=_path_info_more(iconv_app($…ë['home_path']));$ŒÛÈ‘ê+= $¨['size'];}}else{$ŒÛÈ‘ê=floatval($…ë['config']['size_use'])+floatval($…Ê);}$…ë['config']['size_use']=$ŒÛÈ‘ê<0?0:$ŒÛÈ‘ê;ĞÓÖîõ¯€ô‰›œ†«ÚĞ°ç¼;$¢ßğÆ->set($àú³,$…ë);Î†Á˜—¬­öº¢Çù·…©¸ù³Ó—ºşñ‹°ÚÈ€Ó®ÏÙïèñ–é×¹±æ³éëÜ¢å‘õıËõïÖ§Ê §ŸÎ÷ù¿àìÜöÖµ±‰œåòˆ;}public static function space_check($–îÔ){$ì=self::load_data();$İ=$ì->get($–îÔ);˜ÒÈçÊÂ¨«°…£‡»;if(!is_array($İ)){show_json($this->L["data_not_full"],!1);}$×»„=floatval($İ['config']['size_use']);$şšÏÓ=floatval($İ['config']['size_max']);if($şšÏÓ!=0&& $şšÏÓ*0x0000040000000<$×»„){show_json($GLOBALS['L']['space_is_full'],!1);}}private function _init(){if(count($this->sql->get())>0)return;$ó«›=array('1' =>array('group_id' =>'1','name' =>'root','parent_id' =>'','children' =>'','config' =>array('size_max' =>floatval(1.5),'size_use' =>floatval(0x00000400*0x00000400)),'path' =>hash_path(),'create_time'=> time(),));…©íóÑ– ‚œÄ‰×šš°ÖŸ‘Õ¹à©áŸ»‹ã‘€‚à–¢;$this->sql->reset($ó«›);ìŒ‚ˆ¼Ø§Í¯á¯ØÄÎ÷Ñ‹ƒ¶Œ•Ã›•Åû¬èßßĞÌëÓÔ¨­ü;}public static function _filter_list($ÜŞ¦¶£,$®õ²¬='path'){if($GLOBALS['is_root'])return $ÜŞ¦¶£;foreach($ÜŞ¦¶£ as $Ç=>&$©İ·¦Š){unset($©İ·¦Š[$®õ²¬]);}return $ÜŞ¦¶£;}public function get(){$ğÓÖÅ©=self::_filter_list($this->sql->get());show_json($ğÓÖÅ©,!0);Ï††ª”µ –çÍ¤°¿Íöó˜—ùƒ‰ÍÙÏ÷ÙÂÑ“¥ï™;}public function add(){if(!isset($this->in['name'])|| !isset($this->in['parent_id'])|| !isset($this->in['size_max']))show_json($this->L["data_not_full"],!1);$„Ïïš=$this->sql->get_max_id().'';$¾èı=array('group_id' =>$„Ïïš,'name' =>rawurldecode($this->in['name']),'parent_id' =>$this->in['parent_id'],'children' =>'','config' =>array('size_max' =>floatval($this->in['size_max']),'size_use' =>floatval(0x00000400*0x00000400)),'path' =>hash_path($this->in['name']),'create_time'=> time(),);if(isset($this->in['home_path'])){$¾èı['home_path']=_DIR(rawurldecode($this->in['home_path']));if(!file_exists($¾èı['home_path'])){show_json($this->L['not_exists'],!1);}$¾èı['home_path']=iconv_app($¾èı['home_path']);}else{unset($¾èı['home_path']);‘;}$this->_parent_child_change($¾èı,!0);ÊïæÂÊ;if($this->sql->set($„Ïïš,$¾èı)){$this->_initDir($¾èı['path']);show_json($this->L['success']);}show_json($this->L['error'],!1);}public function edit(){if(!$this->in['group_id'])show_json($this->L["data_not_full"],!1);$áœ=$this->sql->get($this->in['group_id']);if(!is_array($áœ)){show_json($this->L['not_exists'],!1);}if(isset($this->in['name'])){$áœ['name']=rawurldecode($this->in['name']);}if(isset($this->in['size_max'])){$áœ['config']['size_max']=floatval($this->in['size_max']);}if(isset($this->in['parent_id'])&& $áœ['parent_id']!='' && $this->in['parent_id']!=$áœ['parent_id']){$Œ=explode(',',$áœ['children']);if(in_array($this->in['parent_id'],$Œ)){show_json($this->L['current_has_parent'],!1);}self::space_change($this->in['group_id']);$this->_parent_child_change($áœ,!1);§Ç¬ß‡ëÉ…ùÂú;$áœ['parent_id']=$this->in['parent_id'];÷é¡ÂÙˆ;$this->_parent_child_change($áœ,!0);}if(isset($this->in['home_path'])){$áœ['home_path']=_DIR(rawurldecode($this->in['home_path']));if(!file_exists($áœ['home_path'])){show_json($this->L['not_exists'],!1);}$áœ['home_path']=iconv_app($áœ['home_path']);}else{unset($áœ['home_path']);}if($áœ!=$this->sql->get($this->in['group_id'])){$this->sql->set($this->in['group_id'],$áœ);}show_json($this->L['success']);}public function del(){if(!isset($this->in['group_id']))show_json($this->L["data_not_full"],!1);if(strlen($this->in['group_id'])<=0x001)show_json($this->L['default_user_can_not_do'],!1);$çÁğ=$this->sql->get($this->in['group_id']);ÆàïĞ–ù›œóİ—ï²¡çÂ«÷Ë±şšßïŠ®¹Ñ©àúö;$this->_parent_child_change($çÁğ,!1);$this->sql->set(array('parent_id',$çÁğ["group_id"]),array('parent_id','1'));system_member::group_remove_user_update($çÁğ["group_id"]);$this->sql->remove($this->in['group_id']);if(strlen($çÁğ['path'])!=0){del_dir(GROUP_PATH.$çÁğ['path'].'/');show_json($this->L['success']);}show_json($this->L['error'],!1);}private function _parent_child_change($«ı§Ìæ,$’½){if(!is_array($«ı§Ìæ)){show_json($this->L['not_exists'],!1);}if($«ı§Ìæ['parent_id']==0x001){return;}$ÄÛÚŞ=$«ı§Ìæ['group_id'];$Ëéê=explode(',',$«ı§Ìæ['children']);if($Ëéê[0]==''){unset($Ëéê[0]);}$Ëéê[]=$«ı§Ìæ['group_id'];while(strlen($«ı§Ìæ['group_id'])>0x0002){$«ı§Ìæ=$this->sql->get($«ı§Ìæ['parent_id']);if(!is_array($«ı§Ìæ)){show_json($this->L['not_exists'],!1);}$¯œš«”=explode(',',$«ı§Ìæ['children']);if($¯œš«”[0]==''){unset($¯œš«”[0]);}if($’½){foreach($Ëéê as $Á§Á=>$ÓÀŞ){$¯œš«”[]=$ÓÀŞ;}}else{foreach($¯œš«” as $Á§Á=>$ÓÀŞ){if(in_array($ÓÀŞ,$Ëéê))unset($¯œš«”[$Á§Á]);}}$§¤=implode(',',$¯œš«”);if($§¤!=$«ı§Ìæ['children']){$«ı§Ìæ['children']=$§¤;$this->sql->set($«ı§Ìæ['group_id'],$«ı§Ìæ);}}}private function _initDir($âŒ€){$çßù=array('home','data');$åº…=$this->config['setting_system']['new_group_folder'];û–¶¯×Şñ²²íÒÚ“„–õ‘–µùõ°®;$–éÅ=explode(',',$åº…);óêŸ¤Âş–Ñ±ÉÀ…¥ÓŠ»Ê›Ò€•È±Ä‰Ç®ÏÀƒ¸´íØÙ±×ï„ŠºÄß™šœãµîäË·–ÁŞ¿;$âŒ€=GROUP_PATH.$âŒ€.'/';mk_dir($âŒ€);foreach($çßù as $ÊÔ±){mk_dir($âŒ€.$ÊÔ±);}foreach($–éÅ as $ÊÔ±){mk_dir($âŒ€.'home/'.iconv_system($ÊÔ±));}}}