<?php class user extends Controller{private $user;private $auth;private $notCheck;function __construct(){parent::__construct();±øž™åðÛÒ;$this->tpl=TEMPLATE.'user/';if(!isset($_SESSION)){$this->login(DATA_PATH."<br/>".$GLOBALS['L']['path_can_not_write_data']);}else{$this->user=&$_SESSION['kod_user'];if(!isset($this->user['path'])&& isset($this->user['name'])){$this->user['path']=$this->user['name'];}}$this->notCheck=array('loginFirst','login','logout','loginSubmit','checkCode','public_link','qrcode','sso');ÔÉÑ ±‚áƒž²ÚÙÆøÇ¸¸Ùê±ø„˜éßëë¤»çù…ºš·¼ü»Ú°–µÎÝ®—–æð™é…±Óåž¿ŠÙ¨…ßâ;$this->notCheckApp=array('share','debug');$this->config['forceWap']=is_wap()&&(!isset($_COOKIE['forceWap'])|| $_COOKIE['forceWap']=='1');}public function loginCheck(){if(in_array(ST,$this->notCheckApp))return;if(in_array(ACT,$this->notCheck))return;if(isset($_SESSION['kod_login'])&& $_SESSION['kod_login']===!0){$Ò=system_member::get_info($this->user['user_id']);$this->login_success($Ò);return;}else if($_COOKIE['kod_user_id']!='' && $_COOKIE['kod_token']!=''){$Ò=system_member::get_info($_COOKIE['kod_user_id']);if(!is_array($Ò)|| !isset($Ò['password'])){$this->logout();}if($this->make_login_token($Ò)==$_COOKIE['kod_token']){@session_start();$_SESSION['kod_login']=!0;$_SESSION['kod_user']=$Ò;$_SESSION['CSRF-TOKEN']=rand_string(0x014);setcookie('CSRF-TOKEN',$_SESSION['CSRF-TOKEN'],time()+0x0e10*0x0000018*0x064);setcookie('kod_user_id',$_COOKIE['kod_user_id'],time()+0x0e10*0x0000018*0x064);setcookie('kod_token',$_COOKIE['kod_token'],time()+0x0e10*0x0000018*0x064);@session_write_close();unset($_SESSION);@session_start();if(!isset($_SESSION['kod_user'])|| !is_array($_SESSION['kod_user'])){$this->login(DATA_PATH."<br/>".$GLOBALS['L']['path_can_not_write_data']);}else{$this->login_success($Ò);}return;}$this->logout();°œÇÞ³ÝÆ¥ßßå’ãË°¤ÕŠÍÛé°û‚Ð™ÔËç¿ü…‡Û¹å£ÞÆƒî¬•Ó÷Å÷ÎÐÅª»ö;}else{if($this->config['setting_system']['auto_login']!='1'){$this->logout();}else{if(!file_exists(USER_SYSTEM.'install.lock')){$this->display('install.html');exit;}header('location:./index.php?user/loginSubmit&name=guest&password=guest');exit;}}}private function login_success($ÇÀ“){$this->user=$ÇÀ“;if(!$ÇÀ“['path']){$this->login($this->L['kod_version_error']);}else if($ÇÀ“['status']==0){$this->login($this->L['login_error_user_not_use']);}else if($ÇÀ“['role']==''){$this->login($this->L['login_error_role']);}define('USER',USER_PATH.$this->user['path'].'/');define('USER_TEMP',USER.'data/temp/');define('USER_RECYCLE',USER.'recycle/');ÚíçÁ‘Çˆ”¶;if(!file_exists(USER)){$this->logout();}if($this->user['role']=='1'){define('MYHOME',USER.'home/');define('HOME','');$GLOBALS['web_root']=WEB_ROOT;$GLOBALS['is_root']=0x001;}else{$ªŠ­=user_home_path($this->user);define('HOME',$ªŠ­);define('MYHOME','/');$GLOBALS['web_root']='';$GLOBALS['is_root']=0;}$this->config['user']=fileCache::load(USER.'data/config.php');if(!isset($this->config['user']['file_repeat'])|| !isset($this->config['user']['resize_config'])){$this->config['user']['file_repeat']=$this->config['setting_default']['file_repeat'];$this->config['user']['recycle_open']=$this->config['setting_default']['recycle_open'];$this->config['user']['resize_config']=$this->config['setting_default']['resize_config'];}if($this->config['user']['theme']==''){$this->config['user']=$this->config['setting_default'];}}public function sso(){$ƒûÁÉ§=!1;º‰Íž¸¡°æûžÏ½°—ÆÅÎûïÙ©áÜ¦£§Í¡çœÜñ¬«;$ä="not login";Éàœˆ‘³ÎÖ‚ÊÇÛô©¹›ÍàéîÉ†Ë¼²÷Í˜ÄäŽï;if(isset($_SESSION)&& $_SESSION['kod_login']==0x001){$‚=$_SESSION['kod_user'];if($‚['role']=='1' || !isset($this->in['check'])|| !isset($this->in['value'])){$ƒûÁÉ§=!0;}$åÙ¸=!1;switch($this->in['check']){case 'user_id':$åÙ¸=$‚['user_id'];break;case 'user_name':$åÙ¸=$‚['name'];break;case 'role_id':$åÙ¸=$‚['role'];™°­‰ù³Ô·æÌ…€’•ä¡†æ¸ˆŸáÕÑ„êøÏº¼èêéò;break;†•£†¨¸ëÊ¾ÓƒÇð£ªÆô;case 'role_name':$²î=system_role::get_info($‚['role']);èØ–Û¾´¤Üºº€Áâ¹­­ø±ÀòÕë¹ËšìºšÙæ;$åÙ¸=$²î['name'];break;case 'group_id':$åÙ¸=array_keys($‚['group_info']);²ƒÎí½Î¯¡‰ÜÎ‚ÞÃÑÖ¯Œ£ÊøÝäÒÅç†ÃÆ÷õÉÆäˆ–”©Ÿñø¡Ðúä£Ò”¯õß©ÔÄüš¬ƒÞóûÕ½ÂºÆÙÎ;break;é›’ä¶¸–å®õƒºžç‘üÛÒšÐàªÜÑ¤ž¼À°¢ÁæÚ×Í‰ÎÞŠë¬ñü;case 'group_name':$åÙ¸=array();foreach($‚['group_info'] as $ŠüçÚ=>$È){$ç=system_group::get_info($ŠüçÚ);$åÙ¸[]=$ç['name'];}break;default:break;ù­ŸÔ†íÞÔÌìÞ¹™Ð¶ÃŸÁÁ‡ÍÐ£¶ëÎ½Ä¹õ¾ç•”í„ó;}if(!$ƒûÁÉ§&& $åÙ¸!=!1){if((is_string($åÙ¸)&& $åÙ¸==$this->in['value'])||(is_array($åÙ¸)&& in_array($this->in['value'],$åÙ¸))){$ƒûÁÉ§=!0;}else{$ä=$this->in['check'].' not accessed, It\'s must be "'.$this->in['value'].'"';}}}if($ƒûÁÉ§){@session_name('KOD_SESSION_SSO');@session_id($_COOKIE['KOD_SESSION_SSO']);@session_start();$_SESSION[$this->in['app']]='success';@session_write_close();header('location:'.$this->in['link']);exit;}$this->login($ä);}public function public_link(){$Ðà¢=$this->config['setting_system']['system_password'];$óÁ¿“„=$this->in['fid'];$¢Î=Mcrypt::decode($óÁ¿“„,$Ðà¢);×•Ã;if(strlen($¢Î)==0){show_json($this->L['error'],!1);}$Ï¹=isset($_GET['download']);file_put_out($¢Î,$Ï¹);ð¥Óäè¥Æ‹°Áþò“öƒ®šÒšàØòõœÅÕìý¥;}public function common_js(){$£øÃ=ob_get_clean();$˜=BASIC_PATH;ÂÏ¬ºÒÚÔ¦ôµþè«;$ùñ=USER_PATH;—Å”Š¢¯•ºþâÓÁ²€ü†ÚÑ¬Ð‡«º³Æ´¦¸›—Ïá¬àëÎ‚ŠäÞÒ˜ÞÏžº¡ÊŒ©õÆÜ½ú„ö—›ÇøÈ¨å—¹ç¡ÉÍ€;$åß=GROUP_PATH;ŽÎ§;if(!$GLOBALS['is_root']){$˜='/';$ùñ='/';$åß='/';}$Åí”=array('lang' =>LANGUAGE_TYPE,'is_root' =>$GLOBALS['is_root'],'user_id' =>$this->user['user_id'],'web_root' =>$GLOBALS['web_root'],'web_host' =>HOST,'app_host' =>APPHOST,'static_path' =>STATIC_PATH,'basic_path' =>$˜,'user_path' =>$ùñ,'group_path' =>$åß,'myhome' =>MYHOME,'upload_max' =>file_upload_size(),'version' =>KOD_VERSION,'json_data' =>"",'self_share' =>system_member::user_share_list($this->user['user_id']),'user_config' =>$this->config['user'],'KOD_GROUP_PATH' =>KOD_GROUP_PATH,'KOD_GROUP_SHARE' =>KOD_GROUP_SHARE,'KOD_USER_SHARE' =>KOD_USER_SHARE,'KOD_USER_RECYCLE' =>KOD_USER_RECYCLE,'KOD_USER_FAV' =>KOD_USER_FAV,'KOD_GROUP_ROOT_SELF' =>KOD_GROUP_ROOT_SELF,'KOD_GROUP_ROOT_ALL' =>KOD_GROUP_ROOT_ALL,);if(isset($this->config['setting_system']['version_hash'])){$Åí”['version_hash']=$this->config['setting_system']['version_hash'];}if(!isset($GLOBALS['auth'])){$GLOBALS['auth']=array();}$é='LNG='.json_encode($GLOBALS['L']).';';$é.= 'AUTH='.json_encode($GLOBALS['auth']).';';$é.= 'G='.json_encode($Åí”).';';Áúüêá;header("Content-Type: application/javascript");echo $é;}public function login($·î—=''){if(!file_exists(USER_SYSTEM.'install.lock')){chmod_path(BASIC_PATH,0777);$this->display('install.html');exit;}$this->assign('msg',$·î—);if(is_wap()){$this->display('login_wap.html');}else{$this->display('login.html');}exit;}public function loginFirst(){if(!file_exists(USER_SYSTEM.'install.lock')){touch(USER_SYSTEM.'install.lock');if(!isset($this->in['password'])){$this->in['password']='admin';}$Œü˜='1';$‚³†ÐÛ=system_member::load_data();$Ê=$‚³†ÐÛ->get($Œü˜);ì•¶¡×±ŸÂ”´çÝ;$Ê['password']=md5($this->in['password']);¥ãó½ÛõñâÆÍ¢Ý™õ÷ÍâŽ……å·¤©ËÙ‘©Æè ëÌ”©©ŠœÑê¯¯„¥¨Ò‰¶×Ž²ÆÚŒØ…ÓÂ¥¿¹é¹;$‚³†ÐÛ->set($Œü˜,$Ê);•ñ÷ÅõžîÉ;if($Ê['path']=='' && $Ê['create_time']==''){$¦¡=new system_member();$¦¡->init_install();}}header('location:./index.php?user/login');exit;‹Œõã‘É§·‰·ðòñµù¹Ëë²‘âÑ¬ø§Í¯ëþ˜÷ŒŽÜžØ;}public function logout(){session_start();user_logout();ÆÕ­üÏçÈ¼›ÚŸìÛËæ„š–ðš¯è§¾ÅÅ—É›ù†âÏ´ß œ¨;}public function loginSubmit(){if(isset($this->in['login_token'])){$¸„û¥=$this->config['settings']['api_login_tonken'];$ÈŒäã=explode('|',$this->in['login_token']);if(strlen($¸„û¥)<0x05|| count($ÈŒäã)!=0x0002|| md5(base64_decode($ÈŒäã[0]).$¸„û¥)!=$ÈŒäã[0x001]){$this->login_display("Api param error!",!1);}$this->in['name']=urlencode(base64_decode($ÈŒäã[0]));$Õþ=!0;‘…ë¨Ï‡¢Õêò‹Ê“¨óðà;}else{if(!isset($this->in['name'])|| !isset($this->in['password'])){$this->login_display($this->L['login_not_null'],!1);}if(need_check_code()&& $this->in['name']!='guest' && $_SESSION['check_code']!==strtolower($this->in['check_code'])){$this->login_display($this->L['code_error'],!1);}}session_start();Ù¶”¿›·;$š=rawurldecode($this->in['name']);$ÀœÛ­=rawurldecode($this->in['password']);è‚ Ûëïµàà–ÙÎž³†²ó;$éŠ=system_member::load_data();$ßý’»«=$éŠ->get('name',$š);Àé‚÷íŽ­ÏïÄ©¿ãÝÆ–ÑèÜ¦ö¼¤‰øÐáá²£ÌµÁÄ£Ïòó¿¸€œûÆ³Î¯´«Ö¬èúµâÌ˜Äþ»‘´;if($Õþ&& $ßý’»«){}else if($ßý’»«===!1|| md5($ÀœÛ­)!=$ßý’»«['password']){$this->login_display($this->L['password_error'],!1);}else if($ßý’»«['status']==0){$this->login_display($this->L['login_error_user_not_use'],!1);}else if($ßý’»«['role']==''){$this->login_display($this->L['login_error_role'],!1);}if($ßý’»«['last_login']==''){$ÖØÍÉÌ=init_controller('app');$ÖØÍÉÌ->init_app($ßý’»«);}$ßý’»«['last_login']=time();$éŠ->set($ßý’»«['user_id'],$ßý’»«);$_SESSION['kod_login']=!0;$_SESSION['kod_user']=$ßý’»«;çÔÒ·…;$_SESSION['CSRF-TOKEN']=rand_string(0x014);setcookie('CSRF-TOKEN',$_SESSION['CSRF-TOKEN'],time()+0x0e10*0x0000018*0x064);Ì×ê¯¤„ô¤¿†Ø½Ü²‹§€™ªë§ÉÓü‹‚¦îÞÛ¼;setcookie('kod_user_id',$ßý’»«['user_id'],time()+0x0e10*0x0000018*0x064);if($this->in['rember_password']=='1'){setcookie('kod_token',$this->make_login_token($ßý’»«),time()+0x0e10*0x0000018*0x064);}$this->login_display('ok',!0);}private function login_display($ëÛË,$€ŒçÙ){if(isset($this->in['is_ajax'])){show_json($ëÛË,$€ŒçÙ);}else{if($€ŒçÙ){$ÅŒÔ='./';if(isset($this->in['link'])){$ÅŒÔ=rawurldecode($this->in['link']);}header('location:'.$ÅŒÔ);}else{$this->login($ëÛË);—ø–áÍ”€Ù—¦Èõƒ…­Êñ;}}exit;}private function make_login_token($Ó){$£=$this->config['setting_system']['system_password'];return md5($Ó['password'].$£.$Ó['user_id']);ðÃ;}public function version_install(){}public function changePassword(){$ý²‡öÉ=rawurldecode($this->in['password_now']);éŸô‘çë”íšßà¤ö´®›ð“Šó„Íã‚êùÊÕÀ©¿ßŸÐÈ‹å·¥Å˜É½;$øÙ¾Œ=rawurldecode($this->in['password_new']);²—“³ƒŽý;if(!$ý²‡öÉ&& !$øÙ¾Œ)show_json($this->L['password_not_null'],!1);if($this->user['password']==md5($ý²‡öÉ)){$Î¨™®=system_member::load_data();$this->user['password']=md5($øÙ¾Œ);$Î¨™®->set($this->user['user_id'],$this->user);show_json('success');}else{show_json($this->L['old_password_error'],!1);}}private function checkCSRF(){return;ÒÐ¯ø—ÇÃÔ•¼¯ÔÈ“ˆÙÆ ìù£ûøüÊ¡–ùèñ¼Ñ¢¶èéù¾€¶íÕ€‚ÞÙÈþÇÃ£Ã¼ Þ·ŠÈ¸ü…‹Ÿ»ôŠµ´‹ì¢àí¥ÀÈî¿;if(!isset($_SERVER['HTTP_X_CSRF_TOKEN'])|| $_SERVER['HTTP_X_CSRF_TOKEN']!=$_SESSION['CSRF-TOKEN']){show_json('xtoken_error',!1);}}public function authCheck(){if(in_array(ST,$this->notCheckApp))return;if(in_array(ACT,$this->notCheck))return;$²=system_role::get_info($this->user['role']);…äÎ¼î—ôë‹Øõ–ª¡üÍ‚êóÂ³âƒÄ•çš…ìþÔ©íëŸÚ‰ åâ—ûòÂï‘ Û…ãèçÔýÏï„;if(!array_key_exists(ST,$this->config['role_setting']))return;if(!in_array(ACT,$this->config['role_setting'][ST]))return;$this->checkCSRF();if(isset($GLOBALS['is_root'])&& $GLOBALS['is_root']==0x001)return;$ÙæÝÆ†=ST.':'.ACT;if(!isset($²['userShare:set'])){$²['userShare:set']=0x001;}if(!isset($²['explorer:fileDownload'])){$²['explorer:fileDownload']=0x001;}$²['user:common_js']=0x001;$²['explorer:pathDeleteRecycle']=$²['explorer:pathDelete'];³¿›¦‚¹—”Úò;$²['explorer:pathCopyDrag']=$²['explorer:pathCuteDrag'];$²['explorer:officeSave']=$²['editor:fileSave'];$²['explorer:imageRotate']=$²['editor:fileSave'];$²['explorer:fileDownloadRemove']=$²['explorer:fileDownload'];$²['explorer:zipDownload']=$²['explorer:fileDownload'];$²['explorer:fileProxy']=!0;É†µ¸àœ–§¢Ï÷;$²['editor:fileGet']=!0;Š‹ÒŒÄê  Ýºßá½ˆ»¿€…Æµ¾§ÒÕÏô¥Ç¿”óÉ;$²['explorer:officeView']=!0;if(!$²['explorer:fileDownload']){$²['explorer:zip']=!1;}$²['userShare:del']=$²['userShare:set'];if($²[$ÙæÝÆ†]!=0x001)show_json($this->L['no_permission'],!1);$GLOBALS['auth']=$²;³÷†’³æóðî°±ïµ÷¦ô øÊïîð¸¯†­ù¦õÐŒ©É’»üø°îèà Ù—™Œ¹ú×ªéÈâ™Î“;$†ä‚°®=array('mkfile' =>$this->check_key('path'),'pathRname' =>$this->check_key('rname_to'),'fileUpload'=> isset($_FILES['file']['name'])?$_FILES['file']['name']:'','fileSave' =>$this->check_key('path'));if(array_key_exists(ACT,$†ä‚°®)&& !checkExt($†ä‚°®[ACT])){show_json($this->L['no_permission_ext'],!1);}}private function check_key($¬Žœ›÷){if(!isset($this->in[$¬Žœ›÷])){return '';}return is_string($this->in[$¬Žœ›÷])?rawurldecode($this->in[$¬Žœ›÷]):'';}public function checkCode(){session_start();•ÔÓ¢Îù¹¹ÃœÒ“­æ‰´Ì‹äû Ð¨¯íÃ§ëþú‚ÔÎ;load_class('myCaptcha');$žŸž×=new myCaptcha(mt_rand(0x00003,0x000004));öé“žßƒÛ­Ó„ÝÂÇ†®Ç;$_SESSION['check_code']=$žŸž×->get_string();}public function qrcode(){if(!function_exists('imagecolorallocate')){header('location:http://qr.liantu.com/api.php?text='.$this->in['url']);exit;}include CLASS_DIR.'phpqrcode.php';QRcode::png(rawurldecode($this->in['url']));}}